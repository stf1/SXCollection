#define SX_VERSION
SXCollection 0.1.5
#enddef

#define SX_ENEMY_WEAPON_BLANK
#enddef

#define SX_CMP VARIABLE1 OPERAND VARIABLE2
  [variable]
    name={VARIABLE1}
    {OPERAND}={VARIABLE2}
  [/variable]
#enddef

#define SX_ROUND VARIABLE1 OPERAND VARIABLE2 ROUND_TYPE
  [set_variable]
    name={VARIABLE1}
    {OPERAND}={VARIABLE2}
    round={ROUND_TYPE}
  [/set_variable]
#enddef

#define SX_INIT_VARIABLES
  {VARIABLE item[0].x 999}
  {VARIABLE item[0].y 999}
  {VARIABLE item[0].type "NOTHING"}
  {VARIABLE item[0].image ""}
  {VARIABLE item[0].halo ""}
  {VARIABLE item[0].used 0}
  {VARIABLE arcane 0.2285714285714286}
  {VARIABLE blade 0.1163636363636364}
  {VARIABLE cold 0.1454545454545455}
  {VARIABLE fire 0.1818181818181819}
  {VARIABLE impact 0.1254901960784314}
  {VARIABLE pierce 0.1230769230769231}
  {VARIABLE melee 5}
  {VARIABLE ranged 4}
  {VARIABLE weapons_index 100}
  {VARIABLE units_index 1000}
  {VARIABLE allow_shop_blackp "no"}
  {VARIABLE allow_shop_bluep "no"}
  {VARIABLE allow_shop_brownp "no"}
  {VARIABLE allow_shop_cyanp "no"}
  {VARIABLE allow_shop_greyp "no"}
  {VARIABLE allow_shop_greenp "no"}
  {VARIABLE allow_shop_orangep "no"}
  {VARIABLE allow_shop_pinkp "no"}
  {VARIABLE allow_shop_redp "no"}
  {VARIABLE allow_shop_violetp "no"}
  {VARIABLE allow_shop_whitep "no"}
  {VARIABLE allow_shop_yellowp "no"}
  {VARIABLE allow_leadership_items "yes"}
  {VARIABLE melee_specials "backstab,berserk,charge,evade,magical,rage,slow"}
  {VARIABLE ranged_specials "backstab,evade,focus,magical,marksman,precision,slow"}
# EVERY of next lines must contain , at start and end of line to get working comparation for full name of special otherwise partial specials names will match too, i.e. rage10 will match to rage, even if it's different special.
  {VARIABLE backstab_combinations ",attack_only,blind,charm,circle,concentrated,counter,drains,dread,evade,evasion,ferocious,firststrike,guided,highground,magical,marksman,massivestrike,nocounter,poison,precision,recieve,return,slow,spread,"}
  {VARIABLE berserk_combinations ",attack_only,blind,charm,firststrike,massivestrike,poison,recieve,spread,"}
  {VARIABLE charge_combinations ",attack_only,blind,charm,circle,concentrated,counter,dread,evade,evasion,ferocious,firststrike,guided,magical,marksman,massivestrike,poison,precision,recieve,return,slow,spread,"}
  {VARIABLE evade_combinations ",arson,attack_only,backstab,blind,charge,circle,cleave,concentrated,counter,defend_only,drains,ferocious,firststrike,focus,guided,highground,magical,marksman,massivestrike,poison,precision,rage,rage2,rage3,recieve,return,slow,spread,triplestrike,udbane,"}
  {VARIABLE focus_combinations ",attack_only,charm,dread,evade,evasion,firststrike,nocounter,poison,rage,rage2,rage3,recieve,slow,spread,triplestrike,"}
  {VARIABLE magical_combinations ",attack_only,backstab,charge,charm,cleave,dread,evade,evasion,firststrike,highground,nocounter,poison,rage,rage2,rage3,recieve,slow,spread,triplestrike,"}
  {VARIABLE marksman_combinations ",attack_only,backstab,charm,cleave,drains,dread,evade,evasion,firststrike,highground,nocounter,poison,rage,rage2,rage3,recieve,slow,spread,triplestrike,"}
  {VARIABLE precision_combinations ",attack_only,backstab,charm,cleave,dread,evade,evasion,firststrike,highground,nocounter,poison,rage,rage2,rage3,recieve,slow,spread,triplestrike,"}
  {VARIABLE rage_combinations ",attack_only,blind,charm,cleave,dread,evade,evasion,ferocious,firststrike,focus,guided,magical,marksman,massivestrike,poison,precision,recieve,slow,spread,"}
  {VARIABLE slow_combinations ",arson,attack_only,backstab,blind,charge,charm,circle,cleave,concentrated,counter,defend_only,drains,dread,evade,evasion,ferocious,firststrike,focus,guided,highground,magical,marksman,massivestrike,nocounter,poison,precision,rage,rage2,rage3,recieve,return,spread,triplestrike,udbane,"}
  {VARIABLE death_text_0 "Argh... I guess that was my last adventure..."}
  {VARIABLE death_text_1 "This cannot be..."}
  {VARIABLE death_text_2 "I'm... dying..."}
  {VARIABLE death_text_3 "Urgh. I should never have come here..."}
  {VARIABLE death_text_4 "Argh. I'm done for."}
  {VARIABLE death_text_5 "Sorry... friends... i can't..."}
  {VARIABLE death_text_6 "Why... me..."}
  {VARIABLE death_text_7 "This really... hurts..."}
  {VARIABLE death_text_8 "Where is my gold..."}
  {VARIABLE death_text_9 "I can't die... now..."}
#enddef

#                 bkstb bersk chrge evade focus magic marks precs rage3 slow
# absorb            0     0     0     0     0     0     0     0     0     0   This unit absorbs the body of living units. It is able to surpass its maximum health through draining when attacking
# arson             0     0     0     1     0     0     0     0     0     1   This unit uses the terrain against the enemy by lighting it on fire, its damage increases by 25% when the enemy is on forest, castle, or a village tile, or other manmade structure (farms and windmills) but decreases by 25% if he or the enemy is in water (if both are, the unit does 40% less damage). ::Note:: Villages or castles with water or swamp are considered water."
# attack_only       1     1     1     1     1     1     1     1     1     1   Weapon is only used on offense
# backstab          X     0     0     1     0     1     1     1     0     1   Doubles damage when used from back side of enemy unit
# berserk           0     X     0     0     0     0     0     0     0     0   30 rounds of attacks or death of one combater
# blind             1     1     1     1     0     0     0     0     1     1   This unit cannot see, and has a 20% chance to hit on offense.
# charge            0     0     X     1     0     1     1     1     0     1   Doubles damage for both attacker and defender
# charm             1     1     1     0     1     1     1     1     1     1   When this attack is used defencively, this unit takes one third less damage in retaliation.
# circle            1     0     1     1     0     0     0     0     0     1   This attack always has a 100% chance to hit
# cleave            0     0     0     1     0     1     1     1     1     1   This unit swings wide, and does 2 damage to any units adjacent to both attacker and defender.
# concentrated      1     0     1     1     0     0     0     0     0     1   Concentrated: When this attack is used, this units damage increases after each successful hit.
# counter           1     0     1     1     0     0     0     0     0     1   When used defensively, this attack always has at least a 60% chance to hit.
# defend_only       0     0     0     1     0     0     0     0     0     1   This attack is used only on defense.
# drains            1     0     0     1     0     0     1     0     0     1   Half of inflicted damage is drained back up to maximum health.
# dread             1     0     1     0     1     1     1     1     1     1   When this attack is used offensively, this unit takes one third less damage in retaliation.
# evade             1     0     1     X     1     1     1     1     1     1   Unit takes one third less damage in retaliation.
# evasion           1     0     1     0     1     1     1     1     1     1   When this attack is used offensively, this unit takes one third less damage in retaliation.
# ferocious         1     0     1     1     0     0     0     0     1     1   This unit battles with such vigor that it always has at least a 60% chance to hit.
# firststrike       1     1     1     1     1     1     1     1     1     1   Attacks always first even on defense.
# focus             0     0     0     1     X     0     0     0     1     1   1,5x damage and 70% chance to hit on attack.
# guided            1     0     1     1     0     0     0     0     1     1   This units weapon chases after the enemy, and has a 70% chance to hit units of lower level.
# highground        1     0     0     1     0     1     1     1     0     1   This units skill with a bow is improved when he is able to fire down upon the enemy from high up, damage is increased by +1 for hills and villages, and +2 for mountains and castles, but decreased if your terrain is lower.
# magical           1     0     1     1     0     X     0     0     1     1   This attack has always 70% chance to hit.
# marksman          1     0     1     1     0     0     X     0     1     1   This attack has always 60% chance to hit.
# massivestrike     1     1     1     1     0     0     0     0     1     1   This attack always has a 20% chance to hit.
# nocounter         1     0     0     0     1     1     1     1     0     1   The opponent has always a 0% chance to hit, when this unit is attacking.
# poison            1     1     1     1     1     1     1     1     1     1   Affected unit loses 8 HP at start of turn until it drops to 1 HP.
# precision         1     0     1     1     0     0     0     0     1     1   This attack has always 80% chance to hit.
# rage              0     0     0     1     1     1     1     1     X     1   3 rounds of attacks
# rage2             0     0     0     1     1     1     1     1     X     1   3 rounds of attacks
# rage3             0     0     0     1     1     1     1     1     X     1   3 rounds of attacks
# recieve           1     1     1     1     1     1     1     1     1     1   When this unit is adjacent to a unit with Supply ability, it increases its ranged strikes by one, this does not stack.
# return            1     0     1     1     0     0     0     0     0     1   When this attack is used, this units gets an extra strike after each successful hit. Also because it is a generally difficult weapon to use, it has 10% less chance to hit. If this attack misses on offense before the other unit finishes attacking, this unit will hide and not get attacked any further.
# slow              1     0     1     1     1     1     1     1     1     X   When this attack hits, it slows opponent to cause half damage.
# spread            1     1     1     1     1     1     1     1     1     1   This unit will automatically disease any enemy adjacent to it at the beggining of its turn.
# triplestrike      0     0     0     1     1     1     1     1     0     1   This unit has 3 heads, and when it strikes its extra heads do 2 damage to any enemy units adjacent to both the attacker and defender.
# udbane            0     0     0     1     0     0     0     0     0     1   This attack cuts at the tie between an abomination and its corrupted source of animation.  This attack deals additional damage to the targets: aberration = 150%, undead = 140%, vampire = 120%
#
# 0 not allowed
# 1 allowed
# X equal special

#define SX_ARMORY_LIMIT SIDE
  {VARIABLE melee_damage_{SIDE} 0}
  {VARIABLE ranged_damage_{SIDE} 0}
  {VARIABLE melee_strikes_{SIDE} 0}
  {VARIABLE ranged_strikes_{SIDE} 0}
  {VARIABLE movement_upgrades_{SIDE} 0}
  {VARIABLE black_potions_{SIDE} 0}
  {VARIABLE blue_potions_{SIDE} 0}
  {VARIABLE brown_potions_{SIDE} 0}
  {VARIABLE cyan_potions_{SIDE} 0}
  {VARIABLE grey_potions_{SIDE} 0}
  {VARIABLE green_potions_{SIDE} 0}
  {VARIABLE orange_potions_{SIDE} 0}
  {VARIABLE pink_potions_{SIDE} 0}
  {VARIABLE red_potions_{SIDE} 0}
  {VARIABLE violet_potions_{SIDE} 0}
  {VARIABLE white_potions_{SIDE} 0}
  {VARIABLE yellow_potions_{SIDE} 0}
  {VARIABLE potions_total_{SIDE} 0}
  {VARIABLE extra_armor_bought_{SIDE} 0}
  {VARIABLE hide_ranged_{SIDE} no}
  {VARIABLE hide_melee_{SIDE} no}
  {VARIABLE terrains_left_{SIDE} 4}
  {VARIABLE mc_castle_{SIDE} 0}
  {VARIABLE mc_cave_{SIDE} 0}
  {VARIABLE mc_deep_water_{SIDE} 0}
  {VARIABLE mc_flat_{SIDE} 0}
  {VARIABLE mc_forest_{SIDE} 0}
  {VARIABLE mc_frozen_{SIDE} 0}
  {VARIABLE mc_fungus_{SIDE} 0}
  {VARIABLE mc_hills_{SIDE} 0}
  {VARIABLE mc_impassable_{SIDE} 0}
  {VARIABLE mc_mountains_{SIDE} 0}
  {VARIABLE mc_reef_{SIDE} 0}
  {VARIABLE mc_sand_{SIDE} 0}
  {VARIABLE mc_shallow_water_{SIDE} 0}
  {VARIABLE mc_swamp_water_{SIDE} 0}
  {VARIABLE mc_unwalkable_{SIDE} 0}
  {VARIABLE mc_village_{SIDE} 0}
  {VARIABLE speedy_{SIDE} 0}
  {VARIABLE mp_kill_{SIDE} 4}
  {VARIABLE defring_{SIDE} 0}
  {VARIABLE resring_{SIDE} 0}
  {VARIABLE income_{SIDE} 0}

  [event]
    name=start
    {SX_CHECK_ARMOR_TOTAL {SIDE}}
    [store_unit]
      [filter]
        side={SIDE}
        canrecruit=yes
        x,y=$x1,$y1
      [/filter]
      variable=leader_recruit
    [/store_unit]
    [disallow_recruit]
      side={SIDE}
      type=$leader_recruit.recruit
    [/disallow_recruit]
    {CLEAR_VARIABLE leader_recruit}
    {SX_CHECK_OLD_ABILITIES {SIDE}}
  [/event]

  [event]
    name=advance
    first_time_only=no
    [filter]
      side={SIDE}
      canrecruit=yes
      x,y=$x1,$y1
    [/filter]
    [store_unit]
      [filter]
        side={SIDE}
        canrecruit=yes
        x,y=$x1,$y1
      [/filter]
      variable=preadvance
    [/store_unit]
    {VARIABLE pre_advance $preadvance.hitpoints}
    {VARIABLE pre_id $preadvance.type}
    {CLEAR_VARIABLE preadvance}
  [/event]

  [event]
    name=post_advance
    first_time_only=no
    [filter]
      side={SIDE}
      canrecruit=yes
      x,y=$x1,$y1
    [/filter]
    [store_unit]
      [filter]
        x,y=$x1,$y1
        side={SIDE}
        canrecruit=yes
      [/filter]
      variable=postadvance
    [/store_unit]
    [object]
      silent=yes
      duration=forever
      [effect]
        apply_to=hitpoints
        heal_full=yes
        violate_maximum=yes
      [/effect]
      {SX_TRAIT_EFFECTS}
    [/object]
    [if]
      {SX_CMP pre_advance greater_than $postadvance.hitpoints}
      [then]
        {VARIABLE_OP pre_advance add (-$postadvance.hitpoints)}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=hitpoints
            increase=$pre_advance
            violate_maximum=yes
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP pre_id not_equals $postadvance.type}
      [then]
        {SX_CHECK_ARMOR_TOTAL {SIDE}}
        {SX_UNIT_MOVEMENTS_RESTORE {SIDE}}
      [/then]
    [/if]
    {CLEAR_VARIABLE pre_advance}
    {CLEAR_VARIABLE pre_id}
    {CLEAR_VARIABLE postadvance}
    {SX_CHECK_OLD_ABILITIES {SIDE}}
  [/event]
#enddef

#define SX_CHECK_OLD_ABILITIES SIDE
  [store_unit]
    [filter]
      side={SIDE}
      canrecruit=yes
      x,y=$x1,$y1
    [/filter]
    variable=leader_abilities
  [/store_unit]
  {VARIABLE sf ""}
  {VARIABLE an $leader_abilities.abilities.length}
  {VARIABLE ac 0}
  [while]
    {SX_CMP ac less_than $an}
    [do]
      {VARIABLE rn $leader_abilities.abilities[$ac|].resistance.length}
      {VARIABLE rc 0}
      [while]
        {SX_CMP rc less_than $rn}
        [do]
          [if]
            {SX_CMP leader_abilities.abilities[$ac|].resistance[$rc|].id equals "steadfast"}
            [then]
              {VARIABLE sf "steadfast"}
            [/then]
          [/if]
          {VARIABLE_OP rc add 1}
        [/do]
      [/while]
      {CLEAR_VARIABLE rc}
      {CLEAR_VARIABLE rn}
      {VARIABLE_OP ac add 1}
    [/do]
  [/while]
  {CLEAR_VARIABLE ac}
  {CLEAR_VARIABLE an}
  {CLEAR_VARIABLE leader_abilities}
  [if]
    {SX_CMP sf equals "steadfast"}
    [then]
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=remove_ability
          [abilities]
            [resistance]
              id=steadfast
            [/resistance]
          [/abilities]
        [/effect]
        [effect]
          apply_to=new_ability
          [abilities]
            [resistance]
              id=sxc_steadfast
              multiply=2
              max_value=150
              apply_to=arcane,blade,cold,fire,impact,pierce
              [filter_base_value]
                greater_than=0
                less_than_equal_to=25
              [/filter_base_value]
              name= _ "steadfast"
              name_inactive= _ "steadfast"
              female_name= _ "female^steadfast"
              female_name_inactive= _ "female^steadfast"
              description_inactive= _ "Steadfast:
This unit's resistances are doubled, up to a maximum of 50%, when defending. Vulnerabilities are not affected."
              description= _ "Steadfast:
This unit's resistances are doubled, up to a maximum of 50%, when defending. Vulnerabilities are not affected."
              affect_self=yes
              active_on=defense
            [/resistance]
            [resistance]
              id=sxc_steadfast
              value=50
              max_value=150
              apply_to=arcane,blade,cold,fire,impact,pierce
              [filter_base_value]
                greater_than=25
                less_than_equal_to=50
              [/filter_base_value]
              affect_self=yes
              active_on=defense
            [/resistance]
          [/abilities]
        [/effect]
      [/object]
    [/then]
  [/if]
  {CLEAR_VARIABLE sf}
#enddef

#define SX_MUSIC_PLAYLIST
  {SX_MUSIC underground.ogg}
  {SX_ADD_MUSIC knolls.ogg}
  {SX_ADD_MUSIC northerners.ogg}
  {SX_ADD_MUSIC elf-land.ogg}
  {SX_ADD_MUSIC legends_of_the_north.ogg}
  {SX_ADD_MUSIC wanderer.ogg}
  {SX_ADD_MUSIC loyalists.ogg}
  {SX_ADD_MUSIC revelation.ogg}

  [event]
    name=prestart
    {SX_MUSIC underground.ogg}
    {SX_ADD_MUSIC northerners.ogg}
    {SX_ADD_MUSIC knolls.ogg}
    {SX_ADD_MUSIC elf-land.ogg}
    {SX_ADD_MUSIC legends_of_the_north.ogg}
    {SX_ADD_MUSIC wanderer.ogg}
    {SX_ADD_MUSIC loyalists.ogg}
    {SX_ADD_MUSIC revelation.ogg}
  [/event]
#enddef

#define SX_MUSIC FILE
  [music]
    name={FILE}
    ms_before=12000
    append=no
  [/music]
#enddef

#define SX_ADD_MUSIC FILE
  [music]
    name={FILE}
    ms_before=12000
    append=yes
  [/music]
#enddef

#define SX_PLAYER_SIDE SIDE GOLD
  [side]
    side={SIDE}
    team_name=1
    canrecruit=yes
    controller=human
    income=-2
    village_gold=0
    fog=yes
    shroud=yes
    gold={GOLD}
    income_lock=true
    team_lock=true
    [ai]
      passive_leader=no
      ai_algorithm=default
      village_value=-34.8
      aggression=0.0
      caution=1.0
    [/ai]
    [modifications]
      [trait]
        id=sx
        name="sx"
        female_name="sx"
        description=_ "Removes all forbidden abilities and attack specials
"
        [effect]
          apply_to=movement
          increase=1
        [/effect]
        {SX_TRAIT_EFFECTS}
      [/trait]
    [/modifications]
  [/side]
#enddef

#define SX_TRAIT_EFFECTS
  [effect]
    apply_to=attack
    remove_specials=stones,plague,plague(EOM_Bloodborn),plague(bliinfec),plague(bliseed),plague(blipara),plague(ifimp),plague(hivgnat),plague(Slavsav),plague(Slave),swarm,suicide,spores,latch,curse,BM New Zombie,BM Young Vampire,BM_cursed,plague(BM Bloodborn),CE_cursed,BM soulbind
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon5_1rand
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=undead_summon6_1
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=undead_summon6_2
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon7_0
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon7_1
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon7_2
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon7_3
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=undead_summon7_1
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=undead_summon7_2
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon_lvl3
      [/dummy]
    [/abilities]
  [/effect]
  [effect]
    apply_to=remove_ability
    [abilities]
      [dummy]
        id=summon_lvl4
      [/dummy]
    [/abilities]
  [/effect]
#enddef

#define SX_TEST_PLAYER_SIDE SIDE GOLD
  [side]
    side={SIDE}
    team_name=1
    canrecruit=yes
    controller=human
    income=-2
    village_gold=0
    fog=no
    shroud=no
    gold={GOLD}
    income_lock=true
    team_lock=true
    [ai]
      passive_leader=no
      ai_algorithm=default
      village_value=-34.8
      aggression=0.0
      caution=1.0
    [/ai]
    [modifications]
      [trait]
        id=sx
        name="sx"
        female_name="sx"
        description=_ "Removes all forbidden abilities and attack specials
"
        [effect]
          apply_to=attack
          remove_specials=stones,plague,plague(EOM_Bloodborn),plague(bliinfec),plague(bliseed),plague(blipara),plague(ifimp),plague(hivgnat),plague(Slavsav),plague(Slave),swarm,suicide,spores,latch,curse
        [/effect]
      [/trait]
    [/modifications]
  [/side]
#enddef

#define SX_ENEMY_MODIFICATION MP HP MA MD RA RD RES
  role=boss
  [modifications]
    {TRAIT_FEARLESS}
    {TRAIT_LOYAL}
    [object]
      silent=yes
      duration=forever
      [effect]
        apply_to=movement
        increase={MP}
      [/effect]
      [effect]
        apply_to=hitpoints
        increase={HP}
        increase_total={HP}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_attacks={MA}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_damage={MD}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_attacks={RA}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_damage={RD}
      [/effect]
      [effect]
        apply_to=resistance
        replace=no
        [resistance]
          blade=-{RES}
          pierce=-{RES}
          impact=-{RES}
          fire=-{RES}
          cold=-{RES}
          arcane=-{RES}
        [/resistance]
      [/effect]
      [effect]
        apply_to=movement_costs
        replace=yes
        [movement_costs]
          castle=100
          cave=100
          deep_water=100
          flat=100
          forest=100
          frozen=100
          fungus=100
          hills=100
          impassable=100
          mountains=100
          reef=100
          sand=100
          shallow_water=100
          swamp_water=100
          unwalkable=100
          village=100
        [/movement_costs]
      [/effect]
    [/object]
  [/modifications]
#enddef

#define SX_ENEMY_MODIFICATION_2 MP HP MA MD RA RD RES W1 W2 W3 W4
  role=boss
  [modifications]
    {TRAIT_FEARLESS}
    {TRAIT_LOYAL}
    [object]
      silent=yes
      duration=forever
      {SX_ENEMY_WEAPON_{W1}}
      {SX_ENEMY_WEAPON_{W2}}
      {SX_ENEMY_WEAPON_{W3}}
      {SX_ENEMY_WEAPON_{W4}}
      [effect]
        apply_to=movement
        increase={MP}
      [/effect]
      [effect]
        apply_to=hitpoints
        increase={HP}
        increase_total={HP}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_attacks={MA}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_damage={MD}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_attacks={RA}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_damage={RD}
      [/effect]
      [effect]
        apply_to=resistance
        replace=no
        [resistance]
          blade=-{RES}
          pierce=-{RES}
          impact=-{RES}
          fire=-{RES}
          cold=-{RES}
          arcane=-{RES}
        [/resistance]
      [/effect]
      [effect]
        apply_to=movement_costs
        replace=yes
        [movement_costs]
          castle=100
          cave=100
          deep_water=100
          flat=100
          forest=100
          frozen=100
          fungus=100
          hills=100
          impassable=100
          mountains=100
          reef=100
          sand=100
          shallow_water=100
          swamp_water=100
          unwalkable=100
          village=100
        [/movement_costs]
      [/effect]
    [/object]
  [/modifications]
#enddef

#define SX_ENEMY_SPECIALS X Y INDEX SPECIAL
  [store_unit]
    [filter]
      x,y={X},{Y}
    [/filter]
    variable=enemyspecs
  [/store_unit]
  [object]
    silent=yes
    duration=forever
    [filter]
      x,y={X},{Y}
    [/filter]
    [effect]
      apply_to=attack
      range=$enemyspecs.attack[{INDEX}].range
      type=$enemyspecs.attack[{INDEX}].type
      name=$enemyspecs.attack[{INDEX}].name
      [set_specials]
        mode=append
        {WEAPON_SPECIAL_{SPECIAL}}
      [/set_specials]
    [/effect]
  [/object]
  {CLEAR_VARIABLE enemyspecs}
#enddef

#define SX_ENEMY_WEAPON_MA
  {SX_ENEMY_WEAPON_ARCANE 5 2}
#enddef

#define SX_ENEMY_WEAPON_MB
  {SX_ENEMY_WEAPON_BLADE 5 2}
#enddef

#define SX_ENEMY_WEAPON_MC
  {SX_ENEMY_WEAPON_COLD 5 2}
#enddef

#define SX_ENEMY_WEAPON_MF
  {SX_ENEMY_WEAPON_MELEE_FIRE 5 2}
#enddef

#define SX_ENEMY_WEAPON_MI
  {SX_ENEMY_WEAPON_IMPACT 5 2}
#enddef

#define SX_ENEMY_WEAPON_MP
  {SX_ENEMY_WEAPON_PIERCE 5 2}
#enddef

#define SX_ENEMY_WEAPON_RA
  {SX_ENEMY_WEAPON_ARCANE_MISSILE 8 3}
#enddef

#define SX_ENEMY_WEAPON_RB
  {SX_ENEMY_WEAPON_BLADE_MISSILE 8 3}
#enddef

#define SX_ENEMY_WEAPON_RC
  {SX_ENEMY_WEAPON_COLD_MISSILE 8 3}
#enddef

#define SX_ENEMY_WEAPON_RF
  {SX_ENEMY_WEAPON_FIRE 8 3}
#enddef

#define SX_ENEMY_WEAPON_RI
  {SX_ENEMY_WEAPON_IMPACT_MISSILE 8 3}
#enddef

#define SX_ENEMY_WEAPON_RP
  {SX_ENEMY_WEAPON_PIERCE_MISSILE 8 3}
#enddef

#define SX_ENEMY_MODIFICATION_ARCANE MP HP MA MD RA RD RES
  role=boss
  [modifications]
    {TRAIT_FEARLESS}
    {TRAIT_LOYAL}
    [object]
      silent=yes
      duration=forever
      {SX_ENEMY_WEAPON_ARCANE 5 2}
      {SX_ENEMY_WEAPON_ARCANE_MISSILE 8 3}
      [effect]
        apply_to=movement
        increase={MP}
      [/effect]
      [effect]
        apply_to=hitpoints
        increase={HP}
        increase_total={HP}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_attacks={MA}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_damage={MD}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_attacks={RA}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_damage={RD}
      [/effect]
      [effect]
        apply_to=resistance
        replace=no
        [resistance]
          blade=-{RES}
          pierce=-{RES}
          impact=-{RES}
          fire=-{RES}
          cold=-{RES}
          arcane=-{RES}
        [/resistance]
      [/effect]
      [effect]
        apply_to=movement_costs
        replace=yes
        [movement_costs]
          castle=100
          cave=100
          deep_water=100
          flat=100
          forest=100
          frozen=100
          fungus=100
          hills=100
          impassable=100
          mountains=100
          reef=100
          sand=100
          shallow_water=100
          swamp_water=100
          unwalkable=100
          village=100
        [/movement_costs]
      [/effect]
    [/object]
  [/modifications]
#enddef

#define SX_ENEMY_MODIFICATION_MAS_RFS MP HP MA MD RA RD RES
  role=boss
  [modifications]
    {TRAIT_FEARLESS}
    {TRAIT_LOYAL}
    [object]
      silent=yes
      duration=forever
      {SX_ENEMY_WEAPON_ARCANE_SLOW 5 2}
      {SX_ENEMY_WEAPON_FIRE_SLOW 8 3}
      [effect]
        apply_to=movement
        increase={MP}
      [/effect]
      [effect]
        apply_to=hitpoints
        increase={HP}
        increase_total={HP}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_attacks={MA}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_damage={MD}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_attacks={RA}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_damage={RD}
      [/effect]
      [effect]
        apply_to=resistance
        replace=no
        [resistance]
          blade=-{RES}
          pierce=-{RES}
          impact=-{RES}
          fire=-{RES}
          cold=-{RES}
          arcane=-{RES}
        [/resistance]
      [/effect]
      [effect]
        apply_to=movement_costs
        replace=yes
        [movement_costs]
          castle=100
          cave=100
          deep_water=100
          flat=100
          forest=100
          frozen=100
          fungus=100
          hills=100
          impassable=100
          mountains=100
          reef=100
          sand=100
          shallow_water=100
          swamp_water=100
          unwalkable=100
          village=100
        [/movement_costs]
      [/effect]
    [/object]
  [/modifications]
#enddef

#define SX_ENEMY_MODIFICATION_ARCANE_MELEE MP HP MA MD RA RD RES
  role=boss
  [modifications]
    {TRAIT_FEARLESS}
    {TRAIT_LOYAL}
    [object]
      {SX_ENEMY_WEAPON_ARCANE 8 3}
      duration=forever
      silent=yes
      [effect]
        apply_to=movement
        increase={MP}
      [/effect]
      [effect]
        apply_to=hitpoints
        increase={HP}
        increase_total={HP}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_attacks={MA}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_damage={MD}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_attacks={RA}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_damage={RD}
      [/effect]
      [effect]
        apply_to=resistance
        replace=no
        [resistance]
          blade=-{RES}
          pierce=-{RES}
          impact=-{RES}
          fire=-{RES}
          cold=-{RES}
          arcane=-{RES}
        [/resistance]
      [/effect]
      [effect]
        apply_to=movement_costs
        replace=yes
        [movement_costs]
          castle=100
          cave=100
          deep_water=100
          flat=100
          forest=100
          frozen=100
          fungus=100
          hills=100
          impassable=100
          mountains=100
          reef=100
          sand=100
          shallow_water=100
          swamp_water=100
          unwalkable=100
          village=100
        [/movement_costs]
      [/effect]
    [/object]
  [/modifications]
#enddef

#define SX_ENEMY_MODIFICATION_MAS MP HP MA MD RA RD RES
  role=boss
  [modifications]
    {TRAIT_FEARLESS}
    {TRAIT_LOYAL}
    [object]
      {SX_ENEMY_WEAPON_ARCANE_SLOW 8 3}
      silent=yes
      duration=forever
      [effect]
        apply_to=movement
        increase={MP}
      [/effect]
      [effect]
        apply_to=hitpoints
        increase={HP}
        increase_total={HP}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_attacks={MA}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_damage={MD}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_attacks={RA}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_damage={RD}
      [/effect]
      [effect]
        apply_to=resistance
        replace=no
        [resistance]
          blade=-{RES}
          pierce=-{RES}
          impact=-{RES}
          fire=-{RES}
          cold=-{RES}
          arcane=-{RES}
        [/resistance]
      [/effect]
      [effect]
        apply_to=movement_costs
        replace=yes
        [movement_costs]
          castle=100
          cave=100
          deep_water=100
          flat=100
          forest=100
          frozen=100
          fungus=100
          hills=100
          impassable=100
          mountains=100
          reef=100
          sand=100
          shallow_water=100
          swamp_water=100
          unwalkable=100
          village=100
        [/movement_costs]
      [/effect]
    [/object]
  [/modifications]
#enddef

#define SX_ENEMY_MODIFICATION_MFE MP HP MA MD RA RD RES
  role=boss
  [modifications]
    {TRAIT_FEARLESS}
    {TRAIT_LOYAL}
    [object]
      {SX_ENEMY_WEAPON_FIRE_EVADE 8 3}
      silent=yes
      duration=forever
      [effect]
        apply_to=movement
        increase={MP}
      [/effect]
      [effect]
        apply_to=hitpoints
        increase={HP}
        increase_total={HP}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_attacks={MA}
      [/effect]
      [effect]
        apply_to=attack
        range=melee
        increase_damage={MD}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_attacks={RA}
      [/effect]
      [effect]
        apply_to=attack
        range=ranged
        increase_damage={RD}
      [/effect]
      [effect]
        apply_to=resistance
        replace=no
        [resistance]
          blade=-{RES}
          pierce=-{RES}
          impact=-{RES}
          fire=-{RES}
          cold=-{RES}
          arcane=-{RES}
        [/resistance]
      [/effect]
      [effect]
        apply_to=movement_costs
        replace=yes
        [movement_costs]
          castle=100
          cave=100
          deep_water=100
          flat=100
          forest=100
          frozen=100
          fungus=100
          hills=100
          impassable=100
          mountains=100
          reef=100
          sand=100
          shallow_water=100
          swamp_water=100
          unwalkable=100
          village=100
        [/movement_costs]
      [/effect]
    [/object]
  [/modifications]
#enddef

#define SX_CHECK_ARMOR_TOTAL SIDE
  [store_unit]
    [filter]
      side={SIDE}
      canrecruit=yes
      x,y=$x1,$y1
    [/filter]
    variable=leader_armor
  [/store_unit]
  {VARIABLE advanceto ",$leader_armor.advances_to|,"}
  {VARIABLE id ",$leader_armor.type|,"}
  [if]
    {SX_CMP maximum_level_reached_{SIDE} not_equals "yes"}
    [then]
      {VARIABLE best_armor 70}
      {VARIABLE second_best_armor 70}
      [if]
        {SX_CMP best_armor greater_than $leader_armor.resistance.arcane}
        [then]
          {VARIABLE second_best_armor $best_armor}
          {VARIABLE best_armor $leader_armor.resistance.arcane}
        [/then]
      [/if]
      [if]
        {SX_CMP best_armor greater_than $leader_armor.resistance.blade}
        [then]
          {VARIABLE second_best_armor $best_armor}
          {VARIABLE best_armor $leader_armor.resistance.blade}
        [/then]
      [/if]
      [if]
        {SX_CMP best_armor greater_than $leader_armor.resistance.cold}
        [then]
          {VARIABLE second_best_armor $best_armor}
          {VARIABLE best_armor $leader_armor.resistance.cold}
        [/then]
      [/if]
      [if]
        {SX_CMP best_armor greater_than $leader_armor.resistance.fire}
        [then]
          {VARIABLE second_best_armor $best_armor}
          {VARIABLE best_armor $leader_armor.resistance.fire}
        [/then]
      [/if]
      [if]
        {SX_CMP best_armor greater_than $leader_armor.resistance.impact}
        [then]
          {VARIABLE second_best_armor $best_armor}
          {VARIABLE best_armor $leader_armor.resistance.impact}
        [/then]
      [/if]
      [if]
        {SX_CMP best_armor greater_than $leader_armor.resistance.pierce}
        [then]
          {VARIABLE second_best_armor $best_armor}
          {VARIABLE best_armor $leader_armor.resistance.pierce}
        [/then]
      [/if]
      {VARIABLE armor_index -10}
      {VARIABLE_OP armor_index add $best_armor}
      {VARIABLE_OP armor_index add $second_best_armor}
      [if]
        {SX_CMP leader_armor.level less_than_equal_to 1}
        [then]
          {VARIABLE armor_limit_{SIDE} -30}
          [if]
            {SX_CMP armor_index less_than 0}
            [then]
              {VARIABLE armor_total_{SIDE} 0}
            [/then]
            [else]
              {VARIABLE armor_total_{SIDE} $armor_index}
            [/else]
          [/if]
          [if]
            {SX_CMP armor_index greater_than 20}
            [then]
              {VARIABLE armor_total_{SIDE} 20}
            [/then]
          [/if]
        [/then]
      [/if]
      [if]
        {SX_CMP leader_armor.level numerical_equals 2}
        [then]
          {VARIABLE armor_limit_{SIDE} 0}
          [if]
            {SX_CMP armor_index greater_than $armor_total_{SIDE}}
            [then]
              {VARIABLE armor_total_{SIDE} $armor_index}
            [/then]
          [/if]
          [if]
            {SX_CMP armor_index greater_than 20}
            [then]
              {VARIABLE armor_total_{SIDE} 40}
            [/then]
          [/if]
        [/then]
      [/if]
      [if]
        {SX_CMP leader_armor.level greater_than_equal_to 3}
        [then]
          {VARIABLE armor_limit_{SIDE} 30}
          [if]
            {SX_CMP armor_index greater_than $armor_total_{SIDE}}
            [then]
              {VARIABLE armor_total_{SIDE} $armor_index}
            [/then]
          [/if]
          [if]
            {SX_CMP armor_index greater_than 60}
            [then]
              {VARIABLE armor_total_{SIDE} 60}
            [/then]
          [/if]
        [/then]
      [/if]
      [if]
        {SX_CMP leader_armor.advances_to equals $null}
        [or]
          {SX_CMP advanceto contains $id}
        [/or]
        [then]
          {VARIABLE armor_limit_{SIDE} 30}
          [if]
            {SX_CMP armor_index greater_than $armor_total_{SIDE}}
            [then]
              {VARIABLE armor_total_{SIDE} $armor_index}
            [/then]
          [/if]
          {VARIABLE maximum_level_reached_{SIDE} "yes"}
          {VARIABLE leader_armor.advances_to $null}
        [/then]
        [else]
          {VARIABLE maximum_level_reached_{SIDE} "no"}
        [/else]
      [/if]
    [/then]
  [/if]
  [if]
    {SX_CMP leader_armor.defense.reef equals $null}
    [then]
      {VARIABLE leader_armor.defense.reef 50}
    [/then]
  [/if]
  [if]
    {SX_CMP leader_armor.defense.unwalkable equals $null}
    [then]
      {VARIABLE leader_armor.defense.unwalkable 50}
    [/then]
  [/if]
  [unstore_unit]
    variable=leader_armor
  [/unstore_unit]
  {CLEAR_VARIABLE best_armor}
  {CLEAR_VARIABLE second_best_armor}
  {CLEAR_VARIABLE armor_index}
  {CLEAR_VARIABLE id}
  {CLEAR_VARIABLE advanceto}
  {CLEAR_VARIABLE leader_armor}
#enddef

#define SX_UNIT_MOVEMENTS_RESTORE SIDE
  [store_unit]
    [filter]
      side={SIDE}
      canrecruit=yes
    [/filter]
    variable=unit_mc
  [/store_unit]
  [if]
    {SX_CMP unit_mc.flying equals "yes"}
    [then]
      {SX_TERRAIN_CHECK_MOVEMENT "deep_water" 1 {SIDE}}
      {SX_TERRAIN_CHECK_MOVEMENT "unwalkable" 1 {SIDE}}
    [/then]
    [else]
      {SX_TERRAIN_CHECK_MOVEMENT "deep_water" 3 {SIDE}}
      {SX_TERRAIN_CHECK_MOVEMENT "unwalkable" 3 {SIDE}}
    [/else]
  [/if]
  {SX_TERRAIN_CHECK_MOVEMENT "castle" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "cave" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "flat" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "forest" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "frozen" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "fungus" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "hills" 1 {SIDE}}
#   {SX_TERRAIN_CHECK_MOVEMENT "impassable"}
  {SX_TERRAIN_CHECK_MOVEMENT "mountains" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "reef" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "sand" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "shallow_water" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "swamp_water" 1 {SIDE}}
  {SX_TERRAIN_CHECK_MOVEMENT "village" 1 {SIDE}}
  [unstore_unit]
    variable=unit_mc
  [/unstore_unit]
  {CLEAR_VARIABLE unit_mc}
#enddef

#define SX_TERRAIN_CHECK_MOVEMENT MCVAR COST SIDE
  [if]
    {SX_CMP mc_{MCVAR}_{SIDE} numerical_equals 1}
    [then]
      {VARIABLE unit_mc.movement_costs.{MCVAR} {COST}}
    [/then]
  [/if]
#enddef

#define SX_NO_GOLD_FOR_NOBODY
  {VARIABLE i 1}
  [while]
    {SX_CMP i less_than_equal_to 5}
    [do]
      [store_gold]
        side=$i
        variable=gold_trans
      [/store_gold]
      [if]
        [not]
          [have_unit]
            side=$i
            canrecruit=yes
          [/have_unit]
        [/not]
        [then]
          [gold]
            amount=-$gold_trans
            side=$i
          [/gold]
        [/then]
      [/if]
      {VARIABLE_OP i add 1}
    [/do]
  [/while]
  {CLEAR_VARIABLE i}
  {CLEAR_VARIABLE gold_trans}
#enddef

#define SX_BEFORE_SHOPS
  {VARIABLE shopxs 999}
  {VARIABLE shopys 999}
#enddef

#define SX_PLACE_ITEM X Y IMAGE HALO
  {VARIABLE halo {HALO}}
  [if]
    {SX_CMP halo not_equals ""}
    [then]
      [item]
        x,y={X},{Y}
        image={IMAGE}
        halo={HALO}
      [/item]
    [/then]
    [else]
      [item]
        x,y={X},{Y}
        image={IMAGE}
      [/item]
    [/else]
  [/if]
#enddef

#define SX_REDRAW_ITEMS X Y
  [removeitem]
    x,y={X},{Y}
  [/removeitem]
  {FOREACH item i}
    [if]
      {SX_CMP item[$i|].x equals {X}}
      {SX_CMP item[$i|].y equals {Y}}
      {SX_CMP item[$i|].used equals 0}
      [then]
        {SX_PLACE_ITEM {X} {Y} $item[$i|].image $item[$i|].halo}
      [/then]
    [/if]
  {NEXT i}
#enddef

#define SX_ITEM X Y ITEM IMAGE HALO
  {VARIABLE n $item.length}
  {VARIABLE item[$n].x {X}}
  {VARIABLE item[$n].y {Y}}
  {VARIABLE item[$n].type {ITEM}}
  {VARIABLE item[$n].image {IMAGE}}
  {VARIABLE item[$n].halo {HALO}}
  {VARIABLE item[$n].used 0}
  {SX_PLACE_ITEM {X} {Y} {IMAGE} {HALO}}
  {CLEAR_VARIABLE n}
#enddef

#define SX_SHOP X Y
  {SX_ITEM {X} {Y} "SHOP" "scenery/signpost.png" ""}
  {VARIABLE shopxs $shopxs|,{X}}
  {VARIABLE shopys $shopys|,{Y}}

  [event]
    name=side turn
    first_time_only=no
    [label]
      x={X}
      y={Y}
      text=_ "{X},{Y}"
    [/label]
    [label]
      x={X}
      y={Y}
      text= _ "Shop"
    [/label]
  [/event]
#enddef

#define SX_SHOP_EVENT
  [event]
    name=moveto
    first_time_only=no
    [filter]
      side=1,2,3,4,5
      x=$shopxs
      y=$shopys
      canrecruit=yes
    [/filter]
    [store_gold]
      side=$side_number
      variable=gold
    [/store_gold]
    [if]
      {SX_CMP shopped_$side_number numerical_not_equals 1}
      [then]
        [message]
          speaker=narrator
          message= _ "~**<255,0,0>To access shop menu, please right-click
~**<255,0,0>on your unit standing at shop and then
~**<255,0,0>click 'Enter shop' line in menu."
          [option]
            message= _ "I wish to see this message again next time I'll step on shop"
            [command]
            [/command]
          [/option]
          [option]
            message= _ "Ok. I don't wan't to see this message again"
            [command]
              {VARIABLE shopped_$side_number 1}
            [/command]
          [/option]
        [/message]
      [/then]
    [/if]
    [if]
      {SX_CMP gold greater_than_equal_to 500}
      [then]
        {VARIABLE warning "
Shopping can take some time..."}
      [/then]
      [else]
        {VARIABLE warning ""}
      [/else]
    [/if]
    [print]
      text= _ "Player $side_number stands at shop with $gold gold.$warning"
      size=18
      duration=500
      red,green,blue=255,176,0
    [/print]
    {CLEAR_VARIABLE warning}
    {CLEAR_VARIABLE gold}
    [redraw]
    [/redraw]
  [/event]

  {SX_SHOP_MENU}
  {SX_INVENTORY}
  {SX_ITEM_EVENT}
  {SX_ABILITY_EVENTS}
  {SX_CLEAR_LABEL}
#enddef

#define SX_CLEAR_LABEL
  [set_menu_item]
    id=SXC_Label
    description=_ "Clear label here"
    [show_if]
      [have_unit]
        side=$side_number
        canrecruit=yes
      [/have_unit]
    [/show_if]
    [command]
      [label]
        x=$x1
        y=$y1
        text=""
      [/label]
    [/command]
  [/set_menu_item]
#enddef

#define SX_SHOP_MENU
  [set_menu_item]
    id=SXC_Shop
    description="Enter Shop"
    image=icons/signpost_icon.png
    [show_if]
      [have_unit]
        side=$side_number
        x,y=$shopxs,$shopys
        canrecruit=yes
      [/have_unit]
      [have_unit]
        side=$side_number
        x,y=$x1,$y1
        canrecruit=yes
      [/have_unit]
    [/show_if]
    [command]
      [sound]
        name=shop_door_bell.ogg
      [/sound]
      {VARIABLE finished no}
      {VARIABLE healed no}
      [while]
        {SX_CMP finished equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [message]
            speaker=narrator
            message= _ "~<255,128,0>In shop you can buy or sell stuff. Most of
~<255,128,0>shopping actions can be canceled, but only
~<255,128,0>until you will leave selected shop section.
<225,225,25>Gold: $gold|"
            image="scenery/signpost.png"
            [option]
              message= _ {MENU_IMG_TXT "icons/leave.png" "~*<0,255,255>Leave shop"}
              [command]
                {VARIABLE finished "yes"}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/heal.png" "~*<0,255,0>20 gold: Restore full HP"}
              [show_if]
                {SX_CMP healed equals no}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 20}
                  [then]
                    [gold]
                      amount=-20
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=hitpoints
                        increase_total=0
                        heal_full=yes
                      [/effect]
                      [effect]
                        apply_to=status
                        remove=poisoned
                      [/effect]
                      [effect]
                        apply_to=status
                        remove=slowed
                      [/effect]
                    [/object]
                  [/then]
                [/if]
                {CLEAR_VARIABLE healed}
              [/command]
            [/option]
            {SX_SHOP_ENHANCEMENTS}
            {SX_SHOP_WEAPONS}
            {SX_SHOP_SPECIALS}
            {SX_SHOP_ARMORY}
            {SX_SHOP_MOVEMENTS}
            {SX_SHOP_ABILITIES}
            {SX_SHOP_ITEMS}
          [/message]
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE healed}
      {CLEAR_VARIABLE gold}
      {CLEAR_VARIABLE finished}
    [/command]
  [/set_menu_item]
#enddef

#define SX_SHOP_ENHANCEMENTS
  [option]
    message= _ {MENU_IMG_TXT "icons/enhancements-small.png" "~*<0,64,255>Enhancements"}
    [command]
      {VARIABLE finished_sub no}
      {VARIABLE melee_damage 0}
      {VARIABLE ranged_damage 0}
      {VARIABLE melee_strikes 0}
      {VARIABLE ranged_strikes 0}
      {VARIABLE health_points 0}
      {VARIABLE movement_points 0}
      {VARIABLE melee_damage_gold 0}
      {VARIABLE ranged_damage_gold 0}
      {VARIABLE melee_strikes_gold 0}
      {VARIABLE ranged_strikes_gold 0}
      {VARIABLE health_points_gold 0}
      {VARIABLE movement_points_gold 0}
      [store_unit]
        [filter]
          side=$side_number
          x,y=$x1,$y1
          canrecruit=yes
        [/filter]
        variable=enhancements
      [/store_unit]
      [while]
        {SX_CMP finished_sub equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [if]
            {SX_CMP maximum_level_reached_$side_number equals "yes"}
            [then]
              {VARIABLE moveleft 20}
            [/then]
            [else]
              {VARIABLE moveleft 12}
            [/else]
          [/if]
          {VARIABLE_OP moveleft add (-$enhancements.movement)}
          {VARIABLE_OP moveleft add (-$movement_upgrades_$side_number||)}
          {VARIABLE_OP moveleft add $speedy_$side_number}
          [message]
            speaker=narrator
            message= _ "~**<64,192,32>Enhancements
~Here you can buy training, that will teach your unit to do
~more damage, attack faster and increase health and
~movement. Actions in this section can not be canceled.
<225,225,25>Gold: $gold|
<128,128,255>Movement trainings left: $moveleft|"
            image="icons/enhancements.png"
            [option]
              message= _ {MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub "yes"}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-melee.png" "<255,144,96>Hide melee upgrades"}
              [command]
                {VARIABLE hide_melee_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals yes}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-melee.png" "<96,192,96>Show melee upgrades"}
              [command]
                {VARIABLE hide_melee_$side_number no}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP melee_damage numerical_not_equals 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-melee.png" "+$melee_damage_gold| gold: Cancel Melee Damage training (-$melee_damage|)"}
              [command]
                [gold]
                  amount=$melee_damage_gold
                  side=$side_number
                [/gold]
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=attack
                    range=melee
                    increase_damage=-$melee_damage
                  [/effect]
                [/object]
                {VARIABLE_OP melee_damage_$side_number add (-$ranged_damage)}
                {VARIABLE melee_damage 0}
                {VARIABLE melee_damage_gold 0}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-melee.png" "20 gold: +1 Melee Damage"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 20}
                  [then]
                    [gold]
                      amount=-20
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=melee
                        increase_damage=1
                      [/effect]
                    [/object]
                    {VARIABLE_OP melee_damage_$side_number add 1}
                    {VARIABLE_OP melee_damage add 1}
                    {VARIABLE_OP melee_damage_gold add 20}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-melee.png" "90 gold: +5 Melee Damage"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 90}
                  [then]
                    [gold]
                      amount=-90
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=melee
                        increase_damage=5
                      [/effect]
                    [/object]
                    {VARIABLE_OP melee_damage_$side_number add 5}
                    {VARIABLE_OP melee_damage add 5}
                    {VARIABLE_OP melee_damage_gold add 90}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP melee_strikes numerical_not_equals 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/strikes-melee.png" "+$melee_strikes_gold| gold: Cancel Melee Strikes training (-$melee_strikes|)"}
              [command]
                [gold]
                  amount=$melee_strikes_gold
                  side=$side_number
                [/gold]
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=attack
                    range=melee
                    increase_attacks=-$melee_strikes
                  [/effect]
                [/object]
                {VARIABLE_OP melee_strikes_$side_number add (-$ranged_strikes)}
                {VARIABLE melee_strikes 0}
                {VARIABLE melee_strikes_gold 0}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/strikes-melee.png" "75 gold: +1 Melee Strikes"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 75}
                  [then]
                    [gold]
                      amount=-75
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=melee
                        increase_attacks=1
                      [/effect]
                    [/object]
                    {VARIABLE_OP melee_strikes_$side_number add 1}
                    {VARIABLE_OP melee_strikes add 1}
                    {VARIABLE_OP melee_strikes_gold add 75}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/strikes-melee.png" "200 gold: +3 Melee Strikes"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=melee
                        increase_attacks=3
                      [/effect]
                    [/object]
                    {VARIABLE_OP melee_strikes_$side_number add 3}
                    {VARIABLE_OP melee_strikes add 3}
                    {VARIABLE_OP melee_strikes_gold add 200}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-ranged.png" "<255,144,96>Hide ranged upgrades"}
              [command]
                {VARIABLE hide_ranged_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_ranged_$side_number equals yes}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-ranged.png" "<96,192,96>Show ranged upgrades"}
              [command]
                {VARIABLE hide_ranged_$side_number no}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP ranged_damage numerical_not_equals 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-ranged.png" "+$ranged_damage_gold| gold: Cancel Ranged Damage training (-$ranged_damage|)"}
              [command]
                [gold]
                  amount=$ranged_damage_gold
                  side=$side_number
                [/gold]
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=attack
                    range=ranged
                    increase_damage=-$ranged_damage
                  [/effect]
                [/object]
                {VARIABLE_OP ranged_damage_$side_number add (-$ranged_damage)}
                {VARIABLE ranged_damage 0}
                {VARIABLE ranged_damage_gold 0}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-ranged.png" "20 gold: +1 Ranged Damage"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 20}
                  [then]
                    [gold]
                      amount=-20
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=ranged
                        increase_damage=1
                      [/effect]
                    [/object]
                    {VARIABLE_OP ranged_damage_$side_number add 1}
                    {VARIABLE_OP ranged_damage add 1}
                    {VARIABLE_OP ranged_damage_gold add 20}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-ranged.png" "90 gold: +5 Ranged Damage"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 90}
                  [then]
                    [gold]
                      amount=-90
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=ranged
                        increase_damage=5
                      [/effect]
                    [/object]
                    {VARIABLE_OP ranged_damage_$side_number add 5}
                    {VARIABLE_OP ranged_damage add 5}
                    {VARIABLE_OP ranged_damage_gold add 90}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP ranged_strikes numerical_not_equals 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/strikes-ranged.png" "+$ranged_strikes_gold| gold: Cancel Ranged Strikes training (-$ranged_strikes|)"}
              [command]
                [gold]
                  amount=$ranged_strikes_gold
                  side=$side_number
                [/gold]
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=attack
                    range=ranged
                    increase_attacks=-$ranged_strikes
                  [/effect]
                [/object]
                {VARIABLE_OP ranged_strikes_$side_number add (-$ranged_strikes)}
                {VARIABLE ranged_strikes 0}
                {VARIABLE ranged_strikes_gold 0}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/strikes-ranged.png" "75 gold: +1 Ranged Strikes"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 75}
                  [then]
                    [gold]
                      amount=-75
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=ranged
                        increase_attacks=1
                      [/effect]
                    [/object]
                    {VARIABLE_OP ranged_strikes_$side_number add 1}
                    {VARIABLE_OP ranged_strikes add 1}
                    {VARIABLE_OP ranged_strikes_gold add 75}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/strikes-ranged.png" "200 gold: +3 Ranged Strikes"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=attack
                        range=ranged
                        increase_attacks=3
                      [/effect]
                    [/object]
                    {VARIABLE_OP ranged_strikes_$side_number add 3}
                    {VARIABLE_OP ranged_strikes add 3}
                    {VARIABLE_OP ranged_strikes_gold add 200}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP health_points numerical_not_equals 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/health5.png" "+$health_points_gold| gold: Cancel HP upgrade (-$health_points|)"}
              [command]
                [gold]
                  amount=$health_points_gold
                  side=$side_number
                [/gold]
                [object]
                  duration=forever
                  [effect]
                    apply_to=hitpoints
                    increase_total=-$health_points
                    violate_maximum=yes
                  [/effect]
                  [effect]
                    apply_to=hitpoints
                    increase=-$health_points
                    violate_maximum=yes
                  [/effect]
                  silent=yes
                [/object]
                {VARIABLE health_points 0}
                {VARIABLE health_points_gold 0}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/health5.png" "10 gold: +5 Max. HP"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 10}
                  [then]
                    [gold]
                      amount=-10
                      side=$side_number
                    [/gold]
                    [object]
                      duration=forever
                      [effect]
                        apply_to=hitpoints
                        increase_total=5
                        violate_maximum=yes
                      [/effect]
                      [effect]
                        apply_to=hitpoints
                        increase=5
                        violate_maximum=yes
                      [/effect]
                      silent=yes
                    [/object]
                    {VARIABLE_OP health_points add 5}
                    {VARIABLE_OP health_points_gold add 10}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/health50.png" "90 gold: +50 Max. HP"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 90}
                  [then]
                    [gold]
                      amount=-90
                      side=$side_number
                    [/gold]
                    [object]
                      duration=forever
                      [effect]
                        apply_to=hitpoints
                        increase_total=50
                        violate_maximum=yes
                      [/effect]
                      [effect]
                        apply_to=hitpoints
                        increase=50
                        violate_maximum=yes
                      [/effect]
                      silent=yes
                    [/object]
                    {VARIABLE_OP health_points add 50}
                    {VARIABLE_OP health_points_gold add 90}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movement_points numerical_not_equals 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/movement.png" "+$movement_points_gold| gold: Cancel Movement upgrade (-$movement_points|)"}
              [command]
                [gold]
                  amount=$movement_points_gold
                  side=$side_number
                [/gold]
                [store_unit]
                  [filter]
                    x,y=$x1,$y1
                    side=$side_number
                  [/filter]
                  variable=moveshop
                [/store_unit]
                {VARIABLE_OP moveshop.moves add (-$movement_points)}
                [unstore_unit]
                  variable=moveshop
                [/unstore_unit]
                {CLEAR_VARIABLE moveshop}
                [object]
                  silent=yes
                  duration=forever
                  [effect]
                    apply_to=movement
                    increase=-$movement_points
                  [/effect]
                [/object]
                {VARIABLE_OP movement_upgrades_$side_number add -$movement_points}
                {VARIABLE movement_points 0}
                {VARIABLE movement_points_gold 0}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/movement.png" "30 gold: +1 Movement Point"}
              [show_if]
                {SX_CMP moveleft greater_than 0}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 30}
                  [then]
                    [gold]
                      amount=-30
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=movement
                        increase=1
                      [/effect]
                    [/object]
                    [store_unit]
                      [filter]
                        x,y=$x1,$y1
                        side=$side_number
                      [/filter]
                      variable=moveshop
                    [/store_unit]
                    {VARIABLE_OP moveshop.moves add 1}
                    [unstore_unit]
                      variable=moveshop
                    [/unstore_unit]
                    {CLEAR_VARIABLE moveshop}
                    {VARIABLE_OP movement_upgrades_$side_number add 1}
                    {VARIABLE_OP movement_points add 1}
                    {VARIABLE_OP movement_points_gold add 30}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/movement.png" "105 gold: +4 Movement Points"}
              [show_if]
                {SX_CMP moveleft greater_than 3}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 105}
                  [then]
                    [gold]
                      amount=-105
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=movement
                        increase=4
                      [/effect]
                    [/object]
                    [store_unit]
                      [filter]
                        x,y=$x1,$y1
                        side=$side_number
                      [/filter]
                      variable=moveshop
                    [/store_unit]
                    {VARIABLE_OP moveshop.moves add 4}
                    [unstore_unit]
                      variable=moveshop
                    [/unstore_unit]
                    {CLEAR_VARIABLE moveshop}
                    {VARIABLE_OP movement_upgrades_$side_number add 4}
                    {VARIABLE_OP movement_points add 4}
                    {VARIABLE_OP movement_points_gold add 105}
                  [/then]
                [/if]
              [/command]
            [/option]
          [/message]
          [redraw]
          [/redraw]
          {CLEAR_VARIABLE moveleft}
        [/do]
      [/while]
      {CLEAR_VARIABLE enhancements}
      {CLEAR_VARIABLE melee_damage}
      {CLEAR_VARIABLE ranged_damage}
      {CLEAR_VARIABLE melee_strikes}
      {CLEAR_VARIABLE ranged_strikes}
      {CLEAR_VARIABLE health_points}
      {CLEAR_VARIABLE movement_points}
      {CLEAR_VARIABLE melee_damage_gold}
      {CLEAR_VARIABLE ranged_damage_gold}
      {CLEAR_VARIABLE melee_strikes_gold}
      {CLEAR_VARIABLE ranged_strikes_gold}
      {CLEAR_VARIABLE health_points_gold}
      {CLEAR_VARIABLE movement_points_gold}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SX_SHOP_WEAPONS
  [option]
    message= _ {MENU_IMG_TXT "icons/weapons-small.png" "~*<255,0,0>Weapons"}
    [command]
      {VARIABLE weapons_bought "nothing,"}
      {VARIABLE finished_sub no}
      [while]
        {SX_CMP finished_sub equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [store_unit]
            [filter]
              side=$side_number
              x,y=$x1,$y1
              canrecruit=yes
            [/filter]
            variable=weapons
          [/store_unit]
          {VARIABLE weapon_j 0}
          {FOREACH weapons.attack weapon_i}
            {VARIABLE name ",$weapons.attack[$weapon_i|].name|,"}
            {VARIABLE name_$weapon_j $weapons.attack[$weapon_i|].name}
            {VARIABLE range_$weapon_j $weapons.attack[$weapon_i|].range}
            {VARIABLE type_$weapon_j $weapons.attack[$weapon_i|].type}
            {VARIABLE damage $weapons.attack[$weapon_i|].damage}
            {VARIABLE_OP damage add (-$$weapons.attack[$weapon_i|].range|_damage_$side_number)}
            {VARIABLE number $weapons.attack[$weapon_i|].number}
            {VARIABLE_OP number add (-$$weapons.attack[$weapon_i|].range|_strikes_$side_number)}
            [if]
              {SX_CMP weapons_bought contains $name}
              [then]
                {VARIABLE price_$weapon_j 40}
              [/then]
              [else]
                {SX_IDENTIFY_SPECIALS weapons.attack[$weapon_i|].specials $weapon_j|}
                {VARIABLE price_$weapon_j $damage}
                {VARIABLE_OP price_$weapon_j multiply $number}
                {VARIABLE_OP price_$weapon_j multiply $$weapons.attack[$weapon_i|].type}
                {VARIABLE_OP price_$weapon_j multiply $$weapons.attack[$weapon_i|].range}
                {SX_ROUND price_$weapon_j add $specials_price_$weapon_j floor}
              [/else]
            [/if]
            {VARIABLE sell_text_$weapon_j "+$price_$weapon_j|| gold: sell $weapons.attack[$weapon_i|].description|: $weapons.attack[$weapon_i|].range| $weapons.attack[$weapon_i|].type| $damage| - $number|$specials_list_$weapon_j|"}
            {VARIABLE_OP weapon_j add 1}
            {CLEAR_VARIABLE damage}
            {CLEAR_VARIABLE number}
          {NEXT weapon_i}
          [message]
            speaker=narrator
            message= _ "~**<64,192,32>Weapons
~You can buy only basic weapons here. Specials can be bought
~separately in Weapon specials section. You can have maximum
~of 8 weapons at a time. You can also sell any weapon you have
~(your unit related weapons can only be sold after reaching
~maximum level for your unit).
<225,225,25>Gold: $gold|"
            image="icons/weapons.png"
            [option]
              message= _ {MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub "yes"}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-melee.png" "<255,144,96>Hide melee weapons"}
              [command]
                {VARIABLE hide_melee_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals yes}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-melee.png" "<96,192,96>Show melee weapons"}
              [command]
                {VARIABLE hide_melee_$side_number no}
              [/command]
            [/option]
            {SX_BUY_WEAPON "icons/blessed-sword.png" (blessed sword) blessed_sword melee arcane 7 4 "attacks/sword-holy.png" {SOUND_LIST:SWORD_SWISH},{SOUND_LIST:HOLY} {SOUND_LIST:HOLY_MISS}}
            {SX_BUY_WEAPON "icons/iron-sword.png" (iron sword) iron_sword melee blade 11 5 "attacks/sword-human.png" {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS}}
            {SX_BUY_WEAPON "icons/ice-sword.png" (ice sword) ice_sword melee cold 11 4 "attacks/astral-blade.png" {SOUND_LIST:SWORD_SWISH} {SOUND_LIST:MISS}}
            {SX_BUY_WEAPON "icons/flaming-sword.png" (flaming sword) "flaming_sword" melee fire 9 4 "attacks/sword-flaming.png" {SOUND_LIST:SWORD_SWISH},flame-big.ogg {SOUND_LIST:MISS},flame-big-miss.ogg}
            {SX_BUY_WEAPON "icons/mace.png" (mace) mace melee impact 17 3 "attacks/mace.png" mace.wav {SOUND_LIST:MISS}}
            {SX_BUY_WEAPON "icons/spear.png" (spear) spear melee pierce 13 4 "attacks/spear.png" spear.ogg spear-miss.ogg}
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-ranged.png" "<255,144,96>Hide ranged weapons"}
              [command]
                {VARIABLE hide_ranged_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_ranged_$side_number equals yes}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-ranged.png" "<96,192,96>Show ranged weapons"}
              [command]
                {VARIABLE hide_ranged_$side_number no}
              [/command]
            [/option]
            {SX_BUY_WEAPON "icons/lightbeam.png" (lightbeam) lightbeam ranged arcane 9 4 "attacks/lightbeam.png" {SOUND_LIST:HOLY} {SOUND_LIST:HOLY_MISS}}
            {SX_BUY_WEAPON "icons/chakram.png" (chakram) chakram ranged blade 14 5 "attacks/chakram.png" {SOUND_LIST:THROW},dagger-swish.wav {SOUND_LIST:THROW}}
            {SX_BUY_WEAPON "icons/ice-wave.png" (ice wave) ice_wave ranged cold 14 4 "attacks/dark-missile.png" magic-dark.ogg magic-dark-miss.ogg}
            {SX_BUY_WEAPON "icons/fireball.png" (fireball) fireball ranged fire 11 4 "attacks/fireball.png" fire.wav fire.wav}
            {SX_BUY_WEAPON "icons/sling.png" (sling) sling ranged impact 16 4 "attacks/sling.png" sling.ogg sling-miss.ogg}
            {SX_BUY_WEAPON "icons/crossbow.png" (crossbow) crossbow ranged pierce 13 5 "attacks/crossbow-human.png" crossbow.ogg crossbow-miss.ogg}
            {SX_SELL_WEAPON 0}
            {SX_SELL_WEAPON 1}
            {SX_SELL_WEAPON 2}
            {SX_SELL_WEAPON 3}
            {SX_SELL_WEAPON 4}
            {SX_SELL_WEAPON 5}
            {SX_SELL_WEAPON 6}
            {SX_SELL_WEAPON 7}
            {SX_SELL_WEAPON 8}
            {SX_SELL_WEAPON 9}
            {SX_SELL_WEAPON 10}
            {SX_SELL_WEAPON 11}
          [/message]
          {VARIABLE weapon_i 0}
          [while]
            {SX_CMP weapon_i less_than $weapon_j}
            [do]
              {CLEAR_VARIABLE sell_text_$weapon_i}
              {CLEAR_VARIABLE price_$weapon_i}
              {CLEAR_VARIABLE name_$weapon_i}
              {CLEAR_VARIABLE specials_count_$weapon_i}
              {CLEAR_VARIABLE specials_list_$weapon_i}
              {CLEAR_VARIABLE specials_price_$weapon_i}
              {CLEAR_VARIABLE specials_array_$weapon_i}
              {VARIABLE_OP weapon_i add 1}
            [/do]
          [/while]
          {CLEAR_VARIABLE name}
          {CLEAR_VARIABLE weapon_i}
          {CLEAR_VARIABLE weapon_j}
          {CLEAR_VARIABLE weapons}
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE weapons_bought}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SX_SHOP_SPECIALS
  [option]
    message= _ {MENU_IMG_TXT "icons/specials-small.png" "~*<160,0,224>Weapon Specials Shop"}
    [command]
      {VARIABLE finished_sub no}
      [while]
        {SX_CMP finished_sub equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [store_unit]
            [filter]
              side=$side_number
              x,y=$x1,$y1
              canrecruit=yes
            [/filter]
            variable=weapons
          [/store_unit]
          {VARIABLE weapon_j 0}
          {FOREACH weapons.attack weapon_i}
            {VARIABLE name ",$weapons.attack[$weapon_i|].name|,"}
            {VARIABLE name_$weapon_j $weapons.attack[$weapon_i|].name}
            {VARIABLE description_$weapon_j $weapons.attack[$weapon_i|].description}
            {VARIABLE type_$weapon_j $weapons.attack[$weapon_i|].type}
            {VARIABLE range_$weapon_j $weapons.attack[$weapon_i|].range}
            {VARIABLE damage $weapons.attack[$weapon_i|].damage}
            {VARIABLE_OP damage add (-$$weapons.attack[$weapon_i|].range|_damage_$side_number)}
            {VARIABLE number $weapons.attack[$weapon_i|].number}
            {VARIABLE_OP number add (-$$weapons.attack[$weapon_i|].range|_strikes_$side_number)}
            {SX_IDENTIFY_SPECIALS weapons.attack[$weapon_i|].specials $weapon_j|}
            {VARIABLE select_text_$weapon_j "$weapons.attack[$weapon_i|].description|: $weapons.attack[$weapon_i|].range| $weapons.attack[$weapon_i|].type| $damage| - $number|$specials_list_$weapon_j|"}
            {VARIABLE_OP weapon_j add 1}
            {CLEAR_VARIABLE damage}
            {CLEAR_VARIABLE number}
          {NEXT weapon_i}
          [message]
            speaker=narrator
            message= _ "~**<64,192,32>Weapon Specials
~Weapon smith in shop can add or remove specials for any weapon you
~have, but he can only add to total number of 2 specials per weapon.
~There are allowed only some combinations of specials to buy. Specials,
~that your unit got naturally, can only be changed after reaching it's
~highest level. Actions in this section can't be canceled.
<225,225,25>Gold: $gold|
Select weapon you want to add/remove it's special:"
            image="icons/specials.png"
            [option]
              message= _ {MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-melee.png" "<255,144,96>Hide melee weapons"}
              [command]
                {VARIABLE hide_melee_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals yes}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-melee.png" "<96,192,96>Show melee weapons"}
              [command]
                {VARIABLE hide_melee_$side_number no}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_melee_$side_number equals no}
                {SX_CMP hide_ranged_$side_number equals no}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-ranged.png" "<255,144,96>Hide ranged weapons"}
              [command]
                {VARIABLE hide_ranged_$side_number yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP hide_ranged_$side_number equals yes}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-ranged.png" "<96,192,96>Show ranged weapons"}
              [command]
                {VARIABLE hide_ranged_$side_number no}
              [/command]
            [/option]
            {SX_SHOP_SPECIALS_SET 0}
            {SX_SHOP_SPECIALS_SET 1}
            {SX_SHOP_SPECIALS_SET 2}
            {SX_SHOP_SPECIALS_SET 3}
            {SX_SHOP_SPECIALS_SET 4}
            {SX_SHOP_SPECIALS_SET 5}
            {SX_SHOP_SPECIALS_SET 6}
            {SX_SHOP_SPECIALS_SET 7}
            {SX_SHOP_SPECIALS_SET 8}
            {SX_SHOP_SPECIALS_SET 9}
            {SX_SHOP_SPECIALS_SET 10}
            {SX_SHOP_SPECIALS_SET 11}
          [/message]
          {VARIABLE weapon_i 0}
          [while]
            {SX_CMP weapon_i less_than $weapon_j}
            [do]
              {CLEAR_VARIABLE select_text_$weapon_i}
              {CLEAR_VARIABLE name_$weapon_i}
              {CLEAR_VARIABLE specials_count_$weapon_i}
              {CLEAR_VARIABLE specials_list_$weapon_i}
              {CLEAR_VARIABLE specials_price_$weapon_i}
              {CLEAR_VARIABLE specials_array_$weapon_i}
              {VARIABLE_OP weapon_i add 1}
            [/do]
          [/while]
          {CLEAR_VARIABLE name}
          {CLEAR_VARIABLE weapon_i}
          {CLEAR_VARIABLE weapon_j}
          {CLEAR_VARIABLE weapons}
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SX_SHOP_ARMORY
  [option]
    message= _ {MENU_IMG_TXT "icons/armory-small.png" "~*<255,255,0>Armory"}
    [command]
      {VARIABLE finished_sub no}
      {VARIABLE arcane_session 0}
      {VARIABLE blade_session 0}
      {VARIABLE cold_session 0}
      {VARIABLE fire_session 0}
      {VARIABLE impact_session 0}
      {VARIABLE pierce_session 0}
      {VARIABLE arcane_extra 0}
      {VARIABLE blade_extra 0}
      {VARIABLE cold_extra 0}
      {VARIABLE fire_extra 0}
      {VARIABLE impact_extra 0}
      {VARIABLE pierce_extra 0}
      [if]
        {SX_CMP maximum_level_reached_$side_number equals "yes"}
        [then]
          {VARIABLE armory_warning "~The EXTRA armor upgrades shown are all you can get,
~choose carefully, which resistances you need!"}
        [/then]
        [else]
          {VARIABLE armory_warning "~EXTRA upgrades shown are maximum for your level.
~This will increase for most units at higher level."}
        [/else]
      [/if]
      [while]
        {SX_CMP finished_sub equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [store_unit]
            [filter]
              side=$side_number
              x,y=$x1,$y1
              canrecruit=yes
            [/filter]
            variable=armory
          [/store_unit]
          {VARIABLE current_arcane 200}
          {VARIABLE current_blade 200}
          {VARIABLE current_cold 200}
          {VARIABLE current_fire 200}
          {VARIABLE current_impact 200}
          {VARIABLE current_pierce 200}
          {VARIABLE_OP current_arcane add (-$armory.resistance.arcane)}
          {VARIABLE_OP current_blade add (-$armory.resistance.blade)}
          {VARIABLE_OP current_cold add (-$armory.resistance.cold)}
          {VARIABLE_OP current_fire add (-$armory.resistance.fire)}
          {VARIABLE_OP current_impact add (-$armory.resistance.impact)}
          {VARIABLE_OP current_pierce add (-$armory.resistance.pierce)}
          {VARIABLE_OP current_arcane add -100}
          {VARIABLE_OP current_blade add -100}
          {VARIABLE_OP current_cold add -100}
          {VARIABLE_OP current_fire add -100}
          {VARIABLE_OP current_impact add -100}
          {VARIABLE_OP current_pierce add -100}
          {VARIABLE left $armor_total_$side_number}
          {VARIABLE_OP left add (-$extra_armor_bought_$side_number)}
          {VARIABLE extra $extra_armor_bought_$side_number}
          [message]
            speaker=narrator
            message= _ "~**<64,192,32>Armory
$armory_warning|
~Extra resistances for your level are all resistances
~over $armor_limit_$side_number||%, that you will buy.
<225,225,25>Gold: $gold|
@EXTRA upgrades left: $left|%
~<20,200,250>Current resistances:
<20,200,250>Blade: $current_blade|%        Arcane: $current_arcane|%
<20,200,250>Impact: $current_impact|%      Cold: $current_cold|%
<20,200,250>Pierce: $current_pierce|%      Fire: $current_fire|%"
            image="icons/armory.png"
            [option]
              message= _ {MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            {SX_ARMORY_TYPE blade}
            {SX_ARMORY_TYPE impact}
            {SX_ARMORY_TYPE pierce}
            {SX_ARMORY_TYPE arcane}
            {SX_ARMORY_TYPE cold}
            {SX_ARMORY_TYPE fire}
          [/message]
          {CLEAR_VARIABLE current_arcane}
          {CLEAR_VARIABLE current_blade}
          {CLEAR_VARIABLE current_cold}
          {CLEAR_VARIABLE current_fire}
          {CLEAR_VARIABLE current_impact}
          {CLEAR_VARIABLE current_pierce}
          {CLEAR_VARIABLE left}
          {CLEAR_VARIABLE extra}
          {CLEAR_VARIABLE armory}
          {CLEAR_VARIABLE armory_warning}
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE arcane_session}
      {CLEAR_VARIABLE blade_session}
      {CLEAR_VARIABLE cold_session}
      {CLEAR_VARIABLE fire_session}
      {CLEAR_VARIABLE impact_session}
      {CLEAR_VARIABLE pierce_session}
      {CLEAR_VARIABLE arcane_extra}
      {CLEAR_VARIABLE blade_extra}
      {CLEAR_VARIABLE cold_extra}
      {CLEAR_VARIABLE fire_extra}
      {CLEAR_VARIABLE impact_extra}
      {CLEAR_VARIABLE pierce_extra}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SX_SHOP_MOVEMENTS
  [option]
    message= _ {MENU_IMG_TXT "icons/terrain-training-small.png" "~*<224,192,32>Terrain Training"}
    [command]
      {VARIABLE finished_sub no}
      [while]
        {SX_CMP finished_sub equals no}
        [do]
          [store_unit]
            [filter]
              side=$side_number
              x,y=$x1,$y1
              canrecruit=yes
            [/filter]
            variable=movements
          [/store_unit]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          {VARIABLE left $terrains_left_$side_number}
          {SX_TRAINING_CHECK mc_castle}
          {SX_TRAINING_CHECK mc_cave}
          {SX_TRAINING_CHECK mc_deep_water}
          {SX_TRAINING_CHECK mc_flat}
          {SX_TRAINING_CHECK mc_forest}
          {SX_TRAINING_CHECK mc_frozen}
          {SX_TRAINING_CHECK mc_fungus}
          {SX_TRAINING_CHECK mc_hills}
          {SX_TRAINING_CHECK mc_impassable}
          {SX_TRAINING_CHECK mc_mountains}
          {SX_TRAINING_CHECK mc_reef}
          {SX_TRAINING_CHECK mc_sand}
          {SX_TRAINING_CHECK mc_shallow_water}
          {SX_TRAINING_CHECK mc_swamp_water}
          {SX_TRAINING_CHECK mc_unwalkable}
          {SX_TRAINING_CHECK mc_village}
          {VARIABLE mc_price 25}
          [message]
            speaker=narrator
            message= _ "~**<64,192,32>Terrain training
~Here you can decrease movement cost for selected
~terrain, but you can choose max. 4 terrain types.
<225,225,25>Gold: $gold|
@Training left: $left|
~<250,0,0>Current movement costs:
<20,200,250>Castle: $movements.movement_costs.castle| $mc_castle|            Cave: $movements.movement_costs.cave| $mc_cave|        Deep water: $movements.movement_costs.deep_water| $mc_deep_water|  Flat: $movements.movement_costs.flat| $mc_flat|
<20,200,250>Forest: $movements.movement_costs.forest| $mc_forest|            Frozen: $movements.movement_costs.frozen| $mc_frozen|     Fungus: $movements.movement_costs.fungus| $mc_fungus|        Hills: $movements.movement_costs.hills| $mc_hills|
<20,200,250>Mountains: $movements.movement_costs.mountains| $mc_mountains|      Reef: $movements.movement_costs.reef| $mc_reef|        Sand: $movements.movement_costs.sand| $mc_sand|            Shallow water: $movements.movement_costs.shallow_water| $mc_shallow_water|
<20,200,250>Swamp water: $movements.movement_costs.swamp_water| $mc_swamp_water|  Village: $movements.movement_costs.village| $mc_village|     Unwalkable: $movements.movement_costs.unwalkable| $mc_unwalkable|  Impassable: $movements.movement_costs.impassable| $mc_impassable|"
            image="icons/terrain-training.png"
            [option]
              message= _ {MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.castle greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/castle.png" "$mc_price| gold: Buy training for castle (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_castle_$side_number "1"}
                    {VARIABLE mc_castle_session $movements.movement_costs.castle}
                    {VARIABLE movements.movement_costs.castle 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_castle_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/castle-cancel.png" "+$mc_price| gold: Cancel training for castle"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_castle_$side_number 0}
                {VARIABLE movements.movement_costs.castle $mc_castle_session}
                {CLEAR_VARIABLE mc_castle_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.cave greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/cave.png" "$mc_price| gold: Buy training for cave (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_cave_$side_number 1}
                    {VARIABLE mc_cave_session $movements.movement_costs.cave}
                    {VARIABLE movements.movement_costs.cave 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_cave_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/cave-cancel.png" "+$mc_price| gold: Cancel training for cave"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_cave_$side_number 0}
                {VARIABLE movements.movement_costs.cave $mc_cave_session}
                {CLEAR_VARIABLE mc_cave_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP left greater_than 0}
                {SX_CMP movements.flying equals yes}
                {SX_CMP movements.movement_costs.deep_water greater_than 1}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/deep-water.png" "$mc_price| gold: Buy training for deep water (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_deep_water_$side_number 1}
                    {VARIABLE mc_deep_water_session $movements.movement_costs.deep_water}
                    {VARIABLE movements.movement_costs.deep_water 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.deep_water greater_than 3}
                {SX_CMP movements.flying equals no}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/deep-water.png" "$mc_price| gold: Buy training for deep_water (to 3MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_deep_water_$side_number 1}
                    {VARIABLE mc_deep_water_session $movements.movement_costs.deep_water}
                    {VARIABLE movements.movement_costs.deep_water 3}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_deep_water_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/deep-water-cancel.png" "+$mc_price| gold: Cancel training for deep water"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_deep_water_$side_number 0}
                {VARIABLE movements.movement_costs.deep_water $mc_deep_water_session}
                {CLEAR_VARIABLE mc_deep_water_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.flat greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/flat.png" "$mc_price| gold: Buy training for flat (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_flat_$side_number 1}
                    {VARIABLE mc_flat_session $movements.movement_costs.flat}
                    {VARIABLE movements.movement_costs.flat 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_flat_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/flat-cancel.png" "+$mc_price| gold: Cancel training for flat"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_flat_$side_number 0}
                {VARIABLE movements.movement_costs.flat $mc_flat_session}
                {CLEAR_VARIABLE mc_flat_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.forest greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/forest.png" "$mc_price| gold: Buy training for forest (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_forest_$side_number 1}
                    {VARIABLE mc_forest_session $movements.movement_costs.forest}
                    {VARIABLE movements.movement_costs.forest 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_forest_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/forest-cancel.png" "+$mc_price| gold: Cancel training for forest"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_forest_$side_number 0}
                {VARIABLE movements.movement_costs.forest $mc_forest_session}
                {CLEAR_VARIABLE mc_forest_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.frozen greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/frozen.png" "$mc_price| gold: Buy training for frozen (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_frozen_$side_number 1}
                    {VARIABLE mc_frozen_session $movements.movement_costs.frozen}
                    {VARIABLE movements.movement_costs.frozen 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_frozen_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/frozen-cancel.png" "+$mc_price| gold: Cancel training for frozen"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_frozen_$side_number 0}
                {VARIABLE movements.movement_costs.frozen $mc_frozen_session}
                {CLEAR_VARIABLE mc_frozen_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.fungus greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/fungus.png" "$mc_price| gold: Buy training for fungus (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_fungus_$side_number 1}
                    {VARIABLE mc_fungus_session $movements.movement_costs.fungus}
                    {VARIABLE movements.movement_costs.fungus 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_fungus_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/fungus-cancel.png" "+$mc_price| gold: Cancel training for fungus"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_fungus_$side_number 0}
                {VARIABLE movements.movement_costs.fungus $mc_fungus_session}
                {CLEAR_VARIABLE mc_fungus_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.hills greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/hills.png" "$mc_price| gold: Buy training for hills (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_hills_$side_number 1}
                    {VARIABLE mc_hills_session $movements.movement_costs.hills}
                    {VARIABLE movements.movement_costs.hills 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_hills_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/hills-cancel.png" "+$mc_price| gold: Cancel training for hills"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_hills_$side_number 0}
                {VARIABLE movements.movement_costs.hills $mc_hills_session}
                {CLEAR_VARIABLE mc_hills_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.mountains greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/mountains.png" "$mc_price| gold: Buy training for mountains (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_mountains_$side_number 1}
                    {VARIABLE mc_mountains_session $movements.movement_costs.mountains}
                    {VARIABLE movements.movement_costs.mountains 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_mountains_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/mountains-cancel.png" "+$mc_price| gold: Cancel training for mountains"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_mountains_$side_number 0}
                {VARIABLE movements.movement_costs.mountains $mc_mountains_session}
                {CLEAR_VARIABLE mc_mountains_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.reef greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/reef.png" "$mc_price| gold: Buy training for reef (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_reef_$side_number 1}
                    {VARIABLE mc_reef_session $movements.movement_costs.reef}
                    {VARIABLE movements.movement_costs.reef 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_reef_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/reef-cancel.png" "+$mc_price| gold: Cancel training for reef"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_reef_$side_number 0}
                {VARIABLE movements.movement_costs.reef $mc_reef_session}
                {CLEAR_VARIABLE mc_reef_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.sand greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/sand.png" "$mc_price| gold: Buy training for sand (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_sand_$side_number 1}
                    {VARIABLE mc_sand_session $movements.movement_costs.sand}
                    {VARIABLE movements.movement_costs.sand 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_sand_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/sand-cancel.png" "+$mc_price| gold: Cancel training for sand"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_sand_$side_number 0}
                {VARIABLE movements.movement_costs.sand $mc_sand_session}
                {CLEAR_VARIABLE mc_sand_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.shallow_water greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/shallow-water.png" "$mc_price| gold: Buy training for shallow water (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_shallow_water_$side_number 1}
                    {VARIABLE mc_shallow_water_session $movements.movement_costs.shallow_water}
                    {VARIABLE movements.movement_costs.shallow_water 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_shallow_water_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/shallow-water-cancel.png" "+$mc_price| gold: Cancel training for shallow water"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_shallow_water_$side_number 0}
                {VARIABLE movements.movement_costs.shallow_water $mc_shallow_water_session}
                {CLEAR_VARIABLE mc_shallow_water_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.swamp_water greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/swamp-water.png" "$mc_price| gold: Buy training for swamp water (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_swamp_water_$side_number 1}
                    {VARIABLE mc_swamp_water_session $movements.movement_costs.swamp_water}
                    {VARIABLE movements.movement_costs.swamp_water 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_swamp_water_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/swamp-water-cancel.png" "+$mc_price| gold: Cancel training for swamp_water"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_swamp_water_$side_number 0}
                {VARIABLE movements.movement_costs.swamp_water $mc_swamp_water_session}
                {CLEAR_VARIABLE mc_swamp_water_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP movements.movement_costs.village greater_than 1}
                {SX_CMP left greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/village.png" "$mc_price| gold: Buy training for village (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_village_$side_number 1}
                    {VARIABLE mc_village_session $movements.movement_costs.village}
                    {VARIABLE movements.movement_costs.village 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_village_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/village-cancel.png" "+$mc_price| gold: Cancel training for village"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_village_$side_number 0}
                {VARIABLE movements.movement_costs.village $mc_village_session}
                {CLEAR_VARIABLE mc_village_session}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP left greater_than 0}
                {SX_CMP movements.flying equals yes}
                {SX_CMP movements.movement_costs.unwalkable greater_than 1}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/unwalkable.png" "$mc_price| gold: Buy training for unwalkable (to 1MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_unwalkable_$side_number 1}
                    {VARIABLE mc_unwalkable_session $movements.movement_costs.unwalkable}
                    {VARIABLE movements.movement_costs.unwalkable 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP left greater_than 0}
                {SX_CMP movements.flying equals no}
                {SX_CMP movements.movement_costs.unwalkable greater_than 3}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/unwalkable.png" "$mc_price| gold: Buy training for unwalkable (to 3MP cost)"}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to $mc_price}
                  [then]
                    [gold]
                      amount=-$mc_price
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP terrains_left_$side_number add -1}
                    {VARIABLE mc_unwalkable_$side_number 1}
                    {VARIABLE mc_unwalkable_session $movements.movement_costs.unwalkable}
                    {VARIABLE movements.movement_costs.unwalkable 3}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP mc_unwalkable_session greater_than 0}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/unwalkable-cancel.png" "+$mc_price| gold: Cancel training for unwalkable"}
              [command]
                [gold]
                  amount=$mc_price
                  side=$side_number
                [/gold]
                {VARIABLE_OP terrains_left_$side_number add 1}
                {VARIABLE mc_unwalkable_$side_number 0}
                {VARIABLE movements.movement_costs.unwalkable $mc_unwalkable_session}
                {CLEAR_VARIABLE mc_unwalkable_session}
              [/command]
            [/option]
#             [option]
#               [show_if]
#                 {SX_CMP left greater_than 0}
#                 {SX_CMP movements.flying equals yes}
#                 {SX_CMP movements.movement_costs.impassable greater_than 1}
#               [/show_if]
#               message= _ {MENU_IMG_TXT "icons/impassable.png" "$mc_price| gold: Buy training for impassable (to 1MP cost)"}
#               [command]
#                 [if]
#                   {SX_CMP gold greater_than_equal_to $mc_price}
#                   [then]
#                     [gold]
#                       amount=-$mc_price
#                       side=$side_number
#                     [/gold]
#                     {VARIABLE_OP terrains_left_$side_number add -1}
#                     {VARIABLE mc_impassable_$side_number 1}
#                     {VARIABLE mc_impassable_session $movements.movement_costs.impassable}
#                     {VARIABLE movements.movement_costs.impassable 1}
#                   [/then]
#                 [/if]
#               [/command]
#             [/option]
#             [option]
#               [show_if]
#                 {SX_CMP left greater_than 0}
#                 {SX_CMP movements.flying equals no}
#                 {SX_CMP movements.movement_costs.impassable greater_than 2}
#               [/show_if]
#               message= _ {MENU_IMG_TXT "icons/impassable.png" "$mc_price| gold: Buy training for impassable (to 2MP cost)"}
#               [command]
#                 [if]
#                   {SX_CMP gold greater_than_equal_to $mc_price}
#                   [then]
#                     [gold]
#                       amount=-$mc_price
#                       side=$side_number
#                     [/gold]
#                     {VARIABLE_OP terrains_left_$side_number add -1}
#                     {VARIABLE mc_impassable_$side_number 1}
#                     {VARIABLE mc_impassable_session $movements.movement_costs.impassable}
#                     {VARIABLE movements.movement_costs.impassable 2}
#                   [/then]
#                 [/if]
#               [/command]
#             [/option]
#             [option]
#               [show_if]
#                 {SX_CMP mc_impassable_session greater_than 0}
#               [/show_if]
#               message= _ {MENU_IMG_TXT "icons/impassable-cancel.png" "+$mc_price| gold: Cancel training for impassable"}
#               [command]
#                 [gold]
#                   amount=$mc_price
#                   side=$side_number
#                 [/gold]
#                 {VARIABLE_OP terrains_left_$side_number add 1}
#                 {VARIABLE mc_impassable_$side_number 0}
#                 {VARIABLE movements.movement_costs.impassable $mc_impassable_session}
#                 {CLEAR_VARIABLE mc_impassable_session}
#               [/command]
#             [/option]
          [/message]
          [unstore_unit]
            variable=movements
          [/unstore_unit]
          {CLEAR_VARIABLE left}
          {CLEAR_VARIABLE mc_castle}
          {CLEAR_VARIABLE mc_cave}
          {CLEAR_VARIABLE mc_deep_water}
          {CLEAR_VARIABLE mc_flat}
          {CLEAR_VARIABLE mc_forest}
          {CLEAR_VARIABLE mc_frozen}
          {CLEAR_VARIABLE mc_fungus}
          {CLEAR_VARIABLE mc_hills}
          {CLEAR_VARIABLE mc_impassable}
          {CLEAR_VARIABLE mc_mountains}
          {CLEAR_VARIABLE mc_reef}
          {CLEAR_VARIABLE mc_sand}
          {CLEAR_VARIABLE mc_shallow_water}
          {CLEAR_VARIABLE mc_swamp_water}
          {CLEAR_VARIABLE mc_unwalkable}
          {CLEAR_VARIABLE mc_village}
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE mc_castle_session}
      {CLEAR_VARIABLE mc_cave_session}
      {CLEAR_VARIABLE mc_deep_water_session}
      {CLEAR_VARIABLE mc_flat_session}
      {CLEAR_VARIABLE mc_forest_session}
      {CLEAR_VARIABLE mc_frozen_session}
      {CLEAR_VARIABLE mc_fungus_session}
      {CLEAR_VARIABLE mc_hills_session}
      {CLEAR_VARIABLE mc_impassable_session}
      {CLEAR_VARIABLE mc_mountains_session}
      {CLEAR_VARIABLE mc_reef_session}
      {CLEAR_VARIABLE mc_sand_session}
      {CLEAR_VARIABLE mc_shallow_water_session}
      {CLEAR_VARIABLE mc_swamp_water_session}
      {CLEAR_VARIABLE mc_unwalkable_session}
      {CLEAR_VARIABLE mc_village_session}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SX_SHOP_ABILITIES
  [option]
    message= _ {MENU_IMG_TXT "icons/abilities-small.png" "~*<160,255,112>Abilities Shop"}
    [command]
      {VARIABLE finished_sub no}
      [store_unit]
        [filter]
          side=$side_number
          canrecruit=yes
          x,y=$x1,$y1
        [/filter]
        variable=leader_abilities
      [/store_unit]
      {VARIABLE fl ""}
      {VARIABLE sf ""}
      {VARIABLE sm ""}
      {VARIABLE an $leader_abilities.abilities.length}
      {VARIABLE ac 0}
      [while]
        {SX_CMP ac less_than $an}
        [do]
          {VARIABLE rn $leader_abilities.abilities[$ac|].resistance.length}
          {VARIABLE rc 0}
          [while]
            {SX_CMP rc less_than $rn}
            [do]
              [if]
                {SX_CMP leader_abilities.abilities[$ac|].resistance[$rc|].id equals "sxc_steadfast"}
                [then]
                  {VARIABLE sf "sxc_steadfast"}
                [/then]
              [/if]
              {VARIABLE_OP rc add 1}
            [/do]
          [/while]
          {VARIABLE rn $leader_abilities.abilities[$ac|].skirmisher.length}
          {VARIABLE rc 0}
          [while]
            {SX_CMP rc less_than $rn}
            [do]
              [if]
                {SX_CMP leader_abilities.abilities[$ac|].skirmisher[$rc|].id equals "skirmisher"}
                [then]
                  {VARIABLE sm "skirmisher"}
                [/then]
              [/if]
              {VARIABLE_OP rc add 1}
            [/do]
          [/while]
          {CLEAR_VARIABLE rc}
          {CLEAR_VARIABLE rn}
          {VARIABLE_OP ac add 1}
        [/do]
      [/while]
      {VARIABLE an $leader_abilities.modifications.trait.length}
      {VARIABLE ac 0}
      [while]
        {SX_CMP ac less_than $an}
        [do]
          [if]
            {SX_CMP leader_abilities.modifications.trait[$ac|].id equals "fearless"}
            [then]
              {VARIABLE fl "fearless"}
            [/then]
          [/if]
          {VARIABLE_OP ac add 1}
        [/do]
      [/while]
      {CLEAR_VARIABLE ac}
      {CLEAR_VARIABLE an}
      {CLEAR_VARIABLE leader_abilities}
      [while]
        {SX_CMP finished_sub equals no}
        [do]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          {VARIABLE abilities_left 2}
          {VARIABLE_OP abilities_left add (-$abilities_$side_number)}
          [message]
            speaker=narrator
            message= _ "~**<64,192,32>Abilities
~Abilities gained in this shop can't be removed. Choose carefully
~which abilities you want to buy to get best combination of them.
~You can only buy 2 abilities, other can be gained from magical
~items, which can be found across the map or dropped by killed
~bosses (these are not calculated into upgrades from shop).
<225,225,25>Gold: $gold|
Select ability you want to buy ($abilities_left| upgrades left):"
            image="icons/abilities.png"
            [option]
              message= _ {MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP dauntless_$side_number not_equals yes}
                {SX_CMP abilities_$side_number less_than 2}
                {SX_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/dauntless.png" "@200 gold: learn ability Dauntless
`Doubles resistance up to 50% on offense. Negative
`resistances and resistances over 50% are not affected."}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          [resistance]
                            id=dauntless
                            name= _ "dauntless"
                            description= _ "Dauntless:
While attacking, this unit's resistances are doubled, up to a maximum of 50. Weaknesses are not affected."
                            name_inactive= _ "dauntless"
                            description_inactive= _ "Dauntless:
While attacking, this unit's resistances are doubled, up to a maximum of 50. Weaknesses are not affected."
                            multiply=2
                            max_value=150
                            apply_to=blade,pierce,impact,fire,cold,arcane
                            [filter_base_value]
                              greater_than=0
                              less_than_equal_to=25
                            [/filter_base_value]
                            affect_self=yes
                            active_on=offense
                          [/resistance]
                          [resistance]
                            id=dauntless
                            value=50
                            max_value=150
                            apply_to=blade,pierce,impact,fire,cold,arcane
                            [filter_base_value]
                              greater_than=25
                              less_than=50
                            [/filter_base_value]
                            affect_self=yes
                            active_on=offense
                          [/resistance]
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE dauntless_$side_number yes}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP fearless_$side_number not_equals yes}
                {SX_CMP abilities_$side_number less_than 2}
                {SX_CMP maximum_level_reached_$side_number equals "yes"}
                {SX_CMP fl not_equals "fearless"}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/fearless.png" "@150 gold: gain trait Fearless
`Unit fights normally during unfavorable times of day."}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 150}
                  [then]
                    [gold]
                      amount=-150
                      side=$side_number
                    [/gold]
                    [store_unit]
                      [filter]
                        side=$side_number
                        x,y=$x1,$y1
                        canrecruit=yes
                      [/filter]
                      variable=trait_fearless
                    [/store_unit]
                    {VARIABLE new_trait $trait_fearless.modifications.trait.length}
                    {VARIABLE trait_fearless.modifications.trait[$new_trait|].id "fearless"}
                    {VARIABLE trait_fearless.modifications.trait[$new_trait|].male_name _"fearless"}
                    {VARIABLE trait_fearless.modifications.trait[$new_trait|].female_name _"female^fearless"}
                    {VARIABLE trait_fearless.modifications.trait[$new_trait|].description _"Fights normally during unfavorable times of day/night"}
                    [unstore_unit]
                      variable=trait_fearless
                    [/unstore_unit]
                    {VARIABLE fearless_$side_number yes}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP leadership_$side_number not_equals yes}
                {SX_CMP abilities_$side_number less_than 2}
                {SX_CMP maximum_level_reached_$side_number equals "yes"}
                {SX_CMP allow_leadership_items equals "yes"}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/damage-both.png" "@200 gold: learn ability Leadership level 5
`Unit will lead alied units with lower level than 5, so they
`cause (5 - their_level) * 20% more damage while adjacent to it.
`It also affects unit that gain this ability so it is stronger.
`<255,64,64>This will replace all normal leadership abilities."}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=remove_ability
                        [abilities]
                          [leadership]
                            id=leadership
                          [/leadership]
                        [/abilities]
                      [/effect]
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          [leadership]
                            id=leadership5
                            value=100
                            cumulative=no
                            name= _ "leadership"
                            female_name= _ "female^leadership"
                            description= _ "Leadership:
Adjacent alied units of lower level than 5 will cause more damage in battle. They will gain 25% of power per level difference from level 5:
LVL 0: gain 100%
LVL 1: gain 80%
LVL 2: gain 60%
LVL 3: gain 40%
LVL 4: gain 20%"
                            affect_self=no
                            affect_allies=yes
                            affect_enemies=no
                            [affect_adjacent]
                              adjacent=n,ne,se,s,sw,nw
                              [filter]
                                level=0
                              [/filter]
                            [/affect_adjacent]
                          [/leadership]
                          [leadership]
                            id=leadership5
                            value=80
                            cumulative=no
                            affect_self=no
                            affect_allies=yes
                            affect_enemies=no
                            [affect_adjacent]
                              adjacent=n,ne,se,s,sw,nw
                              [filter]
                                level=1
                              [/filter]
                            [/affect_adjacent]
                          [/leadership]
                          [leadership]
                            id=leadership5
                            value=60
                            cumulative=no
                            affect_self=no
                            affect_allies=yes
                            affect_enemies=no
                            [affect_adjacent]
                              adjacent=n,ne,se,s,sw,nw
                              [filter]
                                level=2
                              [/filter]
                            [/affect_adjacent]
                          [/leadership]
                          [leadership]
                            id=leadership5
                            value=40
                            cumulative=no
                            affect_self=no
                            affect_allies=yes
                            affect_enemies=no
                            [affect_adjacent]
                              adjacent=n,ne,se,s,sw,nw
                              [filter]
                                level=3
                              [/filter]
                            [/affect_adjacent]
                          [/leadership]
                          [leadership]
                            id=leadership5
                            value=20
                            cumulative=no
                            affect_self=no
                            affect_allies=yes
                            affect_enemies=no
                            [affect_adjacent]
                              adjacent=n,ne,se,s,sw,nw
                              [filter]
                                level=4
                              [/filter]
                            [/affect_adjacent]
                          [/leadership]
                          [leadership]
                            id=leadership5
                            value=20
                            cumulative=no
                            affect_self=yes
                            affect_allies=no
                            affect_enemies=no
                          [/leadership]
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE leadership_$side_number yes}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP megacures_$side_number not_equals yes}
                {SX_CMP abilities_$side_number less_than 2}
                {SX_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/megacures.png" "@125 gold: learn ability Megacures
`Unit heals adjacent friendly units 20% of own maximum health
`per turn or cures them from poison if they are poisoned.
`<255,64,64>This will replace all normal healing abilities."}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 125}
                  [then]
                    [gold]
                      amount=-125
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=remove_ability
                        [abilities]
                          [heals]
                            id=healing
                          [/heals]
                        [/abilities]
                      [/effect]
                      [effect]
                        apply_to=remove_ability
                        [abilities]
                          [heals]
                            id=curing
                          [/heals]
                        [/abilities]
                      [/effect]
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          [heals]
                            affect_allies=yes
                            id=megacures
                            name= _ "megacures"
                            female_name= _ "female^megacures"
                            description= _ "Megacures:
This unit combines herbal remedies with strong magic to heal units much more quickly than is normally possible on the battlefield.
A unit cared for by this healer may heal up to 20% of healer's maximum HP per turn, or he can cure poison instead of healing if unit is poisoned."
                            affect_self=no
                            poison=cured
                            value=8
                            [affect_adjacent]
                              adjacent=n,ne,se,s,sw,nw
                            [/affect_adjacent]
                          [/heals]
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE megacures_$side_number yes}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP megaregenerates_$side_number not_equals yes}
                {SX_CMP abilities_$side_number less_than 2}
                {SX_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/megaregenerates.png" "@200 gold: learn ability Megaregenerates
`Unit heals itself 20% of maximum health per turn
`or cures itself from poison if unit is poisoned.
`<255,64,64>This will replace all normal regenerate abilities."}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=remove_ability
                        [abilities]
                          [regenerate]
                            id=regenerates
                          [/regenerate]
                        [/abilities]
                      [/effect]
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          [regenerate]
                            value=8
                            id=megaregenerates
                            name= _ "megaregenerates"
                            description= _ "Megaregenerates:
This unit will heal itself 20% of maximum HP per turn. If this unit is poisoned, it will remove the poison instead of healing."
                            affect_self=yes
                            poison=cured
                          [/regenerate]
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE megaregenerates_$side_number yes}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP skirmisher_$side_number not_equals yes}
                {SX_CMP abilities_$side_number less_than 2}
                {SX_CMP maximum_level_reached_$side_number equals "yes"}
                {SX_CMP sm not_equals "skirmisher"}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/skirmisher.png" "@100 gold: learn ability Skirmisher
`Unit ignores all enemy zones of control."}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          [skirmisher]
                            id=skirmisher
                            name= _ "skirmisher"
                            female_name= _ "female^skirmisher"
                            description= _ "Skirmisher:
This unit is skilled in moving past enemies quickly, and ignores all enemy Zones of Control."
                            affect_self=yes
                          [/skirmisher]
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE skirmisher_$side_number yes}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP soulstealer_$side_number not_equals yes}
                {SX_CMP abilities_$side_number less_than 2}
                {SX_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/soulstealer.png" "@100 gold: learn ability Soulstealer
`Unit gains +1 max. every time it kills enemy unit,
`regardless whether it is living or not.
`<255,64,64>This will replace all normal feeding abilities."}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=remove_ability
                        [abilities]
                          [dummy]
                            id=feeding
                          [/dummy]
                        [/abilities]
                      [/effect]
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          [dummy]
                            id=soulstealer2
                            name= _ "soulstealer"
                            description=_ "Soulstealer:
This unit gains 1 hitpoint added to its maximum whenever it kills a unit."
                          [/dummy]
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE soulstealer_$side_number yes}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP speedy_$side_number numerical_not_equals 2}
                {SX_CMP abilities_$side_number less_than 2}
                {SX_CMP maximum_level_reached_$side_number equals "yes"}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/speedy.png" "@150 gold: learn ability Speedy
`Unit has +2 movement points at start of each turn and
`also +1 movement point every time it kills enemy unit."}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 150}
                  [then]
                    [gold]
                      amount=-150
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          [dummy]
                            id=speedy
                            name= _ "speedy"
                            description=_ "Speedy:
This unit gains +2 movement points at start of turn and also +1 movement point after it kills a unit."
                          [/dummy]
                        [/abilities]
                      [/effect]
                      [effect]
                        apply_to=movement
                        increase=2
                      [/effect]
                    [/object]
                    {VARIABLE speedy_$side_number 2}
                    {VARIABLE_OP mp_kill_$side_number add 1}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              [show_if]
                {SX_CMP steadfast_$side_number not_equals yes}
                {SX_CMP abilities_$side_number less_than 2}
                {SX_CMP maximum_level_reached_$side_number equals "yes"}
                {SX_CMP sf not_equals "sxc_steadfast"}
              [/show_if]
              message= _ {MENU_IMG_TXT "icons/steadfast.png" "@200 gold: learn ability Steadfast
`Doubles resistance up to 50% on defense. Negative
`resistances and resistances over 50% are not affected."}
              [command]
                [if]
                  {SX_CMP gold greater_than_equal_to 200}
                  [then]
                    [gold]
                      amount=-200
                      side=$side_number
                    [/gold]
                    [object]
                      silent=yes
                      duration=forever
                      [effect]
                        apply_to=new_ability
                        [abilities]
                          [resistance]
                            id=sxc_steadfast
                            multiply=2
                            max_value=150
                            apply_to=arcane,blade,cold,fire,impact,pierce
                            [filter_base_value]
                              greater_than=0
                              less_than_equal_to=25
                            [/filter_base_value]
                            name= _ "steadfast"
                            name_inactive= _ "steadfast"
                            female_name= _ "female^steadfast"
                            female_name_inactive= _ "female^steadfast"
                            description_inactive= _ "Steadfast:
This unit's resistances are doubled, up to a maximum of 50%, when defending. Vulnerabilities are not affected."
                            description= _ "Steadfast:
This unit's resistances are doubled, up to a maximum of 50%, when defending. Vulnerabilities are not affected."
                            affect_self=yes
                            active_on=defense
                          [/resistance]
                          [resistance]
                            id=sxc_steadfast
                            value=50
                            max_value=150
                            apply_to=arcane,blade,cold,fire,impact,pierce
                            [filter_base_value]
                              greater_than=25
                              less_than_equal_to=50
                            [/filter_base_value]
                            affect_self=yes
                            active_on=defense
                          [/resistance]
                        [/abilities]
                      [/effect]
                    [/object]
                    {VARIABLE steadfast_$side_number yes}
                    {VARIABLE_OP abilities_$side_number add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
          [/message]
          [redraw]
          [/redraw]
        [/do]
      [/while]
      {CLEAR_VARIABLE sm}
      {CLEAR_VARIABLE sf}
      {CLEAR_VARIABLE fl}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SX_SHOP_ITEMS
  [option]
    message= _ {MENU_IMG_TXT "icons/potions+items-small.png" "~*<255,160,32>Potions & items"}
    [command]
      {VARIABLE finished_sub no}
      {VARIABLE black_potions 0}
      {VARIABLE blue_potions 0}
      {VARIABLE brown_potions 0}
      {VARIABLE cyan_potions 0}
      {VARIABLE grey_potions 0}
      {VARIABLE green_potions 0}
      {VARIABLE orange_potions 0}
      {VARIABLE pink_potions 0}
      {VARIABLE red_potions 0}
      {VARIABLE violet_potions 0}
      {VARIABLE white_potions 0}
      {VARIABLE yellow_potions 0}
      [while]
        {SX_CMP finished_sub equals no}
        [do]
          {VARIABLE potions_list ""}
          [if]
            {SX_CMP allow_shop_blackp equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<128,128,128>Black potions: $black_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_bluep equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<0,0,255>Blue potions: $blue_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_brownp equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<128,64,32>Brown potions: $brown_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_cyanp equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<0,255,255>Cyan potions: $cyan_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_greyp equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<192,192,192>Grey potions: $grey_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_greenp equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<0,255,0>Green potions: $green_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_orangep equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<255,160,32>Orange potions: $orange_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_pinkp equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<255,128,192>Pink potions: $pink_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_redp equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<255,0,0>Red potions: $red_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_violetp equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<160,0,224>Violet potions: $violet_potions_$side_number|| (max. 1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_whitep equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<255,255,255>White potions: $white_potions_$side_number|| (max.1) "}
            [/then]
          [/if]
          [if]
            {SX_CMP allow_shop_yellowp equals yes}
            [then]
              {VARIABLE potions_list "$potions_list|
<255,255,0>Yellow potions: $yellow_potions_$side_number|| (max 1) "}
            [/then]
          [/if]
          [store_gold]
            side=$side_number
            variable=gold
          [/store_gold]
          [message]
            speaker=narrator
            message= _ "~*<64,192,32>Potions & items
~Here you can buy various useful potions or items. To use potions,
~right-click on your unit and select potion from menu (inventory).
<225,225,25>Gold: $gold|$potions_list|
Total number of potions: $potions_total_$side_number|| of max. 4"}
            image="icons/potions+items.png"
            [option]
              message= _ {MENU_IMG_TXT "icons/done.png" "Done"}
              [command]
                {VARIABLE finished_sub yes}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-black-sell.png" "+100 gold: sell black potion"}
              [show_if]
                {SX_CMP black_potions_$side_number numerical_not_equals 0}
                {SX_CMP black_potions numerical_not_equals 0}
                {SX_CMP allow_shop_blackp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=100
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP black_potions_$side_number add -1}
                {VARIABLE_OP black_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-black-sell.png" "+80 gold: sell black potion"}
              [show_if]
                {SX_CMP black_potions_$side_number numerical_not_equals 0}
                {SX_CMP black_potions numerical_equals 0}
                {SX_CMP allow_shop_blackp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=80
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP black_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-black-buy.png" "100 gold: buy black potion (2x damage for 1 turn)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP black_potions_$side_number less_than 2}
                {SX_CMP allow_shop_blackp equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP black_potions_$side_number add 1}
                    {VARIABLE_OP black_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-blue-sell.png" "+100 gold: sell blue potion"}
              [show_if]
                {SX_CMP blue_potions_$side_number numerical_not_equals 0}
                {SX_CMP blue_potions numerical_not_equals 0}
                {SX_CMP allow_shop_bluep equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=100
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP blue_potions_$side_number add -1}
                {VARIABLE_OP blue_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-blue-sell.png" "+80 gold: sell blue potion"}
              [show_if]
                {SX_CMP blue_potions_$side_number numerical_not_equals 0}
                {SX_CMP blue_potions numerical_equals 0}
                {SX_CMP allow_shop_bluep equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=80
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP blue_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-blue-buy.png" "100 gold: buy blue potion (+5MP, extra attack, +150HP)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP blue_potions_$side_number less_than 2}
                {SX_CMP allow_shop_bluep equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP blue_potions_$side_number add 1}
                    {VARIABLE_OP blue_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-brown-sell.png" "+100 gold: sell brown potion"}
              [show_if]
                {SX_CMP brown_potions_$side_number numerical_not_equals 0}
                {SX_CMP brown_potions numerical_not_equals 0}
                {SX_CMP allow_shop_brownp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=100
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP brown_potions_$side_number add -1}
                {VARIABLE_OP brown_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-brown-sell.png" "+80 gold: sell brown potion"}
              [show_if]
                {SX_CMP brown_potions_$side_number numerical_not_equals 0}
                {SX_CMP brown_potions numerical_equals 0}
                {SX_CMP allow_shop_brownp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=80
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP brown_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-brown-buy.png" "100 gold: buy brown potion (+10% resistances for 1 turn)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP brown_potions_$side_number less_than 2}
                {SX_CMP allow_shop_brownp equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 100}
                  [then]
                    [gold]
                      amount=-100
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP brown_potions_$side_number add 1}
                    {VARIABLE_OP brown_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-cyan-sell.png" "+40 gold: sell cyan potion"}
              [show_if]
                {SX_CMP cyan_potions_$side_number numerical_not_equals 0}
                {SX_CMP cyan_potions numerical_not_equals 0}
                {SX_CMP allow_shop_cyanp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=40
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP cyan_potions_$side_number add -1}
                {VARIABLE_OP cyan_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-cyan-sell.png" "+32 gold: sell cyan potion"}
              [show_if]
                {SX_CMP cyan_potions_$side_number numerical_not_equals 0}
                {SX_CMP cyan_potions numerical_equals 0}
                {SX_CMP allow_shop_cyanp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=32
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP cyan_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-cyan-buy.png" "40 gold: buy cyan potion (+9MP, unslow)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP cyan_potions_$side_number less_than 2}
                {SX_CMP allow_shop_cyanp equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 40}
                  [then]
                    [gold]
                      amount=-40
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP cyan_potions_$side_number add 1}
                    {VARIABLE_OP cyan_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-grey-sell.png" "+0 gold: sell grey potion"}
              [show_if]
                {SX_CMP grey_potions_$side_number numerical_not_equals 0}
                {SX_CMP grey_potions numerical_not_equals 0}
                {SX_CMP allow_shop_greyp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP grey_potions_$side_number add -1}
                {VARIABLE_OP grey_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-grey-sell.png" "+0 gold: sell grey potion"}
              [show_if]
                {SX_CMP grey_potions_$side_number numerical_not_equals 0}
                {SX_CMP grey_potions numerical_equals 0}
                {SX_CMP allow_shop_greyp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP grey_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-grey-buy.png" "0 gold: buy grey potion (not defined yet)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP grey_potions_$side_number less_than 2}
                {SX_CMP allow_shop_greyp equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 0}
                  [then]
                    [gold]
                      amount=-0
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP grey_potions_$side_number add 1}
                    {VARIABLE_OP grey_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-green-sell.png" "+60 gold: sell green potion"}
              [show_if]
                {SX_CMP green_potions_$side_number numerical_not_equals 0}
                {SX_CMP green_potions numerical_not_equals 0}
                {SX_CMP allow_shop_greenp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=60
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP green_potions_$side_number add -1}
                {VARIABLE_OP green_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-green-sell.png" "+48 gold: sell green potion"}
              [show_if]
                {SX_CMP green_potions_$side_number numerical_not_equals 0}
                {SX_CMP green_potions numerical_equals 0}
                {SX_CMP allow_shop_greenp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=48
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP green_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-green-buy.png" "60 gold: buy green potion (extra attack, +100HP, heal slow & poison)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP green_potions_$side_number less_than 2}
                {SX_CMP allow_shop_greenp equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 60}
                  [then]
                    [gold]
                      amount=-60
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP green_potions_$side_number add 1}
                    {VARIABLE_OP green_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-orange-sell.png" "+50 gold: sell orange potion"}
              [show_if]
                {SX_CMP orange_potions_$side_number numerical_not_equals 0}
                {SX_CMP orange_potions numerical_not_equals 0}
                {SX_CMP allow_shop_orangep equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=50
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP orange_potions_$side_number add -1}
                {VARIABLE_OP orange_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-orange-sell.png" "+40 gold: sell orange potion"}
              [show_if]
                {SX_CMP orange_potions_$side_number numerical_not_equals 0}
                {SX_CMP orange_potions numerical_equals 0}
                {SX_CMP allow_shop_orangep equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=40
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP orange_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-orange-buy.png" "50 gold: buy orange potion (skirmish ability for 1 turn)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP orange_potions_$side_number less_than 2}
                {SX_CMP allow_shop_orangep equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 50}
                  [then]
                    [gold]
                      amount=-50
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP orange_potions_$side_number add 1}
                    {VARIABLE_OP orange_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-pink-sell.png" "+50 gold: sell pink potion"}
              [show_if]
                {SX_CMP pink_potions_$side_number numerical_not_equals 0}
                {SX_CMP pink_potions numerical_not_equals 0}
                {SX_CMP allow_shop_pinkp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=50
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP pink_potions_$side_number add -1}
                {VARIABLE_OP pink_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-pink-sell.png" "+40 gold: sell pink potion"}
              [show_if]
                {SX_CMP pink_potions_$side_number numerical_not_equals 0}
                {SX_CMP pink_potions numerical_equals 0}
                {SX_CMP allow_shop_pinkp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=40
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP pink_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-pink-buy.png" "50 gold: buy pink potion (flying for 1 turn)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP pink_potions_$side_number less_than 2}
                {SX_CMP allow_shop_pinkp equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 50}
                  [then]
                    [gold]
                      amount=-50
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP pink_potions_$side_number add 1}
                    {VARIABLE_OP pink_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-red-sell.png" "+50 gold: sell red potion"}
              [show_if]
                {SX_CMP red_potions_$side_number numerical_not_equals 0}
                {SX_CMP red_potions numerical_not_equals 0}
                {SX_CMP allow_shop_redp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=50
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP red_potions_$side_number add -1}
                {VARIABLE_OP red_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-red-sell.png" "+40 gold: sell red potion"}
              [show_if]
                {SX_CMP red_potions_$side_number numerical_not_equals 0}
                {SX_CMP red_potions numerical_equals 0}
                {SX_CMP allow_shop_redp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=40
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP red_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-red-buy.png" "50 gold: buy red potion (full HP, heal slow & poison)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP red_potions_$side_number less_than 2}
                {SX_CMP allow_shop_redp equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 50}
                  [then]
                    [gold]
                      amount=-50
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP red_potions_$side_number add 1}
                    {VARIABLE_OP red_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-violet-sell.png" "+0 gold: sell violet potion"}
              [show_if]
                {SX_CMP violet_potions_$side_number numerical_not_equals 0}
                {SX_CMP violet_potions numerical_not_equals 0}
                {SX_CMP allow_shop_violetp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP violet_potions_$side_number add -1}
                {VARIABLE_OP violet_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-violet-sell.png" "+0 gold: sell violet potion"}
              [show_if]
                {SX_CMP violet_potions_$side_number numerical_not_equals 0}
                {SX_CMP violet_potions numerical_equals 0}
                {SX_CMP allow_shop_violetp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP violet_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-violet-buy.png" "0 gold: buy violet potion (not defined yet)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP violet_potions_$side_number less_than 2}
                {SX_CMP allow_shop_violetp equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 0}
                  [then]
                    [gold]
                      amount=-0
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP violet_potions_$side_number add 1}
                    {VARIABLE_OP violet_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-white-sell.png" "+0 gold: sell white potion"}
              [show_if]
                {SX_CMP white_potions_$side_number numerical_not_equals 0}
                {SX_CMP white_potions numerical_not_equals 0}
                {SX_CMP allow_shop_whitep equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP white_potions_$side_number add -1}
                {VARIABLE_OP white_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-white-sell.png" "+0 gold: sell white potion"}
              [show_if]
                {SX_CMP white_potions_$side_number numerical_not_equals 0}
                {SX_CMP white_potions numerical_equals 0}
                {SX_CMP allow_shop_whitep equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=0
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP white_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-white-buy.png" "0 gold: buy white potion (not defined yet)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP white_potions_$side_number less_than 2}
                {SX_CMP allow_shop_whitep equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 0}
                  [then]
                    [gold]
                      amount=-0
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP white_potions_$side_number add 1}
                    {VARIABLE_OP white_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-yellow-sell.png" "+125 gold: sell yellow potion"}
              [show_if]
                {SX_CMP yellow_potions_$side_number numerical_not_equals 0}
                {SX_CMP yellow_potions numerical_not_equals 0}
                {SX_CMP allow_shop_yellowp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=125
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP yellow_potions_$side_number add -1}
                {VARIABLE_OP yellow_potions add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-yellow-sell.png" "+100 gold: sell yellow potion"}
              [show_if]
                {SX_CMP yellow_potions_$side_number numerical_not_equals 0}
                {SX_CMP yellow_potions numerical_equals 0}
                {SX_CMP allow_shop_yellowp equals yes}
              [/show_if]
              [command]
                [gold]
                  amount=100
                  side=$side_number
                [/gold]
                {VARIABLE_OP potions_total_$side_number add -1}
                {VARIABLE_OP yellow_potions_$side_number add -1}
              [/command]
            [/option]
            [option]
              message= _ {MENU_IMG_TXT "icons/potion-yellow-buy.png" "125 gold: buy yellow potion (+20HP, full HP, heal slow & poison, 2x HP)"}
              [show_if]
                {SX_CMP potions_total_$side_number less_than 4}
                {SX_CMP yellow_potions_$side_number less_than 2}
                {SX_CMP allow_shop_yellowp equals yes}
              [/show_if]
              [command]
                [if]
                  {SX_CMP gold  greater_than_equal_to 125}
                  [then]
                    [gold]
                      amount=-125
                      side=$side_number
                    [/gold]
                    {VARIABLE_OP potions_total_$side_number add 1}
                    {VARIABLE_OP yellow_potions_$side_number add 1}
                    {VARIABLE_OP yellow_potions add 1}
                  [/then]
                [/if]
              [/command]
            [/option]
          [/message]
          [redraw]
          [/redraw]
          {CLEAR_VARIABLE potions_list}
        [/do]
      [/while]
      {CLEAR_VARIABLE black_potions}
      {CLEAR_VARIABLE blue_potions}
      {CLEAR_VARIABLE brown_potions}
      {CLEAR_VARIABLE cyan_potions}
      {CLEAR_VARIABLE grey_potions}
      {CLEAR_VARIABLE green_potions}
      {CLEAR_VARIABLE orange_potions}
      {CLEAR_VARIABLE pink_potions}
      {CLEAR_VARIABLE red_potions}
      {CLEAR_VARIABLE violet_potions}
      {CLEAR_VARIABLE white_potions}
      {CLEAR_VARIABLE yellow_potions}
      {CLEAR_VARIABLE finished_sub}
    [/command]
  [/option]
#enddef

#define SX_IDENTIFY_SPECIALS VAR INDEX
  {VARIABLE specials_count_{INDEX} 0}
  {VARIABLE specials_price_{INDEX} 0}
  {FOREACH {VAR} specials_i}
    {SX_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].attacks {INDEX}}
    {SX_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].berserk {INDEX}}
    {SX_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].chance_to_hit {INDEX}}
    {SX_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].damage {INDEX}}
    {SX_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].dummy {INDEX}}
    {SX_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].drains {INDEX}}
    {SX_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].firststrike {INDEX}}
    {SX_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].poison {INDEX}}
    {SX_IDENTIFY_SPECIALS_ID {VAR}[$specials_i|].slow {INDEX}}
  {NEXT specials_i}
  [set_variable]
    name=specials_list_{INDEX}
    [join]
      variable=specials_array_{INDEX}
      key=name
      separator=,
    [/join]
  [/set_variable]
  [if]
    {SX_CMP specials_array_{INDEX}.length greater_than 0}
    [then]
      {VARIABLE specials_list_{INDEX} " ($specials_list_{INDEX}|)"}
    [/then]
    [else]
      {VARIABLE specials_list_{INDEX} " "}
    [/else]
  [/if]
#enddef

#define SX_IDENTIFY_SPECIALS_ID VAR INDEX
  {FOREACH {VAR} specials_j}
    {VARIABLE duplicated no}
    {FOREACH specials_array_{INDEX} spec_dupl}
      [if]
        {SX_CMP {VAR}[$specials_j|].id equals $specials_array_{INDEX}[$spec_dupl|].id}
        [then]
          {VARIABLE duplicated yes}
          [if]
            {SX_CMP specials_array_{INDEX}[$spec_dupl|].name equals $null}
            [then]
              {VARIABLE specials_array_{INDEX}[$spec_dupl|].name ${VAR}[$specials_j|].name}
            [/then]
          [/if]
        [/then]
      [/if]
    {NEXT spec_dupl}
    [if]
      {SX_CMP duplicated equals no}
      [then]
        {VARIABLE specials_array_{INDEX}[$specials_count_{INDEX}|].id ${VAR}[$specials_j|].id}
        {VARIABLE specials_array_{INDEX}[$specials_count_{INDEX}|].name ${VAR}[$specials_j|].name}
        {VARIABLE price 0}
        {SX_IFSPEC {VAR}[$specials_j|].id absorb 200}
        {SX_IFSPEC {VAR}[$specials_j|].id absorb 200}
        {SX_IFSPEC {VAR}[$specials_j|].id arson 30}
        {SX_IFSPEC {VAR}[$specials_j|].id attack_only 20}
        {SX_IFSPEC {VAR}[$specials_j|].id backstab 24}
        {SX_IFSPEC {VAR}[$specials_j|].id berserk 180}
        {SX_IFSPEC {VAR}[$specials_j|].id berserk2 180}
        {SX_IFSPEC {VAR}[$specials_j|].id blind 1}
        {SX_IFSPEC {VAR}[$specials_j|].id charge 36}
        {SX_IFSPEC {VAR}[$specials_j|].id charm 40}
        {SX_IFSPEC {VAR}[$specials_j|].id circle 80}
        {SX_IFSPEC {VAR}[$specials_j|].id cleave 5}
        {SX_IFSPEC {VAR}[$specials_j|].id concentrated 250}
        {SX_IFSPEC {VAR}[$specials_j|].id counter 30}
        {SX_IFSPEC {VAR}[$specials_j|].id defend_only 10}
        {SX_IFSPEC {VAR}[$specials_j|].id drains 200}
        {SX_IFSPEC {VAR}[$specials_j|].id dread 40}
        {SX_IFSPEC {VAR}[$specials_j|].id evade 36}
        {SX_IFSPEC {VAR}[$specials_j|].id evasion 40}
        {SX_IFSPEC {VAR}[$specials_j|].id ferocious 40}
        {SX_IFSPEC {VAR}[$specials_j|].id firststrike 5}
        {SX_IFSPEC {VAR}[$specials_j|].id focus 90}
        {SX_IFSPEC {VAR}[$specials_j|].id guided 20}
        {SX_IFSPEC {VAR}[$specials_j|].id highground 10}
        {SX_IFSPEC {VAR}[$specials_j|].id magical 50}
        {SX_IFSPEC {VAR}[$specials_j|].id marksman 42}
        {SX_IFSPEC {VAR}[$specials_j|].id massivestrike 15}
        {SX_IFSPEC {VAR}[$specials_j|].id nocounter 80}
        {SX_IFSPEC {VAR}[$specials_j|].id poison 10}
        {SX_IFSPEC {VAR}[$specials_j|].id precision 72}
        {SX_IFSPEC {VAR}[$specials_j|].id rage 90}
        {SX_IFSPEC {VAR}[$specials_j|].id rage2 60}
        {SX_IFSPEC {VAR}[$specials_j|].id rage3 90}
        {SX_IFSPEC {VAR}[$specials_j|].id recieve 5}
        {SX_IFSPEC {VAR}[$specials_j|].id return 10}
        {SX_IFSPEC {VAR}[$specials_j|].id slow 36}
        {SX_IFSPEC {VAR}[$specials_j|].id spread 5}
        {SX_IFSPEC {VAR}[$specials_j|].id triplestrike 10}
        {SX_IFSPEC {VAR}[$specials_j|].id udbane 10}
        {VARIABLE specials_array_{INDEX}[$specials_count_{INDEX}|].price $price}
        {VARIABLE_OP specials_price_{INDEX} add $price}
        {VARIABLE_OP specials_count_{INDEX} add 1}
        {CLEAR_VARIABLE price}
      [/then]
    [/if]
  {NEXT specials_j}
#enddef

#define SX_IFSPEC ID REF VALUE
  [if]
    {SX_CMP {ID} equals {REF}}
    [then]
      {VARIABLE price {VALUE}}
    [/then]
  [/if]
#enddef

#define SX_BUY_WEAPON ICON NAME ID RNG TYPE DMG STR IMAGE HITS MISSES
  [option]
    [show_if]
      {SX_CMP weapon_j less_than 8}
      {SX_CMP hide_{RNG}_$side_number equals no}
    [/show_if]
    message= _ {MENU_IMG_TXT {ICON} "40 gold: buy {NAME}: {RNG} {TYPE} {DMG} - {STR}"}
    [command]
      [if]
        {SX_CMP gold greater_than_equal_to 40}
        [then]
          {VARIABLE damage {DMG}}
          {VARIABLE_OP damage add ${RNG}_damage_$side_number||}
          {VARIABLE strikes {STR}}
          {VARIABLE_OP strikes add ${RNG}_strikes_$side_number||}
          [object]
            silent=yes
            duration=forever
            [effect]
              apply_to=new_attack
              name="sxc_{ID}_$weapons_index|"
              description=_ "{NAME}"
              damage=$damage
              number=$strikes
              range={RNG}
              type={TYPE}
              icon={IMAGE}
            [/effect]
            [effect]
              apply_to=new_animation
              [attack_anim]
                [attack_filter]
                  name="sxc_{ID}_$weapons_index|"
                [/attack_filter]
                [frame]
                  begin=-200
                  end=-150
                [/frame]
                [if]
                  hits=yes
                  [frame]
                    begin=-150
                    end=100
                    sound={HITS}
                  [/frame]
                [/if]
                [else]
                  hits=no
                  [frame]
                    begin=-150
                    end=100
                    sound={MISSES}
                  [/frame]
                [/else]
                [frame]
                  begin=100
                  end=200
                [/frame]
              [/attack_anim]
            [/effect]
          [/object]
          {VARIABLE weapons_bought "$weapons_bought|sxc_{ID}_$weapons_index|,"}
          {VARIABLE_OP weapons_index add 1}
          [gold]
            side=$side_number
            amount=-40
          [/gold]
          {CLEAR_VARIABLE damage}
          {CLEAR_VARIABLE strikes}
        [/then]
      [/if]
    [/command]
  [/option]
#enddef

#define SX_SELL_WEAPON INDEX
  [option]
    [show_if]
      {SX_CMP weapon_j greater_than {INDEX}}
      {SX_CMP hide_$range_{INDEX}|_$side_number equals no}
      [and]
        {SX_CMP maximum_level_reached_$side_number equals "yes"}
        [or]
          {SX_CMP name_{INDEX} contains "sxc_"}
        [/or]
      [/and]
    [/show_if]
    message= _ {MENU_IMG_TXT "icons/weapon-sell.png" $sell_text_{INDEX}}
    [command]
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=remove_attacks
          name=$name_{INDEX}
          type=$type_{INDEX}
          range=$range_{INDEX}
        [/effect]
      [/object]
      [gold]
        side=$side_number
        amount=$price_{INDEX}
      [/gold]
    [/command]
  [/option]
#enddef

#define SX_SHOP_SPECIALS_SET INDEX
  [option]
    [show_if]
      {SX_CMP weapon_j greater_than {INDEX}}
      {SX_CMP hide_$range_{INDEX}|_$side_number equals no}
      [and]
        {SX_CMP maximum_level_reached_$side_number equals "yes"}
        [or]
          {SX_CMP name_{INDEX} contains "sxc_"}
        [/or]
      [/and]
    [/show_if]
    message= _ {MENU_IMG_TXT "icons/special-weapon-select.png" $select_text_{INDEX}}
    [command]
      [message]
        speaker=narrator
        message= _ "Select special to remove and sell or buy new
for the weapon you just selected. If you have
already 1 special attached, the price will go
up 50% against normal prices. If you have 2 or
more specials, then you can only remove and
sell them. Sell price is 60% of normal price."
        image="icons/specials.png"
        [option]
          message= _ {MENU_IMG_TXT "icons/no-changes.png" "No changes"}
          [command]
          [/command]
        [/option]
        {SX_REMOVE_SPECIAL {INDEX} 0}
        {SX_REMOVE_SPECIAL {INDEX} 1}
        {SX_REMOVE_SPECIAL {INDEX} 2}
        {SX_REMOVE_SPECIAL {INDEX} 3}
        {SX_REMOVE_SPECIAL {INDEX} 4}
        {SX_REMOVE_SPECIAL {INDEX} 5}
        {SX_REMOVE_SPECIAL {INDEX} 6}
        {SX_REMOVE_SPECIAL {INDEX} 7}
        {SX_ADD_FIRST_SPECIAL {INDEX} backstab BACKSTAB 40 (`Doubles damage when unit attacks from opposite side of enemy.)}
        {SX_ADD_FIRST_SPECIAL {INDEX} berserk SXC_BERSERK 300 (`Presses engagement until death of one combatant or 30 rounds
`of attacks occurred. This special is only active on offense.)}
        {SX_ADD_FIRST_SPECIAL {INDEX} charge CHARGE 60 (`While used offensive, it doubles damage for both combatants.)}
        {SX_ADD_FIRST_SPECIAL {INDEX} evade SXC_EVADE 60 (`Unit takes one third less damage while using this weapon.)}
        {SX_ADD_FIRST_SPECIAL {INDEX} focus SXC_FOCUS 150 (`Attack has 70% chance to hit and does 50% more
`damage to both combatants while used offensively.)}
        {SX_ADD_FIRST_SPECIAL {INDEX} magical MAGICAL 90 (`Attack has always 70% chance to hit.)}
        {SX_ADD_FIRST_SPECIAL {INDEX} marksman MARKSMAN 70 (`Attack has 60% chance to hit while used offensively.)}
        {SX_ADD_FIRST_SPECIAL {INDEX} precision SXC_PRECISION 120 (`This attack always has 80% chance of hit.)}
        {SX_ADD_FIRST_SPECIAL {INDEX} rage SXC_RAGE 150 (`Presses engagement until 3 rounds of attacks occured
`or until one of combatants is slain.)}
        {SX_ADD_FIRST_SPECIAL {INDEX} slow SLOW 60 (`Opponent will be slowed until end of turn
`while this attack hits it's target.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} backstab BACKSTAB 60 (`Doubles damage when unit attacks from opposite side of enemy.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} berserk SXC_BERSERK 450 (`Presses engagement until death of one combatant or 30 rounds
`of attacks occurred. This special is only active on offense.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} charge CHARGE 90 (`While used offensive, it doubles damage for both combatants.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} evade SXC_EVADE 90 (`Unit takes one third less damage while using this weapon.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} focus SXC_FOCUS 225 (`Attack has 70% chance to hit and does 50% more
`damage to both combatants while used offensively.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} magical MAGICAL 145 (`Attack has always 70% chance to hit.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} marksman MARKSMAN 105 (`Attack has 60% chance to hit while used offensively.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} precision SXC_PRECISION 180 (`This attack always has 80% chance of hit.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} rage SXC_RAGE 225 (`Presses engagement until 3 rounds of attacks occured
`or until one of combatants is slain.)}
        {SX_ADD_SECOND_SPECIAL {INDEX} slow SLOW 90 (`Opponent will be slowed until end of turn
`while this attack hits it's target.)}
      [/message]
      [redraw]
      [/redraw]
    [/command]
  [/option]
#enddef

#define SX_REMOVE_SPECIAL INDEX INDEX2
  [option]
    [show_if]
      {SX_CMP specials_count_{INDEX} greater_than {INDEX2}}
    [/show_if]
    message= _ {MENU_IMG_TXT "icons/weapon-sell.png" "#+$specials_array_{INDEX}[{INDEX2}].price| gold: remove $specials_array_{INDEX}[{INDEX2}].name|"}
    [command]
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=attack
          name=$name_{INDEX}
          type=$type_{INDEX}
          range=$range_{INDEX}
          remove_specials=$specials_array_{INDEX}[{INDEX2}].id
        [/effect]
      [/object]
      [gold]
        amount=$specials_array_{INDEX}[{INDEX2}].price
        side=$side_number
      [/gold]
    [/command]
  [/option]
#enddef

#define SX_ARMORY_TYPE TYPE
  [option]
    [show_if]
      {SX_CMP {TYPE}_session greater_than 0}
      {SX_CMP {TYPE}_extra numerical_equals 0}
    [/show_if]
    message= _ {MENU_IMG_TXT "icons/{TYPE}-sell.png" "+8 gold: sell 5% of {TYPE} resistance"}
    [command]
      [gold]
        amount=8
        side=$side_number
      [/gold]
      {VARIABLE_OP {TYPE}_session add -5}
      {SX_SET_RESISTANCE {TYPE} 5}
    [/command]
  [/option]
  [option]
    [show_if]
      {SX_CMP {TYPE}_extra greater_than 0}
      [or]
        {SX_CMP current_{TYPE} greater_than_equal_to 100}
      [/or]
    [/show_if]
    message= _ {MENU_IMG_TXT "icons/{TYPE}-sell.png" "+15 gold: sell 5% of EXTRA {TYPE} resistance"}
    [command]
      [gold]
        amount=15
        side=$side_number
      [/gold]
      {VARIABLE_OP {TYPE}_session add -5}
      {VARIABLE_OP {TYPE}_extra add -5}
      {VARIABLE_OP extra_armor_bought_$side_number add -5}
      {SX_SET_RESISTANCE {TYPE} 5}
    [/command]
  [/option]
  [option]
    [show_if]
      {SX_CMP armor_limit_$side_number greater_than $current_{TYPE}}
    [/show_if]
    message= _ {MENU_IMG_TXT "icons/{TYPE}-buy.png" "8 gold: buy +5% {TYPE} resistance"}
    [command]
      [if]
        {SX_CMP gold greater_than_equal_to 8}
        [then]
          [gold]
            amount=-8
            side=$side_number
          [/gold]
          {VARIABLE_OP {TYPE}_session add 5}
          {SX_SET_RESISTANCE {TYPE} -5}
        [/then]
      [/if]
    [/command]
  [/option]
  [option]
    [show_if]
      {SX_CMP armor_limit_$side_number less_than_equal_to $current_{TYPE}}
      {SX_CMP current_{TYPE} less_than_equal_to 95}
      {SX_CMP armor_total_$side_number greater_than $extra}
    [/show_if]
    message= _ {MENU_IMG_TXT "icons/{TYPE}-buy.png" "15 gold: buy +5% EXTRA {TYPE} resistance"}
    [command]
      [if]
        {SX_CMP gold greater_than_equal_to 15}
        [then]
          [gold]
            amount=-15
            side=$side_number
          [/gold]
          {VARIABLE_OP {TYPE}_session add 5}
          {VARIABLE_OP {TYPE}_extra add 5}
          {VARIABLE_OP extra_armor_bought_$side_number add 5}
          {SX_SET_RESISTANCE {TYPE} -5}
        [/then]
      [/if]
    [/command]
  [/option]
#enddef

#define SX_SET_RESISTANCE TYPE AMOUNT
  [object]
    silent=yes
    duration=forever
    [effect]
      apply_to=resistance
      replace=no
      [resistance]
        {TYPE}={AMOUNT}
      [/resistance]
    [/effect]
  [/object]
#enddef

#define SX_TRAINING_CHECK TRAINVAR
  [if]
    {SX_CMP {TRAINVAR}_$side_number numerical_equals 1}
    [then]
      {VARIABLE {TRAINVAR} "trained"}
    [/then]
    [else]
      {VARIABLE {TRAINVAR} "           "}
    [/else]
  [/if]
#enddef

#define SX_ADD_FIRST_SPECIAL INDEX ID ID2 PRICE DESCRIPTION
  [option]
    [show_if]
      {SX_CMP specials_count_{INDEX} numerical_equals 0}
      {SX_CMP $range_{INDEX}|_specials contains {ID}}
    [/show_if]
    message= _ {MENU_IMG_TXT "icons/add-special-{ID}.png" "@{PRICE} gold: add {ID} to $description_{INDEX}
{DESCRIPTION}"}
    [command]
      [if]
        {SX_CMP gold greater_than_equal_to {PRICE}}
        [then]
          [gold]
            amount=-{PRICE}
            side=$side_number
          [/gold]
          [object]
            silent=yes
            duration=forever
            [effect]
              apply_to=attack
              name=$name_{INDEX}
              type=$type_{INDEX}
              range=$range_{INDEX}
              [set_specials]
                {WEAPON_SPECIAL_{ID2}}
              [/set_specials]
            [/effect]
          [/object]
        [/then]
      [/if]
    [/command]
  [/option]
#enddef

#define SX_ADD_SECOND_SPECIAL INDEX ID ID2 PRICE DESCRIPTION
  [option]
    [show_if]
      {SX_CMP specials_count_{INDEX} numerical_equals 1}
      {SX_CMP $range_{INDEX}|_specials contains {ID}}
      {SX_CMP {ID}_combinations contains ",$specials_array_{INDEX}[0].id,"}
    [/show_if]
    message= _ {MENU_IMG_TXT "icons/add-special-{ID}.png" "@{PRICE} gold: add {ID} to $description_{INDEX}
{DESCRIPTION}"}
    [command]
      [if]
        {SX_CMP gold greater_than_equal_to {PRICE}}
        [then]
          [gold]
            amount=-{PRICE}
            side=$side_number
          [/gold]
          [object]
            silent=yes
            duration=forever
            [effect]
              apply_to=attack
              name=$name_{INDEX}
              type=$type_{INDEX}
              range=$range_{INDEX}
              [set_specials]
                mode=append
                {WEAPON_SPECIAL_{ID2}}
              [/set_specials]
            [/effect]
          [/object]
        [/then]
      [/if]
    [/command]
  [/option]
#enddef

#define WEAPON_SPECIAL_SXC_BERSERK
  [berserk]
    id=berserk2
    name= _ "berserk"
    description= _ "Berserk:
This attack special presses the engagement until one of the combatants is slain, or 30 rounds of attacks have occurred. This weapon special isn't activated on defense"
    value=30
    active_on=offense
  [/berserk]
#enddef

#define WEAPON_SPECIAL_SXC_EVADE
  [damage]
    id=evade
    name= _ "evade"
    name_inactive= _ "evade"
    description= _ "Evade:
This unit can evade enemy attack and takes one third less damage while using this weapon."
    description_inactive= _ "Evade:
This unit can evade enemy attack and takes one third less damage while using this weapon."
    multiply=0.66
    apply_to=opponent
  [/damage]
#enddef

#define WEAPON_SPECIAL_SXC_FOCUS
  [damage]
    id=focus
    name= _ "focus"
    description= _ "Focus:
When used offensively, this attack always has a 70% chance to hit and causes both the attacker and the defender to do 50% more damage than usual. This weapon special isn't activiated on defense."
    multiply=1.5
    apply_to=both
    active_on=offense
  [/damage]
  [chance_to_hit]
    id=focus
    value=70
    cumulative=no
    active_on=offense
  [/chance_to_hit]
#enddef

#define WEAPON_SPECIAL_SXC_PRECISION
  [chance_to_hit]
    id=precision
    name= _ "precision"
    description= _ "Precision:
This attack has always 80% chance to hit."
    value=80
    cumulative=no
  [/chance_to_hit]
#enddef

#define WEAPON_SPECIAL_SXC_RAGE
  [berserk]
    id=rage
    name= _ "rage"
    description= _ "Rage:
This attack special presses the engagement until one of the combatants is slain, or 3 rounds of attacks have occurred. This weapon special isn't activated on defense"
    value=3
    active_on=offense
  [/berserk]
#enddef

#define SX_ITEM_EVENT
  [event]
    name=moveto
    first_time_only=no
    [filter]
      side=1,2,3,4,5
      canrecruit=yes
    [/filter]
    {VARIABLE item_found no}
    {VARIABLE item_index -1}
    {FOREACH item i}
      [if]
        {SX_CMP item[$i|].x numerical_equals $x1}
        {SX_CMP item[$i|].y numerical_equals $y1}
        {SX_CMP item[$i|].used numerical_equals 0}
        [then]
          [if]
            {SX_CMP item[$i|].type contains "CHEST_GOLD"}
            [then]
              {VARIABLE item_found yes}
              {VARIABLE item_index $i}
              [fire_event]
                name=chest_gold_found
                [primary_unit]
                  x,y=$x1,$y1
                [/primary_unit]
              [/fire_event]
            [/then]
          [/if]
          [if]
            {SX_CMP item[$i|].type equals "DEFRING"}
            [then]
              {VARIABLE item_found yes}
              {VARIABLE item_index $i}
              [fire_event]
                name=defring_found
                [primary_unit]
                  x,y=$x1,$y1
                [/primary_unit]
              [/fire_event]
            [/then]
          [/if]
          [if]
            {SX_CMP item[$i|].type equals "RESRING"}
            [then]
              {VARIABLE item_found yes}
              {VARIABLE item_index $i}
              [fire_event]
                name=resring_found
                [primary_unit]
                  x,y=$x1,$y1
                [/primary_unit]
              [/fire_event]
            [/then]
          [/if]
          [if]
            {SX_CMP item[$i|].type equals "BLUE_POTION"}
            [then]
              {VARIABLE item_found yes}
              {VARIABLE item_index $i}
              [fire_event]
                name=blue_potion_found
                [primary_unit]
                  x,y=$x1,$y1
                [/primary_unit]
              [/fire_event]
            [/then]
          [/if]
          [if]
            {SX_CMP item[$i|].type equals "CYAN_POTION"}
            [then]
              {VARIABLE item_found yes}
              {VARIABLE item_index $i}
              [fire_event]
                name=cyan_potion_found
                [primary_unit]
                  x,y=$x1,$y1
                [/primary_unit]
              [/fire_event]
            [/then]
          [/if]
          [if]
            {SX_CMP item[$i|].type equals "RED_POTION"}
            [then]
              {VARIABLE item_found yes}
              {VARIABLE item_index $i}
              [fire_event]
                name=red_potion_found
                [primary_unit]
                  x,y=$x1,$y1
                [/primary_unit]
              [/fire_event]
            [/then]
          [/if]
          [if]
            {SX_CMP item[$i|].type equals "YELLOW_POTION"}
            [then]
              {VARIABLE item_found yes}
              {VARIABLE item_index $i}
              [fire_event]
                name=yellow_potion_found
                [primary_unit]
                  x,y=$x1,$y1
                [/primary_unit]
              [/fire_event]
            [/then]
          [/if]
        [/then]
      [/if]
    {NEXT i}
    [if]
      {SX_CMP item_found equals no}
      [then]
        [allow_undo]
        [/allow_undo]
      [/then]
    [/if]
    {CLEAR_VARIABLE item_found}
    {CLEAR_VARIABLE item_index}
  [/event]

  {SX_CHEST_GOLD_EVENT}
  {SX_DEFRING_EVENT}
  {SX_RESRING_EVENT}
  {SX_BLUE_POTION_EVENT}
  {SX_CYAN_POTION_EVENT}
  {SX_RED_POTION_EVENT}
  {SX_YELLOW_POTION_EVENT}
#enddef

#define SX_DEFRING X Y
  {SX_ITEM {X} {Y} "DEFRING" "items/ring-gold.png" ""}
#enddef

#define SX_DEFRING_EVENT
  [event]
    name=defring_found
    first_time_only=no
    [message]
      image=items/ring-gold.png
      speaker=narrator
      message= _ "You found a glowing little ring...
This magical ring can help you to avoid your enemies' attacks.
It increases owner's defenses for all terrains by 10%.
You can have maximum of 2 gold rings at a time.
Currently you have $defring_$side_number||"
      [option]
        message= _ "I'll leave it for another player"
        [command]
        [/command]
      [/option]
      [option]
        [show_if]
          {SX_CMP defring_$side_number less_than 2}
        [/show_if]
        message= _ "Take and use gold ring of defense"
        [command]
          [sound]
            name=magic-holy-1.ogg
          [/sound]
          [print]
            text= _ "Player $side_number| found gold ring of defense."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          [object]
            silent=yes
            duration=forever
            [effect]
              apply_to=defense
              replace=no
              [defense]
                castle=-10
                cave=-10
                deep_water=-10
                flat=-10
                forest=-10
                frozen=-10
                fungus=-10
                hills=-10
                impassable=-10
                mountains=-10
                reef=-10
                sand=-10
                shallow_water=-10
                swamp_water=-10
                unwalkable=-10
                village=-10
              [/defense]
            [/effect]
          [/object]
          {VARIABLE_OP defring_$side_number add 1}
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
    [/message]
  [/event]
#enddef

#define SX_DROP_DEFRING
  [option]
    message= _ {MENU_IMG_TXT "icons/ring-gold.png" "Drop gold ring of defense (you have $defring_$side_number||)"}
    [show_if]
      {SX_CMP defring_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      {SX_DEFRING $x1 $y1}
      [print]
        text= _ "Player $side_number| dropped gold ring of defense."
        size=18
        duration=500
        red,green,blue=255,255,0
      [/print]
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=defense
          replace=no
          [defense]
            castle=10
            cave=10
            deep_water=10
            flat=10
            forest=10
            frozen=10
            fungus=10
            hills=10
            impassable=10
            mountains=10
            reef=10
            sand=10
            shallow_water=10
            swamp_water=10
            unwalkable=10
            village=10
          [/defense]
        [/effect]
      [/object]
      {VARIABLE_OP defring_$side_number add -1}
    [/command]
  [/option]
#enddef

#define SX_RESRING X Y
  {SX_ITEM {X} {Y} "RESRING" "items/ring-white.png" ""}
#enddef

#define SX_RESRING_EVENT
  [event]
    name=resring_found
    first_time_only=no
    [message]
      image=items/ring-white.png
      speaker=narrator
      message= _ "You found a glowing little ring...
This magical ring can increase your resistances by 10%
You can have maximum of 2 silver rings at a time.
Currently you have $resring_$side_number||"
      [option]
        message= _ "I'll leave it for another player"
        [command]
        [/command]
      [/option]
      [option]
        [show_if]
          {SX_CMP resring_$side_number less_than 2}
        [/show_if]
        message= _ "Take and use silver ring of resistance"
        [command]
          [sound]
            name=magic-holy-1.ogg
          [/sound]
          [print]
            text= _ "Player $side_number| found silver ring of resistance."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          [object]
            silent=yes
            duration=forever
            [effect]
              apply_to=resistance
              replace=no
              [resistance]
                arcane=-10
                blade=-10
                cold=-10
                fire=-10
                impact=-10
                pierce=-10
              [/resistance]
            [/effect]
          [/object]
          {VARIABLE_OP resring_$side_number add 1}
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
    [/message]
  [/event]
#enddef

#define SX_DROP_RESRING
  [option]
    message= _ {MENU_IMG_TXT "icons/ring-white.png" "Drop silver ring of resistance (you have $resring_$side_number||)"}
    [show_if]
      {SX_CMP resring_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      {SX_RESRING $x1 $y1}
      [print]
        text= _ "Player $side_number| dropped silver ring of resistance."
        size=18
        duration=500
        red,green,blue=255,255,0
      [/print]
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            arcane=10
            blade=10
            cold=10
            fire=10
            impact=10
            pierce=10
          [/resistance]
        [/effect]
      [/object]
      {VARIABLE_OP resring_$side_number add -1}
    [/command]
  [/option]
#enddef

#define SX_YELLOW_POTION X Y
  {SX_ITEM {X} {Y} "YELLOW_POTION" "items/potion-yellow.png" ""}
#enddef

#define SX_YELLOW_POTION_EVENT
  [event]
    name=yellow_potion_found
    first_time_only=no
    [message]
      image=items/potion-yellow.png
      speaker=narrator
      message= _ "You found a strange yellow potion. Drinking it will make you feel more healthy.
Your max. HP will be increased by 20 and your current HP will be doubled!
You can carry maximum of 4 potions of different types and 2 potions of same
type at a time. Currently you are carrying:
<255,255,0>Yellow potions: $yellow_potions_$side_number||
Total number: $potions_total_$side_number||
For using one of yellow potions, that you are carrying, right-click on your
hero, select View inventory... and then select 'Drink yellow potion'."
      [option]
        message= _ "I'll leave it for another player"
        [command]
        [/command]
      [/option]
      [option]
        message= _ "Take and use yellow potion"
        [command]
          [print]
            text= _ "Player $side_number| found and used yellow potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          [sound]
            name=heal.wav
          [/sound]
          [object]
            [effect]
              apply_to=status
              remove=poisoned
            [/effect]
            [effect]
              apply_to=status
              remove=slowed
            [/effect]
            [effect]
              apply_to=hitpoints
              increase_total=20
              violate_maximum=yes
            [/effect]
            [effect]
              apply_to=hitpoints
              heal_full=yes
              violate_maximum=yes
            [/effect]
            [effect]
              apply_to=hitpoints
              increase=100%
              violate_maximum=yes
            [/effect]
            silent=yes
            duration=forever
          [/object]
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
      [option]
        message= _ "Take yelow potion for later use"
        [show_if]
          {SX_CMP potions_total_$side_number less_than 4}
          {SX_CMP yellow_potions_$side_number less_than 2}
        [/show_if]
        [command]
          [sound]
            name=fanfare-short.wav
          [/sound]
          [print]
            text= _ "Player $side_number| found yellow potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          {VARIABLE_OP yellow_potions_$side_number add 1}
          {VARIABLE_OP potions_total_$side_number add 1}
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
    [/message]
  [/event]
#enddef

#define SX_DRINK_YELLOW_POTION
  [option]
    message= _ {MENU_IMG_TXT "icons/potion-yellow_icon.png" "Drink yellow potion (+20HP max., full heal, 2xHP)"}
    [show_if]
      {SX_CMP yellow_potions_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      [store_unit]
        [filter]
          x,y=$x1,$y1
          side=$side_number
        [/filter]
        variable=drinker
      [/store_unit]
      [if]
        {SX_CMP drinker.attacks_left greater_than_equal_to 1}
        [then]
          {VARIABLE_OP yellow_potions_$side_number add -1}
          {VARIABLE_OP potions_total_$side_number add -1}
          [sound]
            name=heal.wav
          [/sound]
          [print]
            text= _ "Player $side_number| used yellow potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          [object]
            duration=forever
            [effect]
              apply_to=status
              remove=poisoned
            [/effect]
            [effect]
              apply_to=status
              remove=slowed
            [/effect]
            [effect]
              apply_to=hitpoints
              increase_total=20
              violate_maximum=yes
            [/effect]
            [effect]
              apply_to=hitpoints
              heal_full=yes
              violate_maximum=yes
            [/effect]
            [effect]
              apply_to=hitpoints
              increase=100%
              violate_maximum=yes
            [/effect]
            silent=yes
          [/object]
        [/then]
      [/if]
      {CLEAR_VARIABLE drinker}
    [/command]
  [/option]
#enddef

#define SX_DROP_YELLOW_POTION
  [option]
    message= _ {MENU_IMG_TXT "icons/potion-yellow_icon.png" "Drop yellow potion (you have $yellow_potions_$side_number||)"}
    [show_if]
      {SX_CMP yellow_potions_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      {SX_YELLOW_POTION $x1 $y1}
      [print]
        text= _ "Player $side_number| dropped yellow potion."
        size=18
        duration=500
        red,green,blue=255,255,0
      [/print]
      {VARIABLE_OP yellow_potions_$side_number add -1}
      {VARIABLE_OP potions_total_$side_number add -1}
    [/command]
  [/option]
#enddef

#define SX_RED_POTION X Y
  {SX_ITEM {X} {Y} "RED_POTION" "items/potion-red.png" ""}
#enddef

#define SX_RED_POTION_EVENT
  [event]
    name=red_potion_found
    first_time_only=no
    [message]
      image=items/potion-red.png
      speaker=narrator
      message= _ "You found a strange red potion. Drinking it will heal all your wounds. Use it
wisely. You can carry maximum of 4 potions of different types and 2 potions
of same type at a time. Currently you are carrying:
<255,0,0>Red potions: $red_potions_$side_number||
Total number: $potions_total_$side_number||
For using one of red potions, that you are carrying, right-click on your
hero, select View inventory... and then select 'Drink red potion'."
      [option]
        message= _ "I'll leave it for another player"
        [command]
        [/command]
      [/option]
      [option]
        message= _ "Take and use red potion"
        [command]
          [print]
            text= _ "Player $side_number| found and used red potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          [sound]
            name=heal.wav
          [/sound]
          [object]
            duration=forever
            [effect]
              apply_to=status
              remove=poisoned
            [/effect]
            [effect]
              apply_to=status
              remove=slowed
            [/effect]
            [effect]
              apply_to=hitpoints
              heal_full=yes
              violate_maximum=yes
            [/effect]
            silent=yes
          [/object]
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
      [option]
        message= _ "Take red potion for later use"
        [show_if]
          {SX_CMP potions_total_$side_number less_than 4}
          {SX_CMP red_potions_$side_number less_than 2}
        [/show_if]
        [command]
          [sound]
            name=fanfare-short.wav
          [/sound]
          [print]
            text= _ "Player $side_number| found red potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          {VARIABLE_OP red_potions_$side_number add 1}
          {VARIABLE_OP potions_total_$side_number add 1}
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
    [/message]
  [/event]
#enddef

#define SX_DRINK_RED_POTION
  [option]
    message= _ {MENU_IMG_TXT "icons/potion-red_icon.png" "Drink red potion (Full heal)"}
    [show_if]
      {SX_CMP red_potions_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      [store_unit]
        [filter]
          x,y=$x1,$y1
          side=$side_number
        [/filter]
        variable=drinker
      [/store_unit]
      [if]
        {SX_CMP drinker.attacks_left greater_than_equal_to 1}
        [then]
          {VARIABLE_OP red_potions_$side_number add -1}
          {VARIABLE_OP potions_total_$side_number add -1}
          [sound]
            name=heal.wav
          [/sound]
          [print]
            text= _ "Player $side_number| used red potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          [object]
            duration=forever
            [effect]
              apply_to=status
              remove=poisoned
            [/effect]
            [effect]
              apply_to=status
              remove=slowed
            [/effect]
            [effect]
              apply_to=hitpoints
              heal_full=yes
              violate_maximum=yes
            [/effect]
            silent=yes
          [/object]
        [/then]
      [/if]
      {CLEAR_VARIABLE drinker}
    [/command]
  [/option]
#enddef

#define SX_DROP_RED_POTION
  [option]
    message= _ {MENU_IMG_TXT "icons/potion-red_icon.png" "Drop red potion (you have $red_potions_$side_number||}"}
    [show_if]
      {SX_CMP red_potions_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      {SX_RED_POTION $x1 $y1}
      [print]
        text= _ "Player $side_number| dropped red potion."
        size=18
        duration=500
        red,green,blue=255,255,0
      [/print]
      {VARIABLE_OP red_potions_$side_number add -1}
      {VARIABLE_OP potions_total_$side_number add -1}
    [/command]
  [/option]
#enddef

#define SX_BLUE_POTION X Y
  {SX_ITEM {X} {Y} "BLUE_POTION" "items/potion-blue.png" ""}
#enddef

#define SX_BLUE_POTION_EVENT
  [event]
    name=blue_potion_found
    first_time_only=no
    [message]
      image=items/potion-blue.png
      speaker=narrator
      message= _ "You found a strange blue potion. Drinking it will give you 5 additional
movement points reseting attack status so you can attack again and will grant
you as well 150 Hitpoints, even beyond maximum. Best use it while you have
low HP left and after you attacked first else the extra attack will be wasted.
You can carry maximum of 4 potions of different types and 2 potions of same
type at a time. Currently you are carrying:
~<0,0,255>Blue potions: $blue_potions_$side_number||
Total number: $potions_total_$side_number||
For using one of blue potions, that you are carrying, right-click on your
hero, select View inventory... and then select 'Drink blue potion'."
      [option]
        message= _ "I'll leave it for another player"
        [command]
        [/command]
      [/option]
      [option]
        message= _ "Take and use blue potion"
        [command]
          [print]
            text= _ "Player $side_number| found and used blue potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          [sound]
            name=heal.wav
          [/sound]
          [object]
            duration=forever
            [effect]
              apply_to=hitpoints
              increase=150
              violate_maximum=yes
            [/effect]
            silent=yes
            [effect]
              apply_to=status
              remove=poisoned
            [/effect]
            [effect]
              apply_to=status
              remove=slowed
            [/effect]
            silent=yes
          [/object]
          [store_unit]
            [filter]
              x=$x1
              y=$y1
            [/filter]
            variable=drinker
          [/store_unit]
          {VARIABLE_OP drinker.moves add 5}
          {VARIABLE drinker.attacks_left 1}
          [unstore_unit]
            variable=drinker
          [/unstore_unit]
          {CLEAR_VARIABLE drinker}
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
      [option]
        message= _ "Take blue potion for later use"
        [show_if]
          {SX_CMP potions_total_$side_number less_than 4}
          {SX_CMP blue_potions_$side_number less_than 2}
        [/show_if]
        [command]
          [sound]
            name=fanfare-short.wav
          [/sound]
          [print]
            text= _ "Player $side_number| found blue potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          {VARIABLE_OP blue_potions_$side_number add 1}
          {VARIABLE_OP potions_total_$side_number add 1}
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
    [/message]
  [/event]
#enddef

#define SX_DRINK_BLUE_POTION
  [option]
    message= _ {MENU_IMG_TXT "icons/potion-blue_icon.png" "Drink blue potion (+5MP, extra attack, +150HP)"}
    [show_if]
      {SX_CMP blue_potions_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      {VARIABLE_OP blue_potions_$side_number add -1}
      {VARIABLE_OP potions_total_$side_number add -1}
      [sound]
        name=heal.wav
      [/sound]
      [print]
        text= _ "Player $side_number| used blue potion."
        size=18
        duration=500
        red,green,blue=255,255,0
      [/print]
      [object]
        [effect]
          apply_to=status
          remove=poisoned
        [/effect]
        [effect]
          apply_to=status
          remove=slowed
        [/effect]
        [effect]
          apply_to=hitpoints
          increase=150
          violate_maximum=yes
        [/effect]
        silent=yes
        duration=forever
      [/object]
      [store_unit]
        [filter]
          x,y=$x1,$y1
          side=$side_number
        [/filter]
        variable=drinker
      [/store_unit]
      {VARIABLE_OP drinker.moves add 5}
      {VARIABLE drinker.attacks_left 1}
      [unstore_unit]
        variable=drinker
      [/unstore_unit]
      {CLEAR_VARIABLE drinker}
    [/command]
  [/option]
#enddef

#define SX_DROP_BLUE_POTION
  [option]
    message= _ {MENU_IMG_TXT "icons/potion-blue_icon.png" "Drop blue potion (you have $blue_potions_$side_number||}"}
    [show_if]
      {SX_CMP blue_potions_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      {SX_BLUE_POTION $x1 $y1}
      [print]
        text= _ "Player $side_number| dropped blue potion."
        size=18
        duration=500
        red,green,blue=255,255,0
      [/print]
      {VARIABLE_OP blue_potions_$side_number add -1}
      {VARIABLE_OP potions_total_$side_number add -1}
    [/command]
  [/option]
#enddef

#define SX_CYAN_POTION X Y
  {SX_ITEM {X} {Y} "CYAN_POTION" "items/potion-cyan.png" ""}
#enddef

#define SX_CYAN_POTION_EVENT
  [event]
    name=cyan_potion_found
    first_time_only=no
    [message]
      image=items/potion-cyan.png
      speaker=narrator
      message= _ "You found a strange cyan potion. Drinking it will give you temporarily
9 additional movement points even beyound your maximum movement.
You can carry maximum of 4 potions of different types and 2 potions of same
type at a time. Currently you are carrying:
~<0,0,255>Cyan potions: $cyan_potions_$side_number||
Total number: $potions_total_$side_number||
For using one of cyan potions, that you are carrying, right-click on your
hero, select View inventory... and then select 'Drink cyan potion'."
      [option]
        message= _ "I'll leave it for another player"
        [command]
        [/command]
      [/option]
      [option]
        message= _ "Take and use cyan potion"
        [command]
          [print]
            text= _ "Player $side_number| found and used cyan potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          [sound]
            name=heal.wav
          [/sound]
          [object]
            [effect]
              apply_to=status
              remove=slowed
            [/effect]
            silent=yes
            duration=forever
          [/object]
          [store_unit]
            [filter]
              x=$x1
              y=$y1
            [/filter]
            variable=drinker
          [/store_unit]
          {VARIABLE_OP drinker.moves add 9}
          [unstore_unit]
            variable=drinker
          [/unstore_unit]
          {CLEAR_VARIABLE drinker}
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
      [option]
        message= _ "Take cyan potion for later use"
        [show_if]
          {SX_CMP potions_total_$side_number less_than 4}
          {SX_CMP cyan_potions_$side_number less_than 2}
        [/show_if]
        [command]
          [sound]
            name=fanfare-short.wav
          [/sound]
          [print]
            text= _ "Player $side_number| found cyan potion."
            size=18
            duration=500
            red,green,blue=255,255,0
          [/print]
          {VARIABLE_OP cyan_potions_$side_number add 1}
          {VARIABLE_OP potions_total_$side_number add 1}
          {VARIABLE item[$item_index|].used 1}
          {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
        [/command]
      [/option]
    [/message]
  [/event]
#enddef

#define SX_DRINK_CYAN_POTION
  [option]
    message= _ {MENU_IMG_TXT "icons/potion-cyan_icon.png" "Drink cyan potion (+9MP, unslow)"}
    [show_if]
      {SX_CMP cyan_potions_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      {VARIABLE_OP cyan_potions_$side_number add -1}
      {VARIABLE_OP potions_total_$side_number add -1}
      [sound]
        name=heal.wav
      [/sound]
      [print]
        text= _ "Player $side_number| used cyan potion."
        size=18
        duration=500
        red,green,blue=255,255,0
      [/print]
      [object]
        [effect]
          apply_to=status
          remove=slowed
        [/effect]
        silent=yes
        duration=forever
      [/object]
      [store_unit]
        [filter]
          x,y=$x1,$y1
          side=$side_number
        [/filter]
        variable=drinker
      [/store_unit]
      {VARIABLE_OP drinker.moves add 9}
      [unstore_unit]
        variable=drinker
      [/unstore_unit]
      {CLEAR_VARIABLE drinker}
    [/command]
  [/option]
#enddef

#define SX_DROP_CYAN_POTION
  [option]
    message= _ {MENU_IMG_TXT "icons/potion-cyan_icon.png" "Drop cyan potion (you have $cyan_potions_$side_number||}"}
    [show_if]
      {SX_CMP cyan_potions_$side_number greater_than_equal_to 1}
    [/show_if]
    [command]
      {SX_CYAN_POTION $x1 $y1}
      [print]
        text= _ "Player $side_number| dropped cyan potion."
        size=18
        duration=500
        red,green,blue=255,255,0
      [/print]
      {VARIABLE_OP cyan_potions_$side_number add -1}
      {VARIABLE_OP potions_total_$side_number add -1}
    [/command]
  [/option]
#enddef

#define SX_CHEST_GOLD X Y AMOUNT
  {SX_ITEM {X} {Y} "CHEST_GOLD,{AMOUNT}" "items/chest-plain-closed.png" ""}
#enddef

#define SX_CHEST_GOLD_EVENT
  [event]
    name=chest_gold_found
    first_time_only=no
    [set_variables]
      [split]
        list=$item[$item_index|].type
        key=amount
        separator=,
      [/split]
      name=chest
    [/set_variables]
    {VARIABLE divider 0}
    {VARIABLE j 1}
    [while]
      {SX_CMP j less_than_equal_to 5}
      [do]
        [if]
          [have_unit]
            side=$j
            canrecruit=yes
          [/have_unit]
          [then]
            {VARIABLE_OP divider add 1}
          [/then]
        [/if]
        {VARIABLE_OP j add 1}
      [/do]
    [/while]
    [if]
      {SX_CMP divider numerical_equals 1}
      [then]
        [print]
          text= _ "This chest contains $chest[1].amount| gold!
   Player $side_number gained $share_gold gold."
          size=18
          duration=500
          red,green,blue=255,255,0
        [/print]
        {VARIABLE remainder $chest[1].amount}
      [/then]
      [else]
        {VARIABLE share_gold $chest[1].amount}
        {VARIABLE remainder $chest[1].amount}
        {VARIABLE_OP share_gold divide $divider}
        {VARIABLE_OP remainder modulo $divider}
        [if]
          {SX_CMP remainder numerical_not_equals 0}
          [then]
            {VARIABLE remainder_text "
Remaining $remainder gold gained player $side_number"}
          [/then]
        [/if]
        [print]
          text= _ "   This chest contains $chest[1].amount gold!
   Every player gained $share_gold gold.$remainder_text"
          size=18
          duration=500
          red,green,blue=255,255,0
        [/print]
        {VARIABLE_OP remainder add $share_gold}
      [/else]
    [/if]
    {VARIABLE j 1}
    [while]
      {SX_CMP j less_than_equal_to 5}
      [do]
        [if]
          [have_unit]
            side=$j
            canrecruit=yes
          [/have_unit]
          [then]
            [store_unit]
              [filter]
                side=$j
                canrecruit=yes
              [/filter]
              variable=chest_leader
            [/store_unit]
            [if]
              {SX_CMP j numerical_equals $side_number}
              [then]
                [gold]
                  side=$j
                  amount=$remainder
                [/gold]
                [unstore_unit]
                  variable=chest_leader
                  text=$remainder
                  red,green,blue=255,255,0
                [/unstore_unit]
                {VARIABLE_OP income_$j| add $remainder}
              [/then]
              [else]
                [gold]
                  side=$j
                  amount=$share_gold
                [/gold]
                [unstore_unit]
                  variable=chest_leader
                  text=$share_gold
                  red,green,blue=255,255,0
                [/unstore_unit]
                {VARIABLE_OP income_$j| add $share_gold}
              [/else]
            [/if]
            {CLEAR_VARIABLE chest_leader}
          [/then]
        [/if]
        {VARIABLE_OP j add 1}
      [/do]
    [/while]
    [sound]
      name=gold.ogg
    [/sound]
    {CLEAR_VARIABLE chest}
    {CLEAR_VARIABLE share_gold}
    {CLEAR_VARIABLE remainder}
    {CLEAR_VARIABLE remainder_text}
    {CLEAR_VARIABLE divider}
    {VARIABLE item[$item_index|].used 1}
    {SX_REDRAW_ITEMS $item[$item_index|].x $item[$item_index|].y}
    {CLEAR_VARIABLE j}
  [/event]
#enddef

#define SX_ENEMY_GUARD X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    ai_special=guardian
    generate_description=yes
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
        [effect]
          apply_to=movement_costs
          replace=yes
          [movement_costs]
            castle=2
            cave=2
            deep_water=4
            flat=2
            forest=2
            frozen=4
            fungus=2
            hills=2
            impassable=100
            mountains=4
            reef=4
            sand=2
            shallow_water=2
            swamp_water=2
            unwalkable=4
            village=2
          [/movement_costs]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_GUARD_2 X Y TYPE SIDE MP HP MA MD RA RD RES W1 W2 W3 W4
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    ai_special=guardian
    generate_description=yes
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_{W1}}
        {SX_ENEMY_WEAPON_{W2}}
        {SX_ENEMY_WEAPON_{W3}}
        {SX_ENEMY_WEAPON_{W4}}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
        [effect]
          apply_to=movement_costs
          replace=yes
          [movement_costs]
            castle=2
            cave=2
            deep_water=4
            flat=2
            forest=2
            frozen=4
            fungus=2
            hills=2
            impassable=100
            mountains=4
            reef=4
            sand=2
            shallow_water=2
            swamp_water=2
            unwalkable=4
            village=2
          [/movement_costs]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_MODIFY_UNIT_MOVEMENT_COSTS X Y CS CV DW FL FO FR FU HI IM MO RE SA SH SW UN VI
  [object]
    silent=yes
    duration=forever
    [filter]
      x,y={X},{Y}
    [/filter]
    [effect]
      apply_to=movement_costs
      replace=yes
      [movement_costs]
        castle={CS}
        cave={CV}
        deep_water={DW}
        flat={FL}
        forest={FO}
        frozen={FR}
        fungus={FU}
        hills={HI}
        impassable={IM}
        mountains={MO}
        reef={RE}
        sand={SA}
        shallow_water={SH}
        swamp_water={SW}
        unwalkable={UN}
        village={VI}
      [/movement_costs]
    [/effect]
  [/object]
#enddef

#define SX_ENEMY_GUARD_CASTLE X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    ai_special=guardian
    generate_description=yes
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
        [effect]
          apply_to=movement_costs
          replace=yes
          [movement_costs]
            castle=1
            cave=5
            deep_water=5
            flat=5
            forest=5
            frozen=5
            fungus=5
            hills=5
            impassable=100
            mountains=5
            reef=5
            sand=5
            shallow_water=5
            swamp_water=5
            unwalkable=5
            village=5
          [/movement_costs]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_WATER_GUARD X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    ai_special=guardian
    generate_description=yes
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=new_ability
          [abilities]
            {ABILITY_SUBMERGE}
          [/abilities]
        [/effect]
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
        [effect]
          apply_to=movement_costs
          replace=yes
          [movement_costs]
            castle=2
            cave=4
            deep_water=2
            flat=3
            forest=4
            frozen=4
            fungus=4
            hills=4
            impassable=100
            mountains=4
            reef=2
            sand=4
            shallow_water=2
            swamp_water=2
            unwalkable=4
            village=2
          [/movement_costs]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_GUARD_ARCANE X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    ai_special=guardian
    generate_description=yes
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE 5 2}
        {SX_ENEMY_WEAPON_ARCANE_MISSILE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
        [effect]
          apply_to=movement_costs
          replace=yes
          [movement_costs]
            castle=2
            cave=2
            deep_water=4
            flat=2
            forest=2
            frozen=4
            fungus=2
            hills=2
            impassable=100
            mountains=4
            reef=4
            sand=2
            shallow_water=2
            swamp_water=2
            unwalkable=4
            village=2
          [/movement_costs]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_GUARD_ARCANE_RANGED X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    ai_special=guardian
    generate_description=yes
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE_MISSILE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
        [effect]
          apply_to=movement_costs
          replace=yes
          [movement_costs]
            castle=2
            cave=2
            deep_water=4
            flat=2
            forest=2
            frozen=4
            fungus=2
            hills=2
            impassable=100
            mountains=4
            reef=4
            sand=2
            shallow_water=2
            swamp_water=2
            unwalkable=4
            village=2
          [/movement_costs]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_GUARD_ARCANE_MELEE X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    ai_special=guardian
    generate_description=yes
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
        [effect]
          apply_to=movement_costs
          replace=yes
          [movement_costs]
            castle=2
            cave=2
            deep_water=4
            flat=2
            forest=2
            frozen=4
            fungus=2
            hills=2
            impassable=100
            mountains=4
            reef=4
            sand=2
            shallow_water=2
            swamp_water=2
            unwalkable=4
            village=2
          [/movement_costs]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_UNDEAD_GUARD X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    ai_special=guardian
    generate_description=yes
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_UNDEAD}
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
        [effect]
          apply_to=movement_costs
          replace=yes
          [movement_costs]
            castle=2
            cave=2
            deep_water=4
            flat=2
            forest=2
            frozen=4
            fungus=2
            hills=2
            impassable=100
            mountains=4
            reef=4
            sand=2
            shallow_water=2
            swamp_water=2
            unwalkable=4
            village=2
          [/movement_costs]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_UNDEAD_GUARD_ARCANE_MELEE X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    ai_special=guardian
    generate_description=yes
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_UNDEAD}
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
        [effect]
          apply_to=movement_costs
          replace=yes
          [movement_costs]
            castle=2
            cave=2
            deep_water=4
            flat=2
            forest=2
            frozen=4
            fungus=2
            hills=2
            impassable=100
            mountains=4
            reef=4
            sand=2
            shallow_water=2
            swamp_water=2
            unwalkable=4
            village=2
          [/movement_costs]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_KILL_ENEMY_BONUS X Y SIDE AMOUNT
  {VARIABLE sxkeb_{X}_{Y}_{SIDE} 0}

  [event]
    name=die
    first_time_only=no
    [filter]
      x={X}
      y={Y}
    [/filter]
    [if]
      {SX_CMP sxkeb_{X}_{Y}_{SIDE} numerical_equals 0}
      [then]
        [store_unit]
          [filter]
            side={SIDE}
            canrecruit=yes
          [/filter]
          variable=leader
        [/store_unit]
        [unstore_unit]
          variable=leader
          text="{AMOUNT}"
          red,green,blue=255,64,64
        [/unstore_unit]
        [gold]
          side={SIDE}
          amount={AMOUNT}
        [/gold]
        {VARIABLE sxkeb_{X}_{Y}_{SIDE} 1}
      [/then]
    [/if]
  [/event]
#enddef

#define SX_KILL
  [event]
    name=prestart
    {VARIABLE event_index 0}
    {VARIABLE luck 0}
    {VARIABLE specialevent 0}
    {VARIABLE specialtask 0}
    {VARIABLE specialtrap 0}
    {VARIABLE leader6 1}
    {VARIABLE leader7 1}
    {VARIABLE leader8 1}
    {VARIABLE leader9 1}
    {VARIABLE cornucopia 0}
    {VARIABLE killbonus_0_0 5}
    {VARIABLE killbonus_0_1 10}
    {VARIABLE killbonus_0_2 15}
    {VARIABLE killbonus_0_3 20}
    {VARIABLE killbonus_0_4 25}
    {VARIABLE killbonus_0_5 30}
    {VARIABLE killbonus_1_0 10}
    {VARIABLE killbonus_1_1 20}
    {VARIABLE killbonus_1_2 30}
    {VARIABLE killbonus_1_3 40}
    {VARIABLE killbonus_1_4 50}
    {VARIABLE killbonus_1_5 60}
    {VARIABLE killbonus_2_0 15}
    {VARIABLE killbonus_2_1 30}
    {VARIABLE killbonus_2_2 45}
    {VARIABLE killbonus_2_3 60}
    {VARIABLE killbonus_2_4 75}
    {VARIABLE killbonus_2_5 90}
  [/event]

  [event]
    name=die
    first_time_only=no
    [filter_second]
      side=1,2,3,4,5
    [/filter_second]
    [store_unit]
      variable=victim
      [filter]
        x,y=$x1,$y1
      [/filter]
    [/store_unit]
    [if]
      {SX_CMP victim.canrecruit equals 1}
      [then]
        {VARIABLE isHero 2}
      [/then]
      [else]
        [if]
          {SX_CMP victim.role equals boss}
          [then]
            {VARIABLE isHero 1}
          [/then]
          [else]
            {VARIABLE isHero 0}
          [/else]
        [/if]
      [/else]
    [/if]
    {VARIABLE bonus $killbonus_$isHero|_$victim.level}
    [if]
      {SX_CMP cornucopia equals 1}
      [then]
        {VARIABLE_OP bonus multiply 1.2}
      [/then]
    [/if]
    {CLEAR_VARIABLE victim}
    [store_unit]
      [filter]
        x=$x2
        y=$y2
      [/filter]
      variable=killer
    [/store_unit]
    {VARIABLE killer.moves $mp_kill_$killer.side}
    {VARIABLE killer.attacks_left 1}
    {CLEAR_VARIABLE killer.status.poisoned}
    {CLEAR_VARIABLE killer.status.slowed}
    [unstore_unit]
      variable=killer
    [/unstore_unit]
    {CLEAR_VARIABLE killer}
    {VARIABLE i 1}
    [while]
      {SX_CMP i less_than_equal_to 5}
      [do]
        [if]
          [have_unit]
            side=$i
            canrecruit=yes
          [/have_unit]
          [then]
            [gold]
              side=$i
              amount=$bonus
            [/gold]
            [store_unit]
              [filter]
                side=$i
                canrecruit=yes
              [/filter]
              variable=killers
            [/store_unit]
            [unstore_unit]
              variable=killers
              text=$bonus
              red,green,blue=255,255,0
            [/unstore_unit]
            {VARIABLE_OP income_$i| add $bonus}
            {CLEAR_VARIABLE killers}
          [/then]
        [/if]
        [sound]
          name=gold.ogg
        [/sound]
        {VARIABLE_OP i add 1}
      [/do]
    [/while]
    {CLEAR_VARIABLE i}
  [/event]
#enddef

#define SX_MODIFY_INCOME SIDE INCOME
  [modify_side]
    side={SIDE}
    income={INCOME}
  [/modify_side]
#enddef

#define SX_ENEMY_LEADER X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    canrecruit=yes
    side={SIDE}
    role=boss
    generate_description=yes
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_LEADER_2 X Y TYPE SIDE MP HP MA MD RA RD RES W1 W2 W3 W4
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    canrecruit=yes
    side={SIDE}
    role=boss
    generate_description=yes
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_{W1}}
        {SX_ENEMY_WEAPON_{W2}}
        {SX_ENEMY_WEAPON_{W3}}
        {SX_ENEMY_WEAPON_{W4}}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_LEADER_ARCANE X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    canrecruit=yes
    side={SIDE}
    role=boss
    generate_description=yes
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE 5 2}
        {SX_ENEMY_WEAPON_ARCANE_MISSILE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_LEADER_MAS_RFS X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    canrecruit=yes
    side={SIDE}
    role=boss
    generate_description=yes
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE_SLOW 5 2}
        {SX_ENEMY_WEAPON_FIRE_SLOW 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_LEADER_ARCANE_MELEE X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    canrecruit=yes
    side={SIDE}
    role=boss
    generate_description=yes
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_LEADER_MAS X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    canrecruit=yes
    side={SIDE}
    role=boss
    generate_description=yes
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE_SLOW 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_LEADER_MFE X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    canrecruit=yes
    side={SIDE}
    role=boss
    generate_description=yes
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_FIRE_EVADE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_GOLD AMOUNT X Y TYPE SIDE MP HP MA MD RA RD RES
  {SX_ENEMY_MB $units_index {X} {Y} {TYPE} {SIDE} {MP} {HP} {MA} {MD} {RA} {RD} {RES}}
  {VARIABLE mvbindex $moving_bosses.length}
  {VARIABLE moving_bosses[$mvbindex|].id Boss_$units_index}
  {VARIABLE moving_bosses[$mvbindex|].type CHEST_GOLD}
  {VARIABLE moving_bosses[$mvbindex|].amount {AMOUNT}}
  {VARIABLE_OP units_index add 1}
  {CLEAR_VARIABLE mvbindex}
#enddef

#define SX_ENEMY_ITEM ITEM X Y TYPE SIDE MP HP MA MD RA RD RES
  {SX_ENEMY_MB $units_index {X} {Y} {TYPE} {SIDE} {MP} {HP} {MA} {MD} {RA} {RD} {RES}}
  {VARIABLE mvbindex $moving_bosses.length}
  {VARIABLE moving_bosses[$mvbindex|].id Boss_$units_index}
  {VARIABLE moving_bosses[$mvbindex|].type {ITEM}}
  {VARIABLE_OP units_index add 1}
  {CLEAR_VARIABLE mvbindex}
#enddef

#define SX_ENEMY_ARCANE_ITEM ITEM X Y TYPE SIDE MP HP MA MD RA RD RES
  {SX_ENEMY_ARCANE_MB $units_index {X} {Y} {TYPE} {SIDE} {MP} {HP} {MA} {MD} {RA} {RD} {RES}}
  {VARIABLE mvbindex $moving_bosses.length}
  {VARIABLE moving_bosses[$mvbindex|].id Boss_$units_index}
  {VARIABLE moving_bosses[$mvbindex|].type {ITEM}}
  {VARIABLE_OP units_index add 1}
  {CLEAR_VARIABLE mvbindex}
#enddef

#define SX_ENEMY_ARCANE_MELEE_ITEM ITEM X Y TYPE SIDE MP HP MA MD RA RD RES
  {SX_ENEMY_ARCANE_MELEE_MB $units_index {X} {Y} {TYPE} {SIDE} {MP} {HP} {MA} {MD} {RA} {RD} {RES}}
  {VARIABLE mvbindex $moving_bosses.length}
  {VARIABLE moving_bosses[$mvbindex|].id Boss_$units_index}
  {VARIABLE moving_bosses[$mvbindex|].type {ITEM}}
  {VARIABLE_OP units_index add 1}
  {CLEAR_VARIABLE mvbindex}
#enddef

#define SX_ENEMY_UNDEAD_GOLD AMOUNT X Y TYPE SIDE MP HP MA MD RA RD RES
  {SX_ENEMY_UNDEAD_MB $units_index {X} {Y} {TYPE} {SIDE} {MP} {HP} {MA} {MD} {RA} {RD} {RES}}
  {VARIABLE mvbindex $moving_bosses.length}
  {VARIABLE moving_bosses[$mvbindex|].id Boss_$units_index}
  {VARIABLE moving_bosses[$mvbindex|].type CHEST_GOLD}
  {VARIABLE moving_bosses[$mvbindex|].amount {AMOUNT}}
  {VARIABLE_OP units_index add 1}
  {CLEAR_VARIABLE mvbindex}
#enddef

#define SX_ENEMY_UNDEAD_ITEM ITEM X Y TYPE SIDE MP HP MA MD RA RD RES
  {SX_ENEMY_UNDEAD_MB $units_index {X} {Y} {TYPE} {SIDE} {MP} {HP} {MA} {MD} {RA} {RD} {RES}}
  {VARIABLE mvbindex $moving_bosses.length}
  {VARIABLE moving_bosses[$mvbindex|].id Boss_$units_index}
  {VARIABLE moving_bosses[$mvbindex|].type {ITEM}}
  {VARIABLE_OP units_index add 1}
  {CLEAR_VARIABLE mvbindex}
#enddef

#define SX_ENEMY_UNDEAD_ARCANE_MELEE_ITEM ITEM X Y TYPE SIDE MP HP MA MD RA RD RES
  {SX_ENEMY_UNDEAD_ARCANE_MELEE_MB $units_index {X} {Y} {TYPE} {SIDE} {MP} {HP} {MA} {MD} {RA} {RD} {RES}}
  {VARIABLE mvbindex $moving_bosses.length}
  {VARIABLE moving_bosses[$mvbindex|].id Boss_$units_index}
  {VARIABLE moving_bosses[$mvbindex|].type {ITEM}}
  {VARIABLE_OP units_index add 1}
  {CLEAR_VARIABLE mvbindex}
#enddef

#define SX_ENEMY_MB ID X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    id=Boss_{ID}
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_ARCANE_MB ID X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    {IS_HERO}
    id=Boss_{ID}
    role=boss
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE 5 2}
        {SX_ENEMY_WEAPON_ARCANE_MISSILE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_ARCANE_MELEE_MB ID X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    {IS_HERO}
    id=Boss_{ID}
    role=boss
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_UNDEAD_MB ID X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    role=boss
    {IS_HERO}
    id=Boss_{ID}
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_UNDEAD}
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_UNDEAD_ARCANE_MELEE_MB ID X Y TYPE SIDE MP HP MA MD RA RD RES
  [unit]
    x={X}
    y={Y}
    type={TYPE}
    side={SIDE}
    {IS_HERO}
    id=Boss_{ID}
    role=boss
    name=~Boss
    unrenamable=yes
    [modifications]
      {TRAIT_UNDEAD}
      {TRAIT_FEARLESS}
      {TRAIT_LOYAL}
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE 8 3}
        [effect]
          apply_to=movement
          increase={MP}
        [/effect]
        [effect]
          apply_to=hitpoints
          increase={HP}
          increase_total={HP}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_attacks={MA}
        [/effect]
        [effect]
          apply_to=attack
          range=melee
          increase_damage={MD}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_attacks={RA}
        [/effect]
        [effect]
          apply_to=attack
          range=ranged
          increase_damage={RD}
        [/effect]
        [effect]
          apply_to=resistance
          replace=no
          [resistance]
            blade=-{RES}
            pierce=-{RES}
            impact=-{RES}
            fire=-{RES}
            cold=-{RES}
            arcane=-{RES}
          [/resistance]
        [/effect]
      [/object]
    [/modifications]
  [/unit]
#enddef

#define SX_ENEMY_DEATH_EVENT
  [event]
    name=die
    first_time_only=no
    [filter]
      name=~Boss
    [/filter]
    {VARIABLE id $unit.id}
    {FOREACH moving_bosses i}
      [if]
        {SX_CMP moving_bosses[$i|].id equals $id}
        {SX_CMP moving_bosses[$i|].type equals CHEST_GOLD}
        [then]
          {SX_CHEST_GOLD $unit.x $unit.y $moving_bosses[$i|].amount|}
        [/then]
      [/if]
      [if]
        {SX_CMP moving_bosses[$i|].id equals $id}
        {SX_CMP moving_bosses[$i|].type equals DEFRING}
        [then]
          {SX_DEFRING $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SX_CMP moving_bosses[$i|].id equals $id}
        {SX_CMP moving_bosses[$i|].type equals RESRING}
        [then]
          {SX_RESRING $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SX_CMP moving_bosses[$i|].id equals $id}
        {SX_CMP moving_bosses[$i|].type equals BLUE_POTION}
        [then]
          {SX_BLUE_POTION $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SX_CMP moving_bosses[$i|].id equals $id}
        {SX_CMP moving_bosses[$i|].type equals CYAN_POTION}
        [then]
          {SX_CYAN_POTION $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SX_CMP moving_bosses[$i|].id equals $id}
        {SX_CMP moving_bosses[$i|].type equals RED_POTION}
        [then]
          {SX_RED_POTION $unit.x $unit.y}
        [/then]
      [/if]
      [if]
        {SX_CMP moving_bosses[$i|].id equals $id}
        {SX_CMP moving_bosses[$i|].type equals YELLOW_POTION}
        [then]
          {SX_YELLOW_POTION $unit.x $unit.y}
        [/then]
      [/if]
    {NEXT i}
  [/event]
#enddef

#define SX_CHOOSE_DIFFICULTY X Y
  [event]
    name=moveto
    first_time_only=yes
    [filter]
      side=1,2,3,4,5
    [/filter]
    [message]
      speaker=narrator
      message= _ "Choose the difficulty. Your setting will affect the amount of gold you will gain by killing enemies, as well as their toughness and strength. However, choose your difficulty carefully as you can't change it anymore later."
      [option]
        message= _ "*~<0,128,255>Simple"
        [command]
          {VARIABLE killbonus_0_0 6}
          {VARIABLE killbonus_0_1 12}
          {VARIABLE killbonus_0_2 14}
          {VARIABLE killbonus_0_3 16}
          {VARIABLE killbonus_0_4 18}
          {VARIABLE killbonus_0_5 20}
          {VARIABLE killbonus_1_0 12}
          {VARIABLE killbonus_1_1 24}
          {VARIABLE killbonus_1_2 28}
          {VARIABLE killbonus_1_3 32}
          {VARIABLE killbonus_1_4 36}
          {VARIABLE killbonus_1_5 40}
          {VARIABLE killbonus_2_0 18}
          {VARIABLE killbonus_2_1 36}
          {VARIABLE killbonus_2_2 42}
          {VARIABLE killbonus_2_3 48}
          {VARIABLE killbonus_2_4 54}
          {VARIABLE killbonus_2_5 60}
          {VARIABLE_OP brutal add -5}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: SIMPLE
            size=24
            duration=500
            red,green,blue=0,128,255
          [/print]
          {VARIABLE difficulty 75}
          {VARIABLE difficulty_text "~*<0,128,255>Difficulty: SIMPLE"}
        [/command]
      [/option]
      [option]
        message= _ "*~<0,200,0>Easy"
        [command]
          {VARIABLE killbonus_0_0 5}
          {VARIABLE killbonus_0_1 10}
          {VARIABLE killbonus_0_2 12}
          {VARIABLE killbonus_0_3 14}
          {VARIABLE killbonus_0_4 16}
          {VARIABLE killbonus_0_5 18}
          {VARIABLE killbonus_1_0 10}
          {VARIABLE killbonus_1_1 20}
          {VARIABLE killbonus_1_2 24}
          {VARIABLE killbonus_1_3 28}
          {VARIABLE killbonus_1_4 32}
          {VARIABLE killbonus_1_5 36}
          {VARIABLE killbonus_2_0 15}
          {VARIABLE killbonus_2_1 30}
          {VARIABLE killbonus_2_2 36}
          {VARIABLE killbonus_2_3 42}
          {VARIABLE killbonus_2_4 48}
          {VARIABLE killbonus_2_5 54}
          {VARIABLE_OP brutal add 0}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: EASY
            size=24
            duration=500
            red,green,blue=0,200,0
          [/print]
          {VARIABLE difficulty 100}
          {VARIABLE difficulty_text "~*<0,200,0>Difficulty: EASY"}
        [/command]
      [/option]
      [option]
        message= _ "*~<255,255,0>Normal"
        [command]
          {VARIABLE killbonus_0_0 4}
          {VARIABLE killbonus_0_1 8}
          {VARIABLE killbonus_0_2 10}
          {VARIABLE killbonus_0_3 12}
          {VARIABLE killbonus_0_4 14}
          {VARIABLE killbonus_0_5 16}
          {VARIABLE killbonus_1_0 8}
          {VARIABLE killbonus_1_1 16}
          {VARIABLE killbonus_1_2 20}
          {VARIABLE killbonus_1_3 24}
          {VARIABLE killbonus_1_4 28}
          {VARIABLE killbonus_1_5 32}
          {VARIABLE killbonus_2_0 12}
          {VARIABLE killbonus_2_1 24}
          {VARIABLE killbonus_2_2 30}
          {VARIABLE killbonus_2_3 36}
          {VARIABLE killbonus_2_4 42}
          {VARIABLE killbonus_2_5 48}
          {VARIABLE_OP brutal add 5}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: NORMAL
            size=24
            duration=500
            red,green,blue=255,255,0
          [/print]
          {VARIABLE difficulty 125}
          {VARIABLE difficulty_text "~*<255,255,0>Difficulty: NORMAL"}
        [/command]
      [/option]
      [option]
        message= _ "*~<255,128,0>Hard"
        [command]
          {VARIABLE killbonus_0_0 3}
          {VARIABLE killbonus_0_1 6}
          {VARIABLE killbonus_0_2 8}
          {VARIABLE killbonus_0_3 10}
          {VARIABLE killbonus_0_4 12}
          {VARIABLE killbonus_0_5 14}
          {VARIABLE killbonus_1_0 6}
          {VARIABLE killbonus_1_1 12}
          {VARIABLE killbonus_1_2 16}
          {VARIABLE killbonus_1_3 20}
          {VARIABLE killbonus_1_4 24}
          {VARIABLE killbonus_1_5 28}
          {VARIABLE killbonus_2_0 9}
          {VARIABLE killbonus_2_1 18}
          {VARIABLE killbonus_2_2 24}
          {VARIABLE killbonus_2_3 30}
          {VARIABLE killbonus_2_4 36}
          {VARIABLE killbonus_2_5 42}
          {VARIABLE_OP brutal add 10}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: HARD
            size=24
            duration=500
            red,green,blue=255,128,0
          [/print]
          {VARIABLE difficulty 150}
          {VARIABLE difficulty_text "~*<255,128,0>Difficulty: HARD"}
        [/command]
      [/option]
      [option]
        message= _ "*~<255,0,0>Xtreme"
        [command]
          {VARIABLE killbonus_0_0 2}
          {VARIABLE killbonus_0_1 5}
          {VARIABLE killbonus_0_2 7}
          {VARIABLE killbonus_0_3 9}
          {VARIABLE killbonus_0_4 11}
          {VARIABLE killbonus_0_5 13}
          {VARIABLE killbonus_1_0 5}
          {VARIABLE killbonus_1_1 10}
          {VARIABLE killbonus_1_2 14}
          {VARIABLE killbonus_1_3 18}
          {VARIABLE killbonus_1_4 22}
          {VARIABLE killbonus_1_5 26}
          {VARIABLE killbonus_2_0 7}
          {VARIABLE killbonus_2_1 15}
          {VARIABLE killbonus_2_2 21}
          {VARIABLE killbonus_2_3 27}
          {VARIABLE killbonus_2_4 33}
          {VARIABLE killbonus_2_5 39}
          {VARIABLE_OP brutal add 15}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: XTREME
            size=32
            duration=750
            red,green,blue=255,0,0
          [/print]
          {VARIABLE difficulty 175}
          {VARIABLE difficulty_text "~*<255,0,0>Difficulty: XTREME"}
          [music]
            name=frantic.ogg
            play_once=yes
            immediate=yes
          [/music]
        [/command]
      [/option]
      [option]
        message= _ "*~<128,0,128>Mad Mode"
        [command]
          {VARIABLE killbonus_0_0 2}
          {VARIABLE killbonus_0_1 4}
          {VARIABLE killbonus_0_2 6}
          {VARIABLE killbonus_0_3 8}
          {VARIABLE killbonus_0_4 10}
          {VARIABLE killbonus_0_5 12}
          {VARIABLE killbonus_1_0 4}
          {VARIABLE killbonus_1_1 8}
          {VARIABLE killbonus_1_2 12}
          {VARIABLE killbonus_1_3 16}
          {VARIABLE killbonus_1_4 20}
          {VARIABLE killbonus_1_5 24}
          {VARIABLE killbonus_2_0 6}
          {VARIABLE killbonus_2_1 12}
          {VARIABLE killbonus_2_2 18}
          {VARIABLE killbonus_2_3 24}
          {VARIABLE killbonus_2_4 30}
          {VARIABLE killbonus_2_5 36}
          {VARIABLE_OP brutal add 20}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: MAD MODE
            size=40
            duration=1000
            red,green,blue=128,0,128
          [/print]
          {VARIABLE difficulty 200}
          {VARIABLE difficulty_text "~*<128,0,128>Difficulty: MADMODE"}
          [music]
            name=frantic.ogg
            play_once=yes
            immediate=yes
          [/music]
        [/command]
      [/option]
    [/message]
    [redraw]
    [/redraw]
    [label]
      x={X}
      y={Y}
      text=_ "$difficulty_text|"
    [/label]
    [delay]
      time=1000
    [/delay]
    [set_menu_item]
      id=SXC_Active_Difficulty
      description="$difficulty_text|"
      [command]
        [message]
          speaker=narrator
          message="Brutal: $brutal|
Earned gold: $income_$side_number||"
          side_for=$side_number
        [/message]
      [/command]
    [/set_menu_item]
  [/event]

  [event]
    name=side turn
    first_time_only=no
    [label]
      x={X}
      y={Y}
      text=_ "{X},{Y}"
    [/label]
    [label]
      x={X}
      y={Y}
      text= _ "$difficulty_text|"
    [/label]
  [/event]
#enddef

#define SX_CHOOSE_DIFFICULTY_OLD X Y
  [event]
    name=moveto
    first_time_only=yes
    [filter]
      side=1,2,3,4,5
    [/filter]
    [message]
      speaker=narrator
      message= _ "Choose the difficulty. Your setting will affect the amount of gold you will gain by killing enemies, as well as their toughness and strength. However, choose your difficulty carefully as you can't change it anymore later."
      [option]
        message= _ "*~<0,128,255>Simple"
        [command]
          {VARIABLE killbonus_0_0 7}
          {VARIABLE killbonus_0_1 14}
          {VARIABLE killbonus_0_2 16}
          {VARIABLE killbonus_0_3 18}
          {VARIABLE killbonus_0_4 21}
          {VARIABLE killbonus_0_5 23}
          {VARIABLE killbonus_1_0 15}
          {VARIABLE killbonus_1_1 20}
          {VARIABLE killbonus_1_2 24}
          {VARIABLE killbonus_1_3 29}
          {VARIABLE killbonus_1_4 34}
          {VARIABLE killbonus_1_5 39}
          {VARIABLE killbonus_2_0 18}
          {VARIABLE killbonus_2_1 23}
          {VARIABLE killbonus_2_2 33}
          {VARIABLE killbonus_2_3 40}
          {VARIABLE killbonus_2_4 48}
          {VARIABLE killbonus_2_5 55}
          {VARIABLE_OP brutal add -5}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: SIMPLE
            size=24
            duration=500
            red,green,blue=0,128,255
          [/print]
          {VARIABLE difficulty 50}
          {VARIABLE difficulty_text "~*<0,128,255>Difficulty: SIMPLE"}
        [/command]
      [/option]
      [option]
        message= _ "*~<0,200,0>Easy"
        [command]
          {VARIABLE killbonus_0_0 6}
          {VARIABLE killbonus_0_1 12}
          {VARIABLE killbonus_0_2 14}
          {VARIABLE killbonus_0_3 16}
          {VARIABLE killbonus_0_4 19}
          {VARIABLE killbonus_0_5 21}
          {VARIABLE killbonus_1_0 13}
          {VARIABLE killbonus_1_1 18}
          {VARIABLE killbonus_1_2 22}
          {VARIABLE killbonus_1_3 27}
          {VARIABLE killbonus_1_4 32}
          {VARIABLE killbonus_1_5 37}
          {VARIABLE killbonus_2_0 16}
          {VARIABLE killbonus_2_1 21}
          {VARIABLE killbonus_2_2 31}
          {VARIABLE killbonus_2_3 38}
          {VARIABLE killbonus_2_4 45}
          {VARIABLE killbonus_2_5 52}
          {VARIABLE_OP brutal add 0}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: EASY
            size=24
            duration=500
            red,green,blue=0,200,0
          [/print]
          {VARIABLE difficulty 75}
          {VARIABLE difficulty_text "~*<0,200,0>Difficulty: EASY"}
        [/command]
      [/option]
      [option]
        message= _ "*~<255,255,0>Normal"
        [command]
          {VARIABLE killbonus_0_0 5}
          {VARIABLE killbonus_0_1 10}
          {VARIABLE killbonus_0_2 12}
          {VARIABLE killbonus_0_3 14}
          {VARIABLE killbonus_0_4 17}
          {VARIABLE killbonus_0_5 19}
          {VARIABLE killbonus_1_0 11}
          {VARIABLE killbonus_1_1 16}
          {VARIABLE killbonus_1_2 20}
          {VARIABLE killbonus_1_3 25}
          {VARIABLE killbonus_1_4 30}
          {VARIABLE killbonus_1_5 35}
          {VARIABLE killbonus_2_0 14}
          {VARIABLE killbonus_2_1 19}
          {VARIABLE killbonus_2_2 29}
          {VARIABLE killbonus_2_3 36}
          {VARIABLE killbonus_2_4 43}
          {VARIABLE killbonus_2_5 50}
          {VARIABLE_OP brutal add 5}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: NORMAL
            size=24
            duration=500
            red,green,blue=255,255,0
          [/print]
          {VARIABLE difficulty 100}
          {VARIABLE difficulty_text "~*<255,255,0>Difficulty: NORMAL"}
        [/command]
      [/option]
      [option]
        message= _ "*~<255,128,0>Hard"
        [command]
          {VARIABLE killbonus_0_0 4}
          {VARIABLE killbonus_0_1 8}
          {VARIABLE killbonus_0_2 10}
          {VARIABLE killbonus_0_3 12}
          {VARIABLE killbonus_0_4 15}
          {VARIABLE killbonus_0_5 17}
          {VARIABLE killbonus_1_0 9}
          {VARIABLE killbonus_1_1 14}
          {VARIABLE killbonus_1_2 18}
          {VARIABLE killbonus_1_3 23}
          {VARIABLE killbonus_1_4 28}
          {VARIABLE killbonus_1_5 33}
          {VARIABLE killbonus_2_0 12}
          {VARIABLE killbonus_2_1 17}
          {VARIABLE killbonus_2_2 27}
          {VARIABLE killbonus_2_3 34}
          {VARIABLE killbonus_2_4 41}
          {VARIABLE killbonus_2_5 48}
          {VARIABLE_OP brutal add 10}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: HARD
            size=24
            duration=500
            red,green,blue=255,128,0
          [/print]
          {VARIABLE difficulty 125}
          {VARIABLE difficulty_text "~*<255,128,0>Difficulty: HARD"}
        [/command]
      [/option]
      [option]
        message= _ "*~<255,0,0>Xtreme"
        [command]
          {VARIABLE killbonus_0_0 3}
          {VARIABLE killbonus_0_1 6}
          {VARIABLE killbonus_0_2 8}
          {VARIABLE killbonus_0_3 10}
          {VARIABLE killbonus_0_4 13}
          {VARIABLE killbonus_0_5 15}
          {VARIABLE killbonus_1_0 7}
          {VARIABLE killbonus_1_1 12}
          {VARIABLE killbonus_1_2 16}
          {VARIABLE killbonus_1_3 21}
          {VARIABLE killbonus_1_4 26}
          {VARIABLE killbonus_1_5 31}
          {VARIABLE killbonus_2_0 10}
          {VARIABLE killbonus_2_1 18}
          {VARIABLE killbonus_2_2 25}
          {VARIABLE killbonus_2_3 32}
          {VARIABLE killbonus_2_4 39}
          {VARIABLE killbonus_2_5 46}
          {VARIABLE_OP brutal add 15}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: XTREME
            size=32
            duration=750
            red,green,blue=255,0,0
          [/print]
          {VARIABLE difficulty 150}
          {VARIABLE difficulty_text "~*<255,0,0>Difficulty: XTREME"}
          [music]
            name=frantic.ogg
            play_once=yes
            immediate=yes
          [/music]
        [/command]
      [/option]
      [option]
        message= _ "*~<128,0,128>Mad Mode"
        [command]
          {VARIABLE killbonus_0_0 3}
          {VARIABLE killbonus_0_1 5}
          {VARIABLE killbonus_0_2 7}
          {VARIABLE killbonus_0_3 9}
          {VARIABLE killbonus_0_4 11}
          {VARIABLE killbonus_0_5 13}
          {VARIABLE killbonus_1_0 6}
          {VARIABLE killbonus_1_1 10}
          {VARIABLE killbonus_1_2 14}
          {VARIABLE killbonus_1_3 18}
          {VARIABLE killbonus_1_4 22}
          {VARIABLE killbonus_1_5 26}
          {VARIABLE killbonus_2_0 9}
          {VARIABLE killbonus_2_1 15}
          {VARIABLE killbonus_2_2 21}
          {VARIABLE killbonus_2_3 27}
          {VARIABLE killbonus_2_4 33}
          {VARIABLE killbonus_2_5 39}
          {VARIABLE_OP brutal add 20}
          [sound]
            name=dragonstick.ogg
          [/sound]
          [print]
            text=Difficulty: MAD MODE
            size=40
            duration=1000
            red,green,blue=128,0,128
          [/print]
          {VARIABLE difficulty 200}
          {VARIABLE difficulty_text "~*<128,0,128>Difficulty: MADMODE"}
          [music]
            name=frantic.ogg
            play_once=yes
            immediate=yes
          [/music]
        [/command]
      [/option]
    [/message]
    [redraw]
    [/redraw]
    [label]
      x={X}
      y={Y}
      text=$difficulty_text
    [/label]
    [delay]
      time=1000
    [/delay]
    [set_menu_item]
      id=SXC_Active_Difficulty
      description="$difficulty_text|"
    [/set_menu_item]
  [/event]

  [event]
    name=side turn
    first_time_only=no
    [label]
      x={X}
      y={Y}
      text=$null
    [/label]
    [label]
      x={X}
      y={Y}
      text= _ "$difficulty_text|"
    [/label]
  [/event]
#enddef

#define SX_DEATH_MESSAGES
  [event]
    name=die
    first_time_only=no
    [filter]
      side=1,2,3,4,5
      canrecruit=yes
    [/filter]
    {RANDOM 0..9}
    [store_unit]
      [filter]
        x,y=$x1,$y1
        canrecruit=yes
      [/filter]
      variable=dying_friend
    [/store_unit]
    [message]
      speaker=unit
      message= _ "$death_text_$random||"
    [/message]
    [store_gold]
      side=$dying_friend.side
      variable=gold_die
    [/store_gold]
    {VARIABLE i 1}
    [while]
      {SX_CMP i less_than_equal_to 2}
      [do]
        [if]
          {SX_CMP defring_$dying_friend.side greater_than_equal_to $i}
          [then]
            {SX_DEFRING $x1 $y1}
          [/then]
        [/if]
        [if]
          {SX_CMP resring_$dying_friend.side greater_than_equal_to $i}
          [then]
            {SX_RESRING $x1 $y1}
          [/then]
        [/if]
        [if]
          {SX_CMP blue_potion_$dying_friend.side greater_than_equal_to $i}
          [then]
            {SX_BLUE_POTION $x1 $y1}
          [/then]
        [/if]
        [if]
          {SX_CMP red_potion_$dying_friend.side greater_than_equal_to $i}
          [then]
            {SX_RED_POTION $x1 $y1}
          [/then]
        [/if]
        [if]
          {SX_CMP yellow_potion_$dying_friend.side greater_than_equal_to $i}
          [then]
            {SX_YELLOW_POTION $x1 $y1}
          [/then]
        [/if]
        [if]
          {SX_CMP cyan_potion_$dying_friend.side greater_than_equal_to $i}
          [then]
            {SX_CYAN_POTION $x1 $y1}
          [/then]
        [/if]
        {VARIABLE_OP i add 1}
      [/do]
    [/while]
    [if]
      {SX_CMP gold_die greater_than_equal_to 1}
      [then]
        {SX_CHEST_GOLD $x1 $y1 $gold_die|}
      [/then]
    [/if]
    [gold]
      amount=-$gold_die
      side=$dying_friend.side
    [/gold]
    [gold]
      side=6
      amount=125
    [/gold]
    [gold]
      side=7
      amount=125
    [/gold]
    [gold]
      side=8
      amount=125
    [/gold]
    [gold]
      side=9
      amount=125
    [/gold]
    {VARIABLE_OP brutal add 4}
    {SX_MODIFY_INCOME 1 -2}
    {CLEAR_VARIABLE dying_friend}
    {CLEAR_VARIABLE random}
    {CLEAR_VARIABLE i}
  [/event]
#enddef

#define SX_ENEMY_UPGRADE_WEAPON DMG STR
  [if]
    {SX_CMP creep_attacks_melee less_than 1}
    [then]
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_ARCANE {DMG} {STR}}
      [/object]
    [/then]
  [/if]
  [if]
    {SX_CMP creep_attacks_ranged less_than 1}
    [then]
      [object]
        silent=yes
        duration=forever
        {SX_ENEMY_WEAPON_FIRE {DMG} {STR}}
      [/object]
    [/then]
  [/if]
#enddef

#define SX_ENEMY_UPGRADE
  [event]
    name=recruit
    first_time_only=no
    [store_unit]
      [filter]
        x=$x1
        y=$y1
      [/filter]
      variable=creep
    [/store_unit]
    {VARIABLE creep_attacks_melee 0}
    {VARIABLE creep_attacks_ranged 0}
    {FOREACH creep.attack i}
      {VARIABLE_OP creep_attacks_$creep.attack[$i|].range| add 1}
    {NEXT i}
    {VARIABLE new_trait_i $creep.modifications.trait.length}
    {VARIABLE_OP new_trait format "creep.modifications.trait[$new_trait_i].id"}
    {VARIABLE $new_trait loyal}
    {VARIABLE_OP new_trait format "creep.modifications.trait[$new_trait_i].name"}
    {VARIABLE_OP $new_trait format ( _ "loyal")}
    {VARIABLE_OP new_trait format "creep.modifications.trait[$new_trait_i].female_name"}
    {VARIABLE_OP $new_trait format ( _ "female^loyal")}
    {VARIABLE_OP new_trait format "creep.modifications.trait[$new_trait_i].description"}
    {VARIABLE_OP $new_trait format ( _ "Zero upkeep")}
    {VARIABLE_OP new_trait format "creep.modifications.trait[$new_trait_i].effect[0].apply_to"}
    {VARIABLE $new_trait loyal}
    [unstore_unit]
      variable=creep
    [/unstore_unit]
    [if]
      {SX_CMP brutal greater_than_equal_to 200}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=6
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=3500%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=900%
            increase_attacks=300%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=900%
            increase_attacks=300%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-40
              pierce=-40
              impact=-40
              fire=-40
              cold=-40
              arcane=-40
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 180}
      {SX_CMP brutal less_than 200}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=6
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=3000%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=800%
            increase_attacks=260%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=800%
            increase_attacks=260%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-40
              pierce=-40
              impact=-40
              fire=-40
              cold=-40
              arcane=-40
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 160}
      {SX_CMP brutal less_than 180}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=5
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=2600%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=700%
            increase_attacks=220%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=700%
            increase_attacks=220%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-40
              pierce=-40
              impact=-40
              fire=-40
              cold=-40
              arcane=-40
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 140}
      {SX_CMP brutal less_than 160}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=5
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=2200%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=600%
            increase_attacks=180%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=600%
            increase_attacks=180%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-30
              pierce=-30
              impact=-30
              fire=-30
              cold=-30
              arcane=-30
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 120}
      {SX_CMP brutal less_than 140}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=4
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=1800%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=500%
            increase_attacks=150%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=500%
            increase_attacks=150%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-30
              pierce=-30
              impact=-30
              fire=-30
              cold=-30
              arcane=-30
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 100}
      {SX_CMP brutal less_than 120}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=4
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=1450%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=400%
            increase_attacks=120%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=400%
            increase_attacks=120%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-30
              pierce=-30
              impact=-30
              fire=-30
              cold=-30
              arcane=-30
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 90}
      {SX_CMP brutal less_than 100}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=3
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=1200%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=350%
            increase_attacks=100%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=350%
            increase_attacks=100%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 80}
      {SX_CMP brutal less_than 90}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=3
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=950%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=300%
            increase_attacks=80%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=300%
            increase_attacks=80%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 70}
      {SX_CMP brutal less_than 80}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=3
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=700%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=250%
            increase_attacks=70%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=250%
            increase_attacks=70%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 60}
      {SX_CMP brutal less_than 70}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=2
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=500%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=200%
            increase_attacks=60%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=200%
            increase_attacks=60%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 50}
      {SX_CMP brutal less_than 60}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 2}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=2
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=300%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=150%
            increase_attacks=50%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=150%
            increase_attacks=50%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-20
              pierce=-20
              impact=-20
              fire=-20
              cold=-20
              arcane=-20
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 40}
      {SX_CMP brutal less_than 50}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 5 2}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=2
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=200%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=100%
            increase_attacks=40%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=100%
            increase_attacks=40%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-10
              pierce=-10
              impact=-10
              fire=-10
              cold=-10
              arcane=-10
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 30}
      {SX_CMP brutal less_than 40}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 4 2}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=1
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=100%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=75%
            increase_attacks=30%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=75%
            increase_attacks=30%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-10
              pierce=-10
              impact=-10
              fire=-10
              cold=-10
              arcane=-10
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 20}
      {SX_CMP brutal less_than 30}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 4 2}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=movement
            increase=1
          [/effect]
          [effect]
            apply_to=hitpoints
            increase_total=50%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=50%
            increase_attacks=25%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=50%
            increase_attacks=25%
          [/effect]
          [effect]
            apply_to=resistance
            replace=no
            [resistance]
              blade=-10
              pierce=-10
              impact=-10
              fire=-10
              cold=-10
              arcane=-10
            [/resistance]
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 10}
      {SX_CMP brutal less_than 20}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 4 1}
        [object]
          silent=yes
          duration=forever
          [effect]
            apply_to=hitpoints
            increase_total=25%
            heal_full=yes
          [/effect]
          [effect]
            apply_to=attack
            range=melee
            increase_damage=25%
          [/effect]
          [effect]
            apply_to=attack
            range=ranged
            increase_damage=25%
          [/effect]
        [/object]
      [/then]
    [/if]
    [if]
      {SX_CMP brutal greater_than_equal_to 0}
      {SX_CMP brutal less_than 10}
      [then]
        [filter]
          x,y=$x1,$y1
          side=6,7,8,9
        [/filter]
        {SX_ENEMY_UPGRADE_WEAPON 6 3}
      [/then]
    [/if]
    {CLEAR_VARIABLE new_trait_i}
    {CLEAR_VARIABLE new_trait}
    {CLEAR_VARIABLE creep}
    {CLEAR_VARIABLE creep_attacks_melee}
    {CLEAR_VARIABLE creep_attacks_ranged}
    {CLEAR_VARIABLE i}
  [/event]
#enddef

#define SX_ENEMY_WEAPON_ARCANE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "blessed dagger"
    icon=attacks/dagger-human.png
    type=arcane
    range=melee
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "blessed dagger"
      [/attack_filter]
      [frame]
        begin=-150
        end=-100
      [/frame]
      [if]
        hits=no
        [frame]
          begin=-100
          end=100
          sound={SOUND_LIST:MISS},{SOUND_LIST:HOLY_MISS}
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=-100
          end=100
          sound=dagger-swish.wav,{SOUND_LIST:HOLY}
        [/frame]
      [/else]
      [frame]
        begin=100
        end=150
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_BLADE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "short sword"
    icon=attacks/sword-human-short.png
    type=blade
    range=melee
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "short sword"
      [/attack_filter]
      [frame]
        begin=-150
        end=-100
      [/frame]
      [if]
        hits=no
        [frame]
          begin=-100
          end=100
          sound={SOUND_LIST:MISS}
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=-100
          end=100
          sound={SOUND_LIST:SWORD_SWISH}
        [/frame]
      [/else]
      [frame]
        begin=100
        end=150
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_COLD DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "cold touch"
    icon=attacks/touch-undead.png
    type=cold
    range=melee
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "cold touch"
      [/attack_filter]
      [frame]
        begin=-150
        end=-100
      [/frame]
      [if]
        hits=no
        [frame]
          begin=-100
          end=100
          sound={SOUND_LIST:MISS}
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=-100
          end=100
          sound=wail-sml.wav
        [/frame]
      [/else]
      [frame]
        begin=100
        end=150
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_ARCANE_SLOW DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "blessed staff"
    icon=attacks/staff-magic.png
    type=arcane
    range=melee
    damage={DAM}
    number={SRK}
    [specials]
      {WEAPON_SPECIAL_SLOW}
    [/specials]
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "blessed staff"
      [/attack_filter]
      [frame]
        begin=-150
        end=-100
      [/frame]
      [if]
        hits=no
        [frame]
          begin=-100
          end=100
          sound={SOUND_LIST:MISS},{SOUND_LIST:HOLY_MISS}
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=-100
          end=100
          sound=staff.wav,{SOUND_LIST:HOLY}
        [/frame]
      [/else]
      [frame]
        begin=100
        end=150
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_MELEE_FIRE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "torch"
    icon=attacks/torch.png
    type=fire
    range=melee
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "torch"
      [/attack_filter]
      [frame]
        begin=-150
        end=-100
      [/frame]
      [if]
        hits=no
        [frame]
          begin=-100
          end=100
          sound=torch-miss.ogg
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=-100
          end=100
          sound=torch.ogg
        [/frame]
      [/else]
      [frame]
        begin=100
        end=150
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_IMPACT DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "fist"
    icon=attacks/fist.png
    type=impact
    range=melee
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "fist"
      [/attack_filter]
      [frame]
        begin=-150
        end=-100
      [/frame]
      [if]
        hits=no
        [frame]
          begin=-100
          end=100
          sound={SOUND_LIST:MISS}
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=-100
          end=100
          sound=fist.ogg
        [/frame]
      [/else]
      [frame]
        begin=100
        end=150
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_PIERCE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "pike"
    icon=attacks/pike.png
    type=pierce
    range=melee
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "pike"
      [/attack_filter]
      [frame]
        begin=-150
        end=-100
      [/frame]
      [if]
        hits=no
        [frame]
          begin=-100
          end=100
          sound=spear-miss.ogg
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=-100
          end=100
          sound=spear.ogg
        [/frame]
      [/else]
      [frame]
        begin=100
        end=150
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_FIRE_EVADE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "torch"
    icon=attacks/torch.png
    type=fire
    range=melee
    damage={DAM}
    number={SRK}
    [specials]
      {WEAPON_SPECIAL_SXC_EVADE}
    [/specials]
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "torch"
      [/attack_filter]
      [frame]
        begin=-150
        end=-100
      [/frame]
      [if]
        hits=no
        [frame]
          begin=-100
          end=100
          sound=torch-miss.ogg
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=-100
          end=100
          sound=torch.ogg
        [/frame]
      [/else]
      [frame]
        begin=100
        end=150
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_ARCANE_MISSILE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "dark blessing"
    icon=attacks/magic-missile.png
    type=arcane
    range=ranged
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "dark blessing"
      [/attack_filter]
      [missile_frame]
        begin=-180
        end=0
        image="projectiles/whitemissile-n.png"
        image_diagonal="projectiles/whitemissile-ne.png"
        halo=halo/holy/white-mage-halo1.png,halo/holy/white-mage-halo2.png,halo/holy/white-mage-halo3.png,halo/holy/white-mage-halo4.png
      [/missile_frame]
      [frame]
        begin=-300
        end=-225
      [/frame]
      [frame]
        begin=-225
        end=-150
      [/frame]
      [frame]
        begin=-150
        end=-75
        halo=halo/holy/halo6.png
      [/frame]
      [if]
        hits=yes
        [frame]
          begin=-75
          end=0
          sound={SOUND_LIST:HOLY}
          halo=halo/holy/halo1.png
        [/frame]
      [/if]
      [else]
        hits=no
        [frame]
          begin=-75
          end=0
          sound={SOUND_LIST:HOLY_MISS}
          halo=halo/holy/halo1.png
        [/frame]
      [/else]
      [frame]
        begin=0
        end=75
        halo=halo/holy/halo3.png
      [/frame]
      [frame]
        begin=75
        end=150
        halo=halo/holy/halo5.png
      [/frame]
      [frame]
        begin=150
        end=200
        halo=halo/holy/halo6.png
      [/frame]
      [frame]
        begin=200
        end=250
      [/frame]
      [frame]
        begin=250
        end=300
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_BLADE_MISSILE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "throwing knives"
    icon=attacks/dagger-thrown-human.png
    type=arcane
    range=ranged
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "throwing knives"
      [/attack_filter]
      [missile_frame]
        begin=-150
        end=0
        image="projectiles/dagger-n.png"
        image_diagonal="projectiles/dagger-ne.png"
      [/missile_frame]
      [frame]
        begin=-225
        end=-150
      [/frame]
      [if]
        hits=yes
        [frame]
          begin=-150
          end=100
          sound=throwing-knife.ogg
        [/frame]
      [/if]
      [else]
        hits=no
        [frame]
          begin=-150
          end=100
          sound=throwing-knife-miss.ogg
        [/frame]
      [/else]
      [frame]
        begin=100
        end=175
        halo=halo/holy/halo3.png
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_COLD_MISSILE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "chill wave"
    icon=attacks/iceball.png
    type=cold
    range=ranged
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "chill wave"
      [/attack_filter]
      [missile_frame]
        begin=-150
        end=50
        image="projectiles/darkmissile-n.png"
        image_diagonal="projectiles/darkmissile-ne.png"
      [/missile_frame]
      [frame]
        begin=-225
        end=-150
        halo=halo/undead/dark-magic-1.png
        halo_x,halo_y=0,-12
      [/frame]
      [frame]
        begin=-150
        end=-75
        halo=halo/undead/dark-magic-2.png
        halo_x,halo_y=0,-12
      [/frame]
      [frame]
        begin=-75
        end=0
        halo=halo/undead/dark-magic-3.png
        halo_x,halo_y=0,-12
      [/frame]
      [frame]
        begin=0
        end=75
        halo=halo/undead/dark-magic-4.png
        halo_x,halo_y=0,-12
      [/frame]
      [frame]
        begin=75
        end=150
        halo=halo/undead/dark-magic-5.png
        halo_x,halo_y=0,-12
      [/frame]
      [if]
        hits=yes
        [frame]
          begin=150
          end=225
          halo=halo/undead/dark-magic-6.png
          halo_x,halo_y=0,-12
          sound=magic-dark.ogg
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=150
          end=225
          halo=halo/undead/dark-magic-6.png
          halo_x,halo_y=0,-12
          sound=magic-dark-miss.ogg
        [/frame]
      [/else]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_FIRE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "flaming dart"
    icon=attacks/torch.png
    type=fire
    range=ranged
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "flaming dart"
      [/attack_filter]
      [missile_frame]
        begin=-150
        end=0
        image="projectiles/missile-fire-n.png"
        image_diagonal="projectiles/missile-fire-ne.png"
      [/missile_frame]
      [if]
        hits=no
        [frame]
          begin=-400
          end=350
          sound={SOUND_LIST:MISS}
        [/frame]
      [/if]
      [else]
        hits=yes
        [frame]
          begin=-400
          end=350
          sound=dart.ogg
        [/frame]
      [/else]
      [frame]
        begin=-350
        end=-300
      [/frame]
      [frame]
        begin=-300
        end=-250
      [/frame]
      [frame]
        begin=-250
        end=-100
      [/frame]
      [frame]
        begin=-100
        end=-50
      [/frame]
      [frame]
        begin=-50
        end=100
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_IMPACT_MISSILE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "thrown stones"
    icon=attacks/rock_thrown.png
    type=impact
    range=ranged
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "thrown stones"
      [/attack_filter]
      [missile_frame]
        begin=-100
        end=100
        image="projectiles/stone.png"
        image_diagonal="projectiles/stone.png"
      [/missile_frame]
      [frame]
        begin=-300
        end=-100
      [/frame]
      [if]
        hits=yes
        [frame]
          begin=-100
          end=100
          sound=tail.ogg
        [/frame]
      [/if]
      [else]
        hits=no
        [frame]
          begin=-100
          end=100
          sound=throw-1.wav
        [/frame]
      [/else]
      [frame]
        begin=100
        end=300
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_PIERCE_MISSILE DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "crossbow"
    icon=attacks/crossbow-undead.png
    type=pierce
    range=ranged
    damage={DAM}
    number={SRK}
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "crossbow"
      [/attack_filter]
      [missile_frame]
        begin=-75
        end=75
        image="projectiles/missile-n.png"
        image_diagonal="projectiles/missile-ne.png"
      [/missile_frame]
      [frame]
        begin=-150
        end=-75
      [/frame]
      [if]
        hits=yes
        [frame]
          begin=-75
          end=75
          sound=crossbow.ogg
        [/frame]
      [/if]
      [else]
        hits=no
        [frame]
          begin=-75
          end=75
          sound=crossbow-miss.ogg
        [/frame]
      [/else]
      [frame]
        begin=75
        end=150
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_ENEMY_WEAPON_FIRE_SLOW DAM SRK
  [effect]
    apply_to=new_attack
    name= _ "fire storm"
    icon=attacks/fire-storm.png
    type=fire
    range=ranged
    damage={DAM}
    number={SRK}
    [specials]
      {WEAPON_SPECIAL_SLOW}
    [/specials]
  [/effect]
  [effect]
    apply_to=new_animation
    [attack_anim]
      [attack_filter]
        name=_ "fire storm"
      [/attack_filter]
      {FIRE_BURST_SMALL}
      [if]
        hits=yes
        [frame]
          begin=-400
          end=350
          sound=flame-big.ogg
        [/frame]
      [/if]
      [else]
        hits=no
        [frame]
          begin=-400
          end=350
          sound=flame-big-miss.ogg
        [/frame]
      [/else]
      [frame]
        begin=-350
        end=-300
      [/frame]
      [frame]
        begin=-300
        end=-250
      [/frame]
      [frame]
        begin=-250
        end=-100
      [/frame]
      [frame]
        begin=-100
        end=-50
      [/frame]
      [frame]
        begin=-50
        end=100
      [/frame]
    [/attack_anim]
  [/effect]
#enddef

#define SX_MEGA_CHALLENGE
  [event]
    name=turn 225
    [sound]
      name=dragonstick.ogg
    [/sound]
    [gold]
      side=6
      amount=9000
    [/gold]
    [gold]
      side=7
      amount=9000
    [/gold]
    [gold]
      side=8
      amount=9000
    [/gold]
    [gold]
      side=9
      amount=9000
    [/gold]
  [/event]
#enddef

#define SX_INCOME_BONUS B6 B7 B8 B9
  [event]
    name=new turn
    first_time_only=no
    {VARIABLE income_bonus 0}
    [if]
      [not]
        [have_unit]
          side=6
          canrecruit=yes
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B6}"}
      [/then]
    [/if]
    [if]
      [not]
        [have_unit]
          side=7
          canrecruit=yes
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B7}"}
      [/then]
    [/if]
    [if]
      [not]
        [have_unit]
          side=8
          canrecruit=yes
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B8}"}
      [/then]
    [/if]
    [if]
      [not]
        [have_unit]
          side=9
          canrecruit=yes
        [/have_unit]
      [/not]
      [then]
        {VARIABLE_OP income_bonus add "{B9}"}
      [/then]
    [/if]
    [if]
      {SX_CMP difficulty greater_than_equal_to 175}
      [then]
        {VARIABLE_OP income_bonus multiply 0.4}
      [/then]
      [else]
        [if]
          {SX_CMP difficulty greater_than_equal_to 150}
          [then]
            {VARIABLE_OP income_bonus multiply 0.6}
          [/then]
          [else]
            [if]
              {SX_CMP difficulty greater_than_equal_to 125}
              [then]
                {VARIABLE_OP income_bonus multiply 0.8}
              [/then]
              [else]
                [if]
                  {SX_CMP difficulty greater_than_equal_to 100}
                  [then]
                    {VARIABLE_OP income_bonus multiply 1.0}
                  [/then]
                  [else]
                    [if]
                      {SX_CMP difficulty greater_than_equal_to 75}
                      [then]
                        {VARIABLE_OP income_bonus multiply 1.2}
                      [/then]
                      [else]
                        [if]
                          {SX_CMP difficulty greater_than_equal_to 50}
                          [then]
                            {VARIABLE_OP income_bonus multiply 1.4}
                          [/then]
                        [/if]
                      [/else]
                    [/if]
                  [/else]
                [/if]
              [/else]
            [/if]
          [/else]
        [/if]
      [/else]
    [/if]
    {VARIABLE i 1}
    [while]
      {SX_CMP i less_than_equal_to 5}
      [do]
        [if]
          [have_unit]
            side=$i
            canrecruit=yes
          [/have_unit]
          {SX_CMP income_bonus greater_than_equal_to 1}
          [then]
            [gold]
              side=$i
              amount=$income_bonus
            [/gold]
            [store_unit]
              [filter]
                side=$i
                canrecruit=yes
              [/filter]
              variable=income_leader
            [/store_unit]
            [unstore_unit]
              variable=income_leader
              text=$income_bonus
              red,green,blue=255,255,0
            [/unstore_unit]
            {VARIABLE_OP income_$i| add $income_bonus}
          [/then]
        [/if]
        {VARIABLE_OP i add 1}
      [/do]
    [/while]
    {CLEAR_VARIABLE i}
    {CLEAR_VARIABLE income_bonus}
    {CLEAR_VARIABLE income_leader}
  [/event]
#enddef

#define SX_ABILITY_EVENTS
  [event]
    name=side turn
    first_time_only=no
    [store_unit]
      [filter]
        side=$side_number
        canrecruit=yes
      [/filter]
      variable=mc
    [/store_unit]
    {VARIABLE a_idx 0}
    [while]
      {SX_CMP a_idx less_than $mc.abilities.length}
      [do]
        {VARIABLE h_idx 0}
        [while]
          {SX_CMP h_idx less_than $mc.abilities[$a_idx|].heals.length}
          [do]
            [if]
              {SX_CMP mc.abilities[$a_idx|].heals[$h_idx|].id equals megacures}
              [then]
                {VARIABLE mc.abilities[$a_idx|].heals[$h_idx|].value $mc.max_hitpoints}
                {VARIABLE_OP mc.abilities[$a_idx|].heals[$h_idx|].value multiply 0.2}
                {CLEAR_VARIABLE mc.status.slowed}
                [unstore_unit]
                  variable=mc
                [/unstore_unit]
              [/then]
            [/if]
            {VARIABLE_OP h_idx add 1}
          [/do]
        [/while]
        {VARIABLE_OP a_idx add 1}
        {CLEAR_VARIABLE h_idx}
      [/do]
    [/while]
    {CLEAR_VARIABLE a_idx}
    {CLEAR_VARIABLE mc}
  [/event]

  [event]
    name=side turn
    first_time_only=no
    [store_unit]
      [filter]
        side=$side_number
        canrecruit=yes
      [/filter]
      variable=mr
    [/store_unit]
    {VARIABLE a_idx 0}
    [while]
      {SX_CMP a_idx less_than $mr.abilities.length}
      [do]
        {VARIABLE r_idx 0}
        [while]
          {SX_CMP r_idx less_than $mr.abilities[$a_idx|].regenerate.length}
          [do]
            [if]
              {SX_CMP mr.abilities[$a_idx|].regenerate[$r_idx|].id equals megaregenerates}
              [then]
                {VARIABLE mr.abilities[$a_idx|].regenerate[$r_idx|].value $mr.max_hitpoints}
                {VARIABLE_OP mr.abilities[$a_idx|].regenerate[$r_idx|].value multiply 0.2}
                {CLEAR_VARIABLE mr.status.slowed}
                {VARIABLE mr_hp $mr.health}
                [unstore_unit]
                  variable=mr
                [/unstore_unit]
              [/then]
            [/if]
            {VARIABLE_OP r_idx add 1}
          [/do]
        [/while]
        {VARIABLE_OP a_idx add 1}
        {CLEAR_VARIABLE r_idx}
      [/do]
    [/while]
    {CLEAR_VARIABLE a_idx}
    {CLEAR_VARIABLE mr}
  [/event]

  [event]
    name=turn refresh
    first_time_only=no
    [store_unit]
      [filter]
        side=$side_number
        canrecruit=yes
      [/filter]
      variable=mr
    [/store_unit]
    [if]
      {SX_CMP mr.hitpoints less_than $mr_hp}
      [then]
        {VARIABLE mr.hitpoints $mr_hp}
        [unstore_unit]
          variable=mr
        [/unstore_unit]
      [/then]
    [/if]
    {CLEAR_VARIABLE mr_hp}
    {CLEAR_VARIABLE mr}
  [/event]

  [event]
    name=die
    first_time_only=no
    [filter_second]
      ability=soulstealer2
    [/filter_second]
    [unstore_unit]
      variable=second_unit
      {COLOR_HEAL}
      text= _ "+1 max. HP"
      find_vacant=no
    [/unstore_unit]
    [object]
      silent=yes
      duration=forever
      [filter]
        x,y=$x2,$y2
      [/filter]
      [effect]
        apply_to=hitpoints
        increase_total=1
        increase=1
        violate_maximum=yes
      [/effect]
    [/object]
  [/event]
#enddef

#define SX_SET_TERRAIN X Y LETTER
  [terrain]
    x="{X}"
    y="{Y}"
    terrain={LETTER}
  [/terrain]
#enddef

#define SX_INVENTORY
  [set_menu_item]
    id=SXC_Inventory
    description="View/manipulate items in inventory"
    image=icons/backpack.png
    [show_if]
      [have_unit]
        side=$side_number
        x,y=$x1,$y1
        canrecruit=yes
      [/have_unit]
    [/show_if]
    [command]
      [message]
        speaker=unit
        message= _ "@Inventory:"
        [option]
          message= _ "Ok"
          [command]
          [/command]
        [/option]
        {SX_DRINK_BLUE_POTION}
        {SX_DRINK_CYAN_POTION}
        {SX_DRINK_RED_POTION}
        {SX_DRINK_YELLOW_POTION}
        {SX_DROP_DEFRING}
        {SX_DROP_RESRING}
        {SX_DROP_BLUE_POTION}
        {SX_DROP_RED_POTION}
        {SX_DROP_YELLOW_POTION}
        [redraw]
        [/redraw]
      [/message]
    [/command]
  [/set_menu_item]
#enddef

